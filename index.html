<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RetroAvia 4.2 - Enterprise Business Manager</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' https:; frame-ancestors 'none';">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="Cache-Control" content="public, max-age=31536000">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --primary-light: #3b82f6;
            --secondary: #059669;
            --secondary-dark: #047857;
            --accent: #dc2626;
            --accent-light: #ef4444;
            --warning: #d97706;
            --warning-light: #f59e0b;
            
            --bg-primary: #0a0a0f;
            --bg-secondary: #111827;
            --bg-tertiary: #1f2937;
            --surface: #374151;
            --surface-elevated: #4b5563;
            --surface-glass: rgba(31, 41, 55, 0.8);
            
            --text-primary: #ffffff;
            --text-secondary: #f3f4f6;
            --text-muted: #9ca3af;
            --text-inverse: #111827;
            
            --success: #10b981;
            --success-light: #34d399;
            --error: #ef4444;
            --error-light: #f87171;
            --info: #3b82f6;
            
            --gradient-primary: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            --gradient-secondary: linear-gradient(135deg, #059669 0%, #047857 100%);
            --gradient-accent: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            --gradient-surface: linear-gradient(135deg, var(--surface) 0%, var(--surface-elevated) 100%);
            --gradient-glass: linear-gradient(135deg, rgba(31, 41, 55, 0.9) 0%, rgba(75, 85, 99, 0.8) 100%);
            
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.15);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.2), 0 2px 4px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.25), 0 4px 6px -2px rgba(0, 0, 0, 0.1);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.3), 0 10px 10px -5px rgba(0, 0, 0, 0.15);
            --shadow-2xl: 0 25px 50px -12px rgba(0, 0, 0, 0.4);
            
            --border-radius: 0.75rem;
            --border-radius-lg: 1rem;
            --border-radius-xl: 1.5rem;
            --border-radius-2xl: 2rem;
            
            --spacing-xs: 0.25rem;
            --spacing-sm: 0.5rem;
            --spacing-md: 0.75rem;
            --spacing-lg: 1rem;
            --spacing-xl: 1.5rem;
            --spacing-2xl: 2rem;
            --spacing-3xl: 3rem;
            --spacing-4xl: 4rem;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: 
                radial-gradient(ellipse at top left, rgba(37, 99, 235, 0.1) 0%, transparent 50%),
                radial-gradient(ellipse at bottom right, rgba(5, 150, 105, 0.08) 0%, transparent 50%),
                radial-gradient(ellipse at center, rgba(220, 38, 38, 0.05) 0%, transparent 70%),
                var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
            overflow-x: hidden;
            font-feature-settings: 'cv02', 'cv03', 'cv04', 'cv11';
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: var(--spacing-xl);
        }
        
        .header {
            text-align: center;
            margin-bottom: var(--spacing-3xl);
            position: relative;
        }
        
        .logo {
            font-family: 'JetBrains Mono', monospace;
            font-size: clamp(2.5rem, 6vw, 4rem);
            font-weight: 700;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: var(--spacing-md);
            letter-spacing: -0.025em;
            position: relative;
        }
        
        .logo::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--gradient-primary);
            opacity: 0.1;
            filter: blur(30px);
            z-index: -1;
        }
        
        .subtitle {
            font-size: 1.25rem;
            color: var(--text-muted);
            font-weight: 500;
            margin-bottom: var(--spacing-lg);
            letter-spacing: 0.025em;
        }
        
        .version-badge {
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-sm);
            background: var(--gradient-primary);
            color: white;
            padding: var(--spacing-sm) var(--spacing-lg);
            border-radius: var(--border-radius-xl);
            font-size: 0.875rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            box-shadow: var(--shadow-lg);
            backdrop-filter: blur(10px);
        }
        
        .connection-status {
            position: absolute;
            top: var(--spacing-lg);
            right: var(--spacing-lg);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-sm) var(--spacing-md);
            background: var(--gradient-glass);
            border-radius: var(--border-radius-lg);
            font-size: 0.875rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .connection-status.connected { border-color: var(--success); }
        .connection-status.disconnected { border-color: var(--error); }
        .connection-status.syncing { border-color: var(--warning); }
        
        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        .status-indicator.connected { background: var(--success); }
        .status-indicator.disconnected { background: var(--error); }
        .status-indicator.syncing { 
            background: var(--warning);
            animation: syncPulse 1s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        @keyframes syncPulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.2); }
        }
        
        .nav {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: var(--spacing-md);
            margin: var(--spacing-3xl) 0;
            padding: var(--spacing-2xl);
            background: var(--gradient-glass);
            border-radius: var(--border-radius-2xl);
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            box-shadow: var(--shadow-2xl);
            position: relative;
            overflow: hidden;
        }
        
        .nav::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
        }
        
        .nav-btn {
            background: var(--gradient-surface);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--text-secondary);
            padding: var(--spacing-md) var(--spacing-lg);
            border-radius: var(--border-radius-lg);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-sm);
            position: relative;
            overflow: hidden;
            white-space: nowrap;
        }
        
        .nav-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transition: left 0.5s ease;
        }
        
        .nav-btn:hover::before { left: 100%; }
        
        .nav-btn:hover, .nav-btn:focus {
            transform: translateY(-2px) scale(1.02);
            border-color: var(--primary);
            color: var(--text-primary);
            outline: none;
            box-shadow: var(--shadow-lg);
        }
        
        .nav-btn.active {
            background: var(--gradient-primary);
            color: white;
            transform: translateY(-2px) scale(1.02);
            box-shadow: var(--shadow-xl);
        }
        
        .page {
            display: none;
            animation: fadeInUp 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .page.active { display: block; }
        
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(30px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        
        .card {
            background: var(--gradient-glass);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--border-radius-2xl);
            padding: var(--spacing-2xl);
            margin: var(--spacing-xl) 0;
            box-shadow: var(--shadow-xl);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(20px);
        }
        
        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
        }
        
        .card:hover {
            transform: translateY(-4px) scale(1.01);
            border-color: rgba(255, 255, 255, 0.2);
            box-shadow: var(--shadow-2xl);
        }
        
        .card h3 {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.5rem;
            margin-bottom: var(--spacing-xl);
            color: var(--primary-light);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: var(--spacing-lg);
            letter-spacing: -0.025em;
        }
        
        .grid {
            display: grid;
            gap: var(--spacing-xl);
        }
        
        .grid-2 { grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); }
        .grid-3 { grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); }
        .grid-4 { grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); }
        
        .stat-box {
            background: var(--gradient-primary);
            border-radius: var(--border-radius-2xl);
            padding: var(--spacing-2xl);
            text-align: center;
            color: white;
            font-weight: 700;
            box-shadow: var(--shadow-xl);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            cursor: pointer;
        }
        
        .stat-box:hover {
            transform: scale(1.05) translateY(-8px);
            box-shadow: var(--shadow-2xl);
        }
        
        .stat-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: clamp(1.5rem, 4vw, 2.5rem);
            font-weight: 700;
            margin-bottom: var(--spacing-sm);
            position: relative;
            z-index: 1;
        }
        
        .stat-label {
            font-size: 0.875rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            opacity: 0.9;
            position: relative;
            z-index: 1;
        }
        
        .btn {
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-sm);
            background: var(--gradient-primary);
            border: none;
            color: white;
            padding: var(--spacing-md) var(--spacing-xl);
            border-radius: var(--border-radius-lg);
            cursor: pointer;
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            margin: var(--spacing-sm);
            text-decoration: none;
            position: relative;
            overflow: hidden;
            box-shadow: var(--shadow-md);
            min-height: 44px;
        }
        
        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s ease;
        }
        
        .btn:hover::before { left: 100%; }
        .btn:hover, .btn:focus {
            transform: translateY(-2px) scale(1.02);
            outline: none;
            box-shadow: var(--shadow-xl);
        }
        .btn:active { transform: translateY(0) scale(0.98); }
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-success { background: var(--gradient-secondary); }
        .btn-warning { background: linear-gradient(135deg, var(--warning), var(--warning-light)); }
        .btn-error { background: var(--gradient-accent); }
        .btn-info { background: linear-gradient(135deg, var(--info), var(--primary)); }
        .btn-secondary { 
            background: var(--gradient-surface); 
            color: var(--text-secondary); 
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        /* Enhanced Business Summary */
        .business-summary {
            background: linear-gradient(135deg, 
                rgba(37, 99, 235, 0.1) 0%, 
                rgba(5, 150, 105, 0.08) 50%,
                rgba(220, 38, 38, 0.05) 100%);
            border: 1px solid rgba(37, 99, 235, 0.3);
            border-radius: var(--border-radius-2xl);
            padding: var(--spacing-2xl);
            margin: var(--spacing-xl) 0;
            backdrop-filter: blur(20px);
        }
        
        .business-summary h4 {
            color: var(--primary-light);
            margin-bottom: var(--spacing-lg);
            font-family: 'JetBrains Mono', monospace;
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            font-size: 1.125rem;
            font-weight: 600;
        }
        
        .business-metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-md) 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .business-metric:last-child { border-bottom: none; }
        
        .metric-label {
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        
        .metric-value {
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.1rem;
        }
        
        .metric-positive { color: var(--success-light); }
        .metric-negative { color: var(--error-light); }
        .metric-neutral { color: var(--text-primary); }
        
        /* AI Panel Enhancement */
        .ai-panel {
            background: linear-gradient(135deg, var(--bg-secondary), var(--bg-tertiary));
            border: 2px solid var(--primary);
            border-radius: var(--border-radius-2xl);
            padding: var(--spacing-2xl);
            margin: var(--spacing-xl) 0;
            position: relative;
            box-shadow: 0 0 50px rgba(37, 99, 235, 0.2);
            overflow: hidden;
            backdrop-filter: blur(20px);
        }
        
        .ai-panel::before {
            content: 'SPIDER-AI NEURAL NETWORK v4.2';
            position: absolute;
            top: -15px;
            left: var(--spacing-xl);
            background: var(--primary);
            color: white;
            padding: var(--spacing-sm) var(--spacing-lg);
            border-radius: var(--border-radius-lg);
            font-family: 'JetBrains Mono', monospace;
            font-weight: 600;
            font-size: 0.75rem;
            letter-spacing: 0.1em;
        }
        
        .ai-suggestions {
            margin: var(--spacing-xl) 0;
            padding: var(--spacing-xl);
            background: rgba(37, 99, 235, 0.1);
            border-radius: var(--border-radius-lg);
            border: 1px solid var(--primary);
            backdrop-filter: blur(10px);
        }
        
        /* Form Enhancements */
        .form-group {
            margin: var(--spacing-xl) 0;
        }
        
        .form-group label {
            display: block;
            margin-bottom: var(--spacing-sm);
            color: var(--primary-light);
            font-weight: 600;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: var(--spacing-lg);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--border-radius-lg);
            background: var(--surface);
            color: var(--text-primary);
            font-family: 'Inter', sans-serif;
            font-size: 1rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: var(--shadow-sm);
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.15), var(--shadow-md);
            transform: scale(1.01);
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: var(--spacing-lg);
        }
        
        .form-grid-full { grid-column: 1 / -1; }
        
        /* Calendar Enhancements */
        .calendar-container {
            background: var(--gradient-glass);
            border-radius: var(--border-radius-2xl);
            padding: var(--spacing-xl);
            box-shadow: var(--shadow-xl);
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
        }
        
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-xl);
            padding-bottom: var(--spacing-lg);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .calendar-month {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--primary-light);
        }
        
        .calendar-nav {
            display: flex;
            gap: var(--spacing-sm);
        }
        
        .calendar-nav-btn {
            width: 44px;
            height: 44px;
            border-radius: var(--border-radius-lg);
            background: var(--gradient-surface);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            font-weight: 600;
        }
        
        .calendar-nav-btn:hover {
            background: var(--gradient-primary);
            transform: scale(1.1);
        }
        
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: var(--border-radius-lg);
            overflow: hidden;
        }
        
        .calendar-day-header {
            background: var(--surface);
            padding: var(--spacing-md);
            text-align: center;
            font-weight: 600;
            font-size: 0.875rem;
            color: var(--primary-light);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .calendar-day {
            background: var(--bg-secondary);
            min-height: 100px;
            padding: var(--spacing-sm);
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            display: flex;
            flex-direction: column;
        }
        
        .calendar-day:hover { background: var(--surface); }
        .calendar-day.other-month { opacity: 0.3; }
        .calendar-day.today {
            background: linear-gradient(135deg, rgba(37, 99, 235, 0.2), rgba(59, 130, 246, 0.2));
            border: 1px solid var(--primary);
        }
        .calendar-day.selected {
            background: var(--gradient-primary);
            color: white;
        }
        
        .calendar-day-number {
            font-weight: 600;
            margin-bottom: var(--spacing-xs);
            font-size: 0.875rem;
            font-family: 'JetBrains Mono', monospace;
        }
        
        .calendar-event {
            background: var(--gradient-primary);
            color: white;
            padding: 2px var(--spacing-xs);
            border-radius: var(--spacing-xs);
            font-size: 0.75rem;
            margin-bottom: 1px;
            cursor: pointer;
            transition: all 0.2s ease;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            font-weight: 500;
        }
        
        .calendar-event.order {
            background: linear-gradient(135deg, var(--warning), var(--warning-light));
        }
        
        .calendar-event.transaction-revenue {
            background: linear-gradient(135deg, var(--success), var(--success-light));
        }
        
        .calendar-event.transaction-expense {
            background: linear-gradient(135deg, var(--error), var(--error-light));
        }
        
        .calendar-event:hover {
            transform: scale(1.02);
            z-index: 10;
        }
        
        /* Enhanced Tables */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin: var(--spacing-xl) 0;
            background: var(--gradient-glass);
            border-radius: var(--border-radius-lg);
            overflow: hidden;
            box-shadow: var(--shadow-lg);
            backdrop-filter: blur(20px);
        }
        
        .data-table th,
        .data-table td {
            padding: var(--spacing-lg);
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .data-table th {
            background: var(--surface);
            color: var(--primary-light);
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.875rem;
            letter-spacing: 0.05em;
            font-family: 'JetBrains Mono', monospace;
        }
        
        .data-table tr {
            transition: all 0.3s ease;
        }
        
        .data-table tr:hover {
            background: rgba(255, 255, 255, 0.05);
            transform: scale(1.01);
        }
        
        /* Enhanced Status Badges */
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-xs);
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--border-radius-lg);
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            box-shadow: var(--shadow-sm);
            transition: all 0.3s ease;
        }
        
        .status-badge:hover {
            transform: scale(1.05);
            box-shadow: var(--shadow-md);
        }
        
        .status-pending {
            background: linear-gradient(135deg, rgba(217, 119, 6, 0.2), rgba(245, 158, 11, 0.2));
            color: var(--warning-light);
            border: 1px solid var(--warning);
        }
        
        .status-in-progress {
            background: linear-gradient(135deg, rgba(37, 99, 235, 0.2), rgba(59, 130, 246, 0.2));
            color: var(--primary-light);
            border: 1px solid var(--primary);
        }
        
        .status-completed {
            background: linear-gradient(135deg, rgba(5, 150, 105, 0.2), rgba(16, 185, 129, 0.2));
            color: var(--success-light);
            border: 1px solid var(--success);
        }
        
        .status-cancelled {
            background: linear-gradient(135deg, rgba(220, 38, 38, 0.2), rgba(239, 68, 68, 0.2));
            color: var(--error-light);
            border: 1px solid var(--error);
        }
        
        /* Enhanced Modals */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(15px);
        }
        
        .modal.active { display: flex; }
        
        .modal-content {
            background: var(--gradient-glass);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: var(--border-radius-2xl);
            padding: var(--spacing-2xl);
            max-width: 800px;
            width: 90%;
            position: relative;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: var(--shadow-2xl);
            animation: modalSlideIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(20px);
        }
        
        @keyframes modalSlideIn {
            from { transform: scale(0.95) translateY(-20px); opacity: 0; }
            to { transform: scale(1) translateY(0); opacity: 1; }
        }
        
        .close {
            position: absolute;
            top: var(--spacing-lg);
            right: var(--spacing-lg);
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--error);
            transition: all 0.3s ease;
            background: none;
            border: none;
            padding: var(--spacing-sm);
            border-radius: var(--border-radius-lg);
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .close:hover, .close:focus {
            color: white;
            background: var(--error);
            transform: rotate(90deg) scale(1.1);
            outline: none;
        }
        
        /* Message Boxes */
        .message-box {
            padding: var(--spacing-xl);
            border-radius: var(--border-radius-lg);
            margin: var(--spacing-xl) 0;
            display: none;
            font-weight: 500;
            border: 1px solid;
            backdrop-filter: blur(10px);
            box-shadow: var(--shadow-lg);
        }
        
        .error-box {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.15), rgba(220, 38, 38, 0.15));
            color: var(--error-light);
            border-color: var(--error);
        }
        
        .success-box {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(5, 150, 105, 0.15));
            color: var(--success-light);
            border-color: var(--success);
        }
        
        .message-box.show {
            display: block;
            animation: slideInRight 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        @keyframes slideInRight {
            from { transform: translateX(100%) scale(0.95); opacity: 0; }
            to { transform: translateX(0) scale(1); opacity: 1; }
        }
        
        /* Search Box */
        .search-box {
            width: 100%;
            max-width: 400px;
            margin: 0 auto var(--spacing-xl);
            padding: var(--spacing-lg);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--border-radius-lg);
            background: var(--surface);
            color: var(--text-primary);
            font-family: 'Inter', sans-serif;
            box-shadow: var(--shadow-md);
            transition: all 0.3s ease;
        }
        
        .search-box:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.15), var(--shadow-lg);
            transform: scale(1.02);
        }
        
        /* Quick Actions */
        .quick-actions {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-md);
            justify-content: center;
            margin: var(--spacing-xl) 0;
        }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: var(--spacing-4xl);
            color: var(--text-muted);
        }
        
        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: var(--spacing-lg);
            opacity: 0.7;
        }
        
        /* Loading State */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Sync Queue */
        .sync-queue {
            position: fixed;
            bottom: var(--spacing-lg);
            right: var(--spacing-lg);
            background: var(--gradient-glass);
            border: 1px solid var(--warning);
            border-radius: var(--border-radius-lg);
            padding: var(--spacing-md);
            color: var(--warning);
            font-size: 0.875rem;
            display: none;
            align-items: center;
            gap: var(--spacing-sm);
            box-shadow: var(--shadow-lg);
            z-index: 999;
            backdrop-filter: blur(20px);
        }
        
        .sync-queue.show { display: flex; }
        
        /* Confirmation Dialog */
        .confirm-dialog {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(15px);
        }
        
        .confirm-dialog.active { display: flex; }
        
        .confirm-content {
            background: var(--gradient-glass);
            border: 2px solid var(--error);
            border-radius: var(--border-radius-2xl);
            padding: var(--spacing-2xl);
            max-width: 500px;
            width: 90%;
            text-align: center;
            box-shadow: var(--shadow-2xl);
            position: relative;
            animation: modalSlideIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(20px);
        }
        
        .confirm-icon {
            font-size: 3rem;
            margin-bottom: var(--spacing-lg);
        }
        
        .confirm-title {
            color: var(--error);
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.5rem;
            margin-bottom: var(--spacing-lg);
            font-weight: 600;
        }
        
        .confirm-message {
            color: var(--text-secondary);
            margin-bottom: var(--spacing-xl);
            line-height: 1.6;
        }
        
        .confirm-actions {
            display: flex;
            gap: var(--spacing-lg);
            justify-content: center;
        }
        
        /* Calendar Day View */
        .calendar-day-view {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(10px);
        }
        
        .calendar-day-view.active { display: flex; }
        
        .calendar-day-content {
            background: var(--gradient-glass);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: var(--border-radius-2xl);
            padding: var(--spacing-2xl);
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
            backdrop-filter: blur(20px);
        }
        
        /* File Input */
        .file-input {
            position: relative;
            display: inline-block;
        }
        
        .file-input input[type="file"] {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        
        .file-input-label {
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-sm);
            background: var(--gradient-surface);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--text-secondary);
            padding: var(--spacing-md) var(--spacing-xl);
            border-radius: var(--border-radius-lg);
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .file-input-label:hover {
            background: var(--gradient-primary);
            color: white;
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .container { padding: var(--spacing-lg); }
            .nav { 
                grid-template-columns: 1fr;
                gap: var(--spacing-sm);
                padding: var(--spacing-lg);
            }
            .nav-btn { 
                width: 100%; 
                justify-content: center;
            }
            .grid-2, .grid-3, .grid-4 { 
                grid-template-columns: 1fr; 
            }
            .card { 
                padding: var(--spacing-xl); 
                margin: var(--spacing-lg) 0;
            }
            .quick-actions {
                flex-direction: column;
                align-items: stretch;
            }
            .quick-actions .btn {
                width: 100%;
                justify-content: center;
                margin: var(--spacing-sm) 0;
            }
            .data-table {
                font-size: 0.875rem;
            }
            .data-table th,
            .data-table td {
                padding: var(--spacing-md);
            }
            .calendar-day {
                min-height: 80px;
                padding: var(--spacing-xs);
            }
            .calendar-event {
                font-size: 0.625rem;
                padding: 1px 2px;
            }
            .connection-status {
                position: relative;
                top: auto;
                right: auto;
                margin: var(--spacing-lg) auto;
                width: fit-content;
            }
            .form-grid {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 480px) {
            .modal-content {
                width: 95%;
                padding: var(--spacing-xl);
            }
            .stat-value {
                font-size: 1.5rem;
            }
            .data-table {
                display: block;
                overflow-x: auto;
                white-space: nowrap;
            }
            .calendar-day {
                min-height: 60px;
            }
            .calendar-day-number {
                font-size: 0.75rem;
            }
            .calendar-event {
                font-size: 0.5rem;
                padding: 1px;
            }
            .confirm-content {
                width: 95%;
                padding: var(--spacing-xl);
            }
            .confirm-actions {
                flex-direction: column;
            }
        }
        
        /* Enhanced Animations */
        @media (prefers-reduced-motion: no-preference) {
            .card, .btn, .nav-btn, .stat-box {
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            }
            .page.active {
                animation: fadeInUp 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            }
        }
        
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="connection-status" id="connectionStatus">
                <div class="status-indicator" id="statusIndicator"></div>
                <span id="statusText">Connessione...</span>
            </div>
            <h1 class="logo">🚀 RetroAvia</h1>
            <p class="subtitle">Enterprise Business Management System</p>
            <div class="version-badge">
                <span>⚡</span>
                Version 4.2 - Enterprise Edition
            </div>
        </header>
        
        <nav class="nav" role="navigation" aria-label="Main navigation">
            <button class="nav-btn active" onclick="showPage('dashboard')" aria-label="Dashboard">
                <span>📊</span> Dashboard
            </button>
            <button class="nav-btn" onclick="showPage('orders')" aria-label="Ordini">
                <span>📋</span> Ordini
            </button>
            <button class="nav-btn" onclick="showPage('transactions')" aria-label="Transazioni">
                <span>💰</span> Transazioni
            </button>
            <button class="nav-btn" onclick="showPage('clients')" aria-label="Clienti">
                <span>👤</span> Clienti
            </button>
            <button class="nav-btn" onclick="showPage('inventory')" aria-label="Inventario">
                <span>📦</span> Inventario
            </button>
            <button class="nav-btn" onclick="showPage('calendar')" aria-label="Calendario">
                <span>📅</span> Calendario
            </button>
            <button class="nav-btn" onclick="showPage('analytics')" aria-label="Analytics">
                <span>📈</span> Analytics
            </button>
        </nav>
        
        <div class="error-box message-box" id="errorBox" role="alert"></div>
        <div class="success-box message-box" id="successBox" role="status"></div>
        
        <!-- Sync Queue Indicator -->
        <div class="sync-queue" id="syncQueue">
            <div class="loading"></div>
            <span id="syncQueueText">Sincronizzazione in corso...</span>
        </div>
        
        <!-- Dashboard Page -->
        <div class="page active" id="dashboard" role="main">
            <div class="business-summary">
                <h4><span>💼</span> Panoramica Business</h4>
                <div class="business-metric">
                    <span class="metric-label">Ordini Attivi:</span>
                    <span class="metric-value metric-neutral" id="activeOrdersCount">0</span>
                </div>
                <div class="business-metric">
                    <span class="metric-label">Clienti Attivi (30gg):</span>
                    <span class="metric-value metric-positive" id="activeClientsCount">0</span>
                </div>
                <div class="business-metric">
                    <span class="metric-label">Margine Profitto:</span>
                    <span class="metric-value" id="profitMargin">0%</span>
                </div>
                <div class="business-metric">
                    <span class="metric-label">Valore Medio Ordine:</span>
                    <span class="metric-value metric-positive" id="avgOrderValue">€0</span>
                </div>
            </div>

            <div class="grid grid-4">
                <div class="stat-box">
                    <div class="stat-value" id="totalRevenue">€0</div>
                    <div class="stat-label">Guadagni Totali</div>
                </div>
                <div class="stat-box" style="background: var(--gradient-secondary);">
                    <div class="stat-value" id="totalExpenses">€0</div>
                    <div class="stat-label">Spese Totali</div>
                </div>
                <div class="stat-box" style="background: var(--gradient-accent);">
                    <div class="stat-value" id="netProfit">€0</div>
                    <div class="stat-label">Profitto Netto</div>
                </div>
                <div class="stat-box" style="background: linear-gradient(135deg, var(--warning), var(--warning-light));">
                    <div class="stat-value" id="totalOrders">0</div>
                    <div class="stat-label">Ordini Totali</div>
                </div>
            </div>
            
            <div class="ai-panel">
                <h3>🧠 Spider-AI Neural Analysis</h3>
                <div class="ai-suggestions" id="aiSuggestions">
                    <p>• Benvenuto in RetroAvia 4.2 Enterprise Edition!</p>
                    <p>• Sistema completamente integrato e sincronizzato</p>
                    <p>• Analisi business professionale attivata</p>
                </div>
                <div class="quick-actions">
                    <button class="btn" onclick="runAIAnalysis()">
                        <span>🧠</span> Analizza Ora
                    </button>
                    <button class="btn btn-secondary" onclick="generatePredictions()">
                        <span>🔮</span> Predizioni AI
                    </button>
                    <button class="btn btn-info" onclick="syncData()">
                        <span>🔄</span> Sincronizza
                    </button>
                </div>
            </div>
            
            <div class="card">
                <h3><span>⚡</span> Azioni Rapide</h3>
                <div class="quick-actions">
                    <button class="btn btn-success" onclick="openQuickSale()">
                        <span>💰</span> Vendita Rapida
                    </button>
                    <button class="btn btn-warning" onclick="openQuickOrder()">
                        <span>📋</span> Nuovo Ordine
                    </button>
                    <button class="btn btn-warning" onclick="openQuickClient()">
                        <span>👤</span> Cliente Rapido
                    </button>
                    <button class="btn" onclick="openQuickInventory()">
                        <span>📦</span> Componente Rapido
                    </button>
                    <button class="btn btn-secondary" onclick="exportBackup()">
                        <span>💾</span> Esporta Backup
                    </button>
                    <button class="btn btn-secondary" onclick="showImportModal()">
                        <span>📂</span> Importa Backup
                    </button>
                </div>
            </div>
        </div>

        <!-- Calendar Page -->
        <div class="page" id="calendar" role="main">
            <div class="card">
                <h3><span>📅</span> Calendario Business</h3>
                <div class="calendar-container">
                    <div class="calendar-header">
                        <div class="calendar-month" id="calendarMonth">Gennaio 2025</div>
                        <div class="calendar-nav">
                            <button class="calendar-nav-btn" onclick="changeMonth(-1)" aria-label="Mese precedente">‹</button>
                            <button class="calendar-nav-btn" onclick="goToToday()" aria-label="Vai a oggi">📅</button>
                            <button class="calendar-nav-btn" onclick="changeMonth(1)" aria-label="Mese successivo">›</button>
                        </div>
                    </div>
                    <div class="calendar-grid" id="calendarGrid">
                        <!-- Calendar will be generated here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Calendar Day View Modal -->
        <div class="calendar-day-view" id="calendarDayView">
            <div class="calendar-day-content">
                <button class="close" onclick="closeCalendarDayView()" aria-label="Chiudi">&times;</button>
                <div id="calendarDayContent">
                    <!-- Day details will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Orders Page -->
        <div class="page" id="orders" role="main">
            <div class="card">
                <h3><span>📋</span> Gestione Ordini</h3>
                <div class="quick-actions">
                    <button class="btn btn-success" onclick="addOrder()">
                        <span>📋</span> Nuovo Ordine
                    </button>
                    <button class="btn btn-info" onclick="showOrdersAnalytics()">
                        <span>📊</span> Analisi Ordini
                    </button>
                </div>
                <input type="text" class="search-box" id="orderSearch" placeholder="🔍 Cerca ordini..." aria-label="Cerca ordini">
                <div id="ordersContainer">
                    <!-- Orders will be loaded here -->
                </div>
            </div>
        </div>
        
        <!-- Transactions Page -->
        <div class="page" id="transactions" role="main">
            <div class="card">
                <h3><span>💰</span> Gestione Transazioni</h3>
                <div class="quick-actions">
                    <button class="btn btn-success" onclick="addTransaction('revenue')">
                        <span>💰</span> Nuova Entrata
                    </button>
                    <button class="btn btn-error" onclick="addTransaction('expense')">
                        <span>💸</span> Nuova Spesa
                    </button>
                    <button class="btn btn-info" onclick="showTransactionAnalytics()">
                        <span>📊</span> Analisi Finanziaria
                    </button>
                </div>
                <input type="text" class="search-box" id="transactionSearch" placeholder="🔍 Cerca transazioni..." aria-label="Cerca transazioni">
                <div id="transactionsContainer">
                    <!-- Transactions will be loaded here -->
                </div>
            </div>
        </div>
        
        <!-- Clients Page -->
        <div class="page" id="clients" role="main">
            <div class="card">
                <h3><span>👤</span> Gestione Clienti</h3>
                <div class="quick-actions">
                    <button class="btn btn-success" onclick="addClient()">
                        <span>👤</span> Nuovo Cliente
                    </button>
                    <button class="btn btn-info" onclick="showClientAnalytics()">
                        <span>📊</span> Analisi Clienti
                    </button>
                </div>
                <input type="text" class="search-box" id="clientSearch" placeholder="🔍 Cerca clienti..." aria-label="Cerca clienti">
                <div id="clientsContainer">
                    <!-- Clients will be loaded here -->
                </div>
            </div>
        </div>
        
        <!-- Inventory Page -->
        <div class="page" id="inventory" role="main">
            <div class="card">
                <h3><span>📦</span> Gestione Inventario</h3>
                <div class="quick-actions">
                    <button class="btn btn-success" onclick="addInventoryItem()">
                        <span>📦</span> Nuovo Componente
                    </button>
                    <button class="btn btn-warning" onclick="checkLowStock()">
                        <span>⚠️</span> Verifica Scorte
                    </button>
                </div>
                <input type="text" class="search-box" id="inventorySearch" placeholder="🔍 Cerca componenti..." aria-label="Cerca componenti">
                <div id="inventoryContainer">
                    <!-- Inventory will be loaded here -->
                </div>
            </div>
        </div>
        
        <!-- Analytics Page -->
        <div class="page" id="analytics" role="main">
            <div class="card">
                <h3><span>📈</span> Analytics Avanzate</h3>
                <div class="grid grid-2">
                    <div class="card">
                        <h4>📊 Trend Mensili (Ultimi 6 Mesi)</h4>
                        <div id="monthlyTrends" class="chart-container">
                            <!-- Monthly trends chart will be here -->
                        </div>
                    </div>
                    <div class="card">
                        <h4>🏆 Top Clienti</h4>
                        <div id="topClients">
                            <!-- Top clients will be here -->
                        </div>
                    </div>
                </div>
                
                <div class="grid grid-2">
                    <div class="card">
                        <h4>📈 Performance Mensile</h4>
                        <div id="monthlyPerformance">
                            <!-- Monthly performance metrics -->
                        </div>
                    </div>
                    <div class="card">
                        <h4>🎯 KPI Dashboard</h4>
                        <div id="kpiDashboard">
                            <!-- Key performance indicators -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Main Modal -->
    <div class="modal" id="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
        <div class="modal-content">
            <button class="close" onclick="closeModal()" aria-label="Chiudi finestra">&times;</button>
            <div id="modalContent"></div>
        </div>
    </div>

    <!-- Confirmation Dialog -->
    <div class="confirm-dialog" id="confirmDialog">
        <div class="confirm-content">
            <div class="confirm-icon">⚠️</div>
            <h3 class="confirm-title" id="confirmTitle">Conferma Eliminazione</h3>
            <p class="confirm-message" id="confirmMessage">Sei sicuro di voler procedere?</p>
            <div class="confirm-actions">
                <button class="btn btn-error" id="confirmYes">
                    <span>🗑️</span> Elimina
                </button>
                <button class="btn btn-secondary" id="confirmNo">
                    <span>❌</span> Annulla
                </button>
            </div>
        </div>
    </div>
    
    <script>
        // ===== SUPABASE CONFIGURATION =====
        const supabaseUrl = 'https://lzcphhnakmmimoglknon.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx6Y3BoaG5ha21taW1vZ2xrbm9uIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc2MDQxMTgsImV4cCI6MjA3MzE4MDExOH0.2hACcRIDxd9GbSq4_eq2_Stpn8yWyLf7YYY1xSzPTMU';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
        
        // ===== SCHEMA MAPPING =====
        const SCHEMA_MAPPING = {
            transactions: {
                id: 'id',
                type: 'type',
                amount: 'amount',
                description: 'description',
                transaction_date: 'transaction_date',
                client: 'client',
                created_at: 'created_at'
            },
            orders: {
                id: 'id',
                client_name: 'client_name',
                client_email: 'client_email',
                status: 'status',
                created_at: 'created_at',
                due_date: 'due_date',
                specs: 'specs'
            },
            clients: {
                id: 'id',
                client_name: 'client_name',
                client_email: 'client_email',
                client_phone: 'client_phone',
                client_source: 'client_source',
                total_spent: 'total_spent',
                created_at: 'created_at'
            },
            inventory: {
                id: 'id',
                item_name: 'item_name',
                quantity: 'quantity',
                threshold: 'threshold',
                price: 'price',
                supplier: 'supplier',
                created_at: 'created_at'
            }
        };
        
        // ===== GLOBAL STATE =====
        let appData = {
            orders: [],
            transactions: [],
            clients: [],
            inventory: [],
            editingId: null,
            currentPage: 'dashboard',
            version: '4.2',
            calendarDate: new Date(),
            connected: false,
            syncQueue: [],
            retryAttempts: 0,
            maxRetryAttempts: 3,
            isOnline: navigator.onLine,
            healthCheck: {
                lastCheck: null,
                status: 'unknown'
            }
        };
        
        // ===== UTILITY FUNCTIONS =====
        function formatCurrency(amount) {
            return new Intl.NumberFormat('it-IT', {
                style: 'currency',
                currency: 'EUR'
            }).format(parseFloat(amount || 0));
        }
        
        function generateId() {
            return 'id_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }
        
        function formatDate(date = new Date()) {
            if (!(date instanceof Date)) {
                date = new Date(date);
            }
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        function formatDateTime(date = new Date()) {
            if (typeof date === 'string') {
                date = new Date(date);
            }
            return date.toISOString();
        }
        
        function formatDateForStorage(dateStr) {
            if (!dateStr) return formatDate();
            
            // Se è già in formato YYYY-MM-DD, ritornalo così com'è
            if (typeof dateStr === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(dateStr)) {
                return dateStr;
            }
            
            // Se contiene 'T', prendi solo la parte della data
            if (typeof dateStr === 'string' && dateStr.includes('T')) {
                return dateStr.split('T')[0];
            }
            
            // Altrimenti crea una nuova data e formattala
            return formatDate(new Date(dateStr));
        }

        function parseStoredDate(dateStr) {
            if (!dateStr) return null;
            
            // Se contiene 'T', prendi solo la parte della data
            if (typeof dateStr === 'string' && dateStr.includes('T')) {
                return dateStr.split('T')[0];
            }
            
            // Se è già in formato YYYY-MM-DD, ritornalo
            if (typeof dateStr === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(dateStr)) {
                return dateStr;
            }
            
            return formatDate(new Date(dateStr));
        }
        
        function showMessage(message, type = 'success') {
            const box = document.getElementById(type === 'error' ? 'errorBox' : 'successBox');
            if (!box) return;
            
            box.textContent = message;
            box.classList.add('show');
            
            setTimeout(() => {
                box.classList.remove('show');
            }, type === 'error' ? 6000 : 4000);
        }

        // ===== CONNECTION STATUS MANAGEMENT =====
        function updateConnectionStatus(status, text) {
            appData.connected = (status === 'connected');
            const statusEl = document.getElementById('connectionStatus');
            const indicatorEl = document.getElementById('statusIndicator');
            const textEl = document.getElementById('statusText');
            
            if (statusEl && indicatorEl && textEl) {
                statusEl.className = `connection-status ${status}`;
                indicatorEl.className = `status-indicator ${status}`;
                textEl.textContent = text || status;
            }
        }

        function showSyncQueue(text) {
            const queueEl = document.getElementById('syncQueue');
            const textEl = document.getElementById('syncQueueText');
            
            if (queueEl && textEl) {
                textEl.textContent = text;
                queueEl.classList.add('show');
            }
        }

        function hideSyncQueue() {
            const queueEl = document.getElementById('syncQueue');
            if (queueEl) {
                queueEl.classList.remove('show');
            }
        }

        // ===== DATA VALIDATION AND CLEANING =====
        function validateAndCleanData(table, data) {
            const schema = SCHEMA_MAPPING[table];
            if (!schema) {
                throw new Error(`Unknown table: ${table}`);
            }
            
            const cleaned = {};
            
            Object.keys(schema).forEach(field => {
                const sourceField = schema[field];
                let value = data[sourceField] || data[field];
                
                if (field === 'transaction_date' && !value) {
                    value = data.date || data.transactionDate;
                }
                if (field === 'client_name' && !value) {
                    value = data.name || data.clientName;
                }
                if (field === 'client_email' && !value) {
                    value = data.email || data.clientEmail;
                }
                if (field === 'client_phone' && !value) {
                    value = data.phone || data.clientPhone;
                }
                if (field === 'client_source' && !value) {
                    value = data.source || data.clientSource;
                }
                if (field === 'total_spent' && !value) {
                    value = data.totalSpent;
                }
                if (field === 'item_name' && !value) {
                    value = data.name;
                }
                if (field === 'due_date' && !value) {
                    value = data.dueDate;
                }
                
                if (value !== undefined && value !== null) {
                    switch (field) {
                        case 'amount':
                        case 'price':
                        case 'total_spent':
                            cleaned[field] = parseFloat(value) || 0;
                            break;
                        case 'quantity':
                        case 'threshold':
                            cleaned[field] = parseInt(value) || 0;
                            break;
                        case 'transaction_date':
                        case 'due_date':
                            cleaned[field] = formatDateForStorage(value);
                            break;
                        case 'created_at':
                            if (!value) {
                                cleaned[field] = formatDateTime();
                            } else {
                                cleaned[field] = value;
                            }
                            break;
                        case 'specs':
                            if (typeof value === 'string') {
                                try {
                                    cleaned[field] = JSON.parse(value);
                                } catch {
                                    cleaned[field] = {};
                                }
                            } else {
                                cleaned[field] = value || {};
                            }
                            break;
                        default:
                            cleaned[field] = value;
                    }
                }
            });
            
            if (!cleaned.id) {
                cleaned.id = generateId();
            }
            if (!cleaned.created_at) {
                cleaned.created_at = formatDateTime();
            }
            
            return cleaned;
        }

        // ===== RETRY MECHANISM =====
        async function retryOperation(operation, maxRetries = 3, delay = 1000, description = 'operation') {
            for (let attempt = 1; attempt <= maxRetries; attempt++) {
                try {
                    const result = await operation();
                    if (attempt > 1) {
                        console.log(`✅ ${description} succeeded on attempt ${attempt}`);
                    }
                    return result;
                } catch (error) {
                    console.warn(`⚠️ ${description} failed on attempt ${attempt}/${maxRetries}:`, error.message);
                    
                    if (attempt === maxRetries) {
                        throw error;
                    }
                    
                    const jitter = Math.random() * 500;
                    const backoffDelay = (delay * Math.pow(2, attempt - 1)) + jitter;
                    await new Promise(resolve => setTimeout(resolve, Math.min(backoffDelay, 10000)));
                }
            }
        }

        // ===== HEALTH CHECK =====
        async function performHealthCheck() {
            try {
                updateConnectionStatus('syncing', 'Verifica salute...');
                console.log('🔍 Performing health check...');
                
                const healthCheckOp = async () => {
                    const { data, error, count } = await supabase
                        .from('transactions')
                        .select('id', { count: 'exact', head: true })
                        .limit(1);
                    
                    if (error) {
                        throw error;
                    }
                    
                    return { data, count };
                };
                
                const result = await retryOperation(healthCheckOp, 2, 1000, 'health check');
                
                appData.healthCheck = {
                    lastCheck: new Date(),
                    status: 'healthy',
                    transactionCount: result.count
                };
                
                console.log(`✅ Health check passed - ${result.count} transactions in database`);
                return true;
                
            } catch (error) {
                console.error('❌ Health check failed:', error);
                appData.healthCheck = {
                    lastCheck: new Date(),
                    status: 'unhealthy',
                    error: error.message
                };
                return false;
            }
        }

        // ===== SUPABASE FUNCTIONS =====
        async function initializeSupabase() {
            try {
                updateConnectionStatus('syncing', 'Inizializzazione...');
                console.log('🔌 Initializing Supabase connection...');
                
                const isHealthy = await performHealthCheck();
                
                if (isHealthy) {
                    updateConnectionStatus('connected', 'Connesso');
                    console.log('✅ Supabase initialized successfully');
                    
                    await processSyncQueue();
                    
                    return true;
                } else {
                    throw new Error('Health check failed');
                }
                
            } catch (error) {
                console.error('❌ Supabase initialization failed:', error);
                updateConnectionStatus('disconnected', 'Offline');
                showMessage('Modalità offline - Dati salvati localmente', 'error');
                return false;
            }
        }

        async function saveToSupabase(table, data) {
            if (!appData.connected || !appData.isOnline) {
                appData.syncQueue.push({ action: 'upsert', table, data });
                console.log(`📝 Added to sync queue: ${table}`, data.id);
                throw new Error('Offline - added to queue');
            }

            const cleanData = validateAndCleanData(table, data);
            
            const saveOperation = async () => {
                console.log(`💾 Saving to ${table}:`, cleanData.id);

                const { data: result, error } = await supabase
                    .from(table)
                    .upsert(cleanData, { 
                        onConflict: 'id',
                        ignoreDuplicates: false 
                    })
                    .select();

                if (error) {
                    console.error(`❌ Supabase error for ${table}:`, error);
                    throw error;
                }
                
                console.log(`✅ Saved to ${table}:`, result?.[0]?.id);
                return result;
            };

            try {
                return await retryOperation(saveOperation, 3, 1000, `save to ${table}`);
            } catch (error) {
                appData.syncQueue.push({ action: 'upsert', table, data: cleanData });
                updateSyncQueueStatus();
                throw error;
            }
        }

        async function loadFromSupabase(table) {
            if (!appData.connected || !appData.isOnline) {
                console.log(`📥 Loading from ${table} not possible - offline`);
                return [];
            }

            const loadOperation = async () => {
                console.log(`📥 Loading from ${table}...`);

                const { data, error } = await supabase
                    .from(table)
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) {
                    console.error(`❌ Load error for ${table}:`, error);
                    throw error;
                }
                
                console.log(`✅ Loaded ${data?.length || 0} records from ${table}`);
                return data || [];
            };

            try {
                return await retryOperation(loadOperation, 3, 1000, `load from ${table}`);
            } catch (error) {
                console.error(`💥 Load failed for ${table}:`, error);
                return [];
            }
        }

        async function deleteFromSupabase(table, id) {
            if (!appData.connected || !appData.isOnline) {
                appData.syncQueue.push({ action: 'delete', table, id });
                console.log(`🗑️ Added to delete queue: ${table} ID:`, id);
                throw new Error('Offline - added to queue');
            }

            const deleteOperation = async () => {
                console.log(`🗑️ Deleting from ${table} ID:`, id);

                const { error } = await supabase
                    .from(table)
                    .delete()
                    .eq('id', id);

                if (error) {
                    console.error(`❌ Delete error for ${table}:`, error);
                    throw error;
                }
                
                console.log(`✅ Deleted from ${table} ID:`, id);
                return true;
            };

            try {
                return await retryOperation(deleteOperation, 3, 1000, `delete from ${table}`);
            } catch (error) {
                appData.syncQueue.push({ action: 'delete', table, id });
                updateSyncQueueStatus();
                throw error;
            }
        }

        // ===== SYNC QUEUE MANAGEMENT =====
        async function processSyncQueue() {
            if (!appData.connected || !appData.isOnline || appData.syncQueue.length === 0) {
                hideSyncQueue();
                return;
            }

            console.log(`🔄 Processing ${appData.syncQueue.length} queued operations...`);
            showSyncQueue(`Sincronizzando ${appData.syncQueue.length} operazioni...`);

            const queue = [...appData.syncQueue];
            appData.syncQueue = [];

            let successCount = 0;
            let errorCount = 0;

            for (const operation of queue) {
                try {
                    if (operation.action === 'upsert') {
                        await saveToSupabase(operation.table, operation.data);
                    } else if (operation.action === 'delete') {
                        await deleteFromSupabase(operation.table, operation.id);
                    }
                    successCount++;
                } catch (error) {
                    console.error('Sync queue error:', error);
                    appData.syncQueue.push(operation);
                    errorCount++;
                }
            }

            console.log(`✅ Sync queue processed: ${successCount} successes, ${errorCount} errors`);
            
            if (successCount > 0) {
                showMessage(`✅ ${successCount} operazioni sincronizzate!`);
            }
            
            if (errorCount > 0) {
                showMessage(`⚠️ ${errorCount} operazioni rimaste in coda`, 'error');
                updateSyncQueueStatus();
            } else {
                hideSyncQueue();
            }
        }

        function updateSyncQueueStatus() {
            if (appData.syncQueue.length > 0) {
                showSyncQueue(`${appData.syncQueue.length} operazioni in attesa di sync`);
            } else {
                hideSyncQueue();
            }
        }

        async function syncData() {
            try {
                updateConnectionStatus('syncing', 'Sincronizzazione...');

                if (!appData.connected) {
                    const connected = await initializeSupabase();
                    if (!connected) {
                        throw new Error('Connessione non disponibile');
                    }
                }

                showMessage('🔄 Sincronizzazione in corso...');

                await processSyncQueue();

                const results = await Promise.allSettled([
                    loadFromSupabase('orders'),
                    loadFromSupabase('transactions'),
                    loadFromSupabase('clients'),
                    loadFromSupabase('inventory')
                ]);

                const newOrders = results[0].status === 'fulfilled' ? results[0].value : appData.orders;
                const newTransactions = results[1].status === 'fulfilled' ? results[1].value : appData.transactions;
                const newClients = results[2].status === 'fulfilled' ? results[2].value : appData.clients;
                const newInventory = results[3].status === 'fulfilled' ? results[3].value : appData.inventory;

                if (Array.isArray(newOrders)) appData.orders = newOrders;
                if (Array.isArray(newTransactions)) appData.transactions = newTransactions;
                if (Array.isArray(newClients)) appData.clients = newClients;
                if (Array.isArray(newInventory)) appData.inventory = newInventory;

                const failures = results.filter(r => r.status === 'rejected');
                if (failures.length > 0) {
                    console.warn('⚠️ Some sync operations failed:', failures);
                    showMessage(`Sincronizzazione parziale (${failures.length} errori)`, 'error');
                } else {
                    showMessage('✅ Sincronizzazione completata!');
                }

                saveDataToLocalStorage();
                updateClientTotalSpent();
                updateBusinessIntegration();

                showPage(appData.currentPage);
                updateDashboard();

                updateConnectionStatus('connected', 'Connesso');

                console.log('📊 Data synced:', {
                    orders: appData.orders.length,
                    transactions: appData.transactions.length,
                    clients: appData.clients.length,
                    inventory: appData.inventory.length,
                    queueRemaining: appData.syncQueue.length
                });

            } catch (error) {
                console.error('💥 Sync error:', error);
                updateConnectionStatus('disconnected', 'Errore sync');
                showMessage('Errore nella sincronizzazione', 'error');
            }
        }

        // ===== NETWORK MONITORING =====
        function initializeNetworkMonitoring() {
            window.addEventListener('online', async () => {
                appData.isOnline = true;
                console.log('🌐 Internet connection restored');
                
                await initializeSupabase();
                
                if (appData.syncQueue.length > 0) {
                    setTimeout(processSyncQueue, 1000);
                }
            });

            window.addEventListener('offline', () => {
                appData.isOnline = false;
                console.log('🌐 Internet connection lost');
                updateConnectionStatus('disconnected', 'Offline');
                showMessage('Modalità offline attivata', 'error');
            });
        }

        // ===== ENHANCED SAVE FUNCTIONS =====
        async function enhancedSave(table, data, localArray, successMessage) {
            try {
                const index = appData.editingId ? 
                    localArray.findIndex(item => item.id === appData.editingId) : -1;
                
                if (appData.editingId && index !== -1) {
                    localArray[index] = data;
                } else {
                    localArray.push(data);
                }
                
                saveDataToLocalStorage();
                updateBusinessIntegration();
                
                try {
                    await saveToSupabase(table, data);
                    showMessage(`✅ ${successMessage} e sincronizzato su cloud!`);
                } catch (error) {
                    console.warn('⚠️ Supabase save failed, saved locally:', error.message);
                    if (appData.connected) {
                        showMessage(`✅ ${successMessage} localmente (sync in corso...)`, 'error');
                    } else {
                        showMessage(`✅ ${successMessage} offline (sync automatico quando online)`, 'error');
                    }
                }
                
                return true;
            } catch (error) {
                console.error('Enhanced save error:', error);
                showMessage(`Errore nel salvataggio: ${error.message}`, 'error');
                return false;
            }
        }

        async function enhancedDelete(table, id, localArray, itemName) {
            try {
                const initialLength = localArray.length;
                const newArray = localArray.filter(item => item.id !== id);
                
                localArray.length = 0;
                localArray.push(...newArray);
                
                saveDataToLocalStorage();
                updateBusinessIntegration();
                
                try {
                    await deleteFromSupabase(table, id);
                    showMessage(`✅ ${itemName} eliminato e sincronizzato!`);
                } catch (error) {
                    console.warn('⚠️ Supabase delete failed, deleted locally:', error.message);
                    if (appData.connected) {
                        showMessage(`✅ ${itemName} eliminato localmente (sync in corso...)`, 'error');
                    } else {
                        showMessage(`✅ ${itemName} eliminato offline (sync automatico quando online)`, 'error');
                    }
                }
                
                return newArray.length < initialLength;
            } catch (error) {
                console.error('Enhanced delete error:', error);
                showMessage(`Errore nell'eliminazione: ${error.message}`, 'error');
                return false;
            }
        }

        // ===== LOCAL STORAGE FUNCTIONS =====
        function saveDataToLocalStorage() {
            try {
                const dataToSave = {
                    orders: appData.orders,
                    transactions: appData.transactions,
                    clients: appData.clients,
                    inventory: appData.inventory,
                    version: appData.version,
                    lastSaved: new Date().toISOString()
                };
                
                localStorage.setItem('retroavia_data', JSON.stringify(dataToSave));
                console.log('💾 Data saved to localStorage');
            } catch (error) {
                console.error('❌ LocalStorage save failed:', error);
                showMessage('Errore nel salvataggio locale', 'error');
            }
        }

        function loadDataFromLocalStorage() {
            try {
                const saved = localStorage.getItem('retroavia_data');
                if (saved) {
                    const data = JSON.parse(saved);
                    
                    appData.orders = Array.isArray(data.orders) ? data.orders : [];
                    appData.transactions = Array.isArray(data.transactions) ? data.transactions : [];
                    appData.clients = Array.isArray(data.clients) ? data.clients : [];
                    appData.inventory = Array.isArray(data.inventory) ? data.inventory : [];
                    
                    console.log('📥 Data loaded from localStorage:', {
                        orders: appData.orders.length,
                        transactions: appData.transactions.length,
                        clients: appData.clients.length,
                        inventory: appData.inventory.length,
                        lastSaved: data.lastSaved
                    });
                    
                    return true;
                }
                return false;
            } catch (error) {
                console.error('❌ LocalStorage load failed:', error);
                showMessage('Errore nel caricamento dati locali', 'error');
                return false;
            }
        }

        // ===== IMPORT/EXPORT FUNCTIONS =====
        function exportBackup() {
            try {
                const backup = {
                    version: appData.version,
                    timestamp: new Date().toISOString(),
                    data: {
                        orders: appData.orders,
                        transactions: appData.transactions,
                        clients: appData.clients,
                        inventory: appData.inventory
                    },
                    meta: {
                        totalTransactions: appData.transactions.length,
                        totalClients: appData.clients.length,
                        totalInventoryItems: appData.inventory.length,
                        totalOrders: appData.orders.length,
                        exportedBy: 'RetroAvia Enterprise System v4.2',
                        syncQueueLength: appData.syncQueue.length,
                        healthStatus: appData.healthCheck.status
                    }
                };
                
                const dataStr = JSON.stringify(backup, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `retroavia_backup_${formatDate().replace(/-/g, '')}_${Date.now()}.json`;
                link.click();
                
                setTimeout(() => URL.revokeObjectURL(link.href), 100);
                
                showMessage('📦 Backup esportato con successo!');
                console.log('Backup exported successfully');
            } catch (error) {
                console.error('Export error:', error);
                showMessage('Errore nell\'esportazione backup', 'error');
            }
        }

        function showImportModal() {
            const content = `
                <h3 id="modalTitle" style="color: var(--primary-light); margin-bottom: var(--spacing-xl);">📂 Importa Backup</h3>
                
                <div style="margin: var(--spacing-xl) 0; padding: var(--spacing-lg); background: rgba(245, 158, 11, 0.1); border-radius: var(--border-radius-lg); border: 1px solid var(--warning);">
                    <h4 style="color: var(--warning); margin-bottom: var(--spacing-sm);">⚠️ Attenzione</h4>
                    <p style="margin-bottom: var(--spacing-sm);">L'importazione sostituirà tutti i dati correnti. Assicurati di aver fatto un backup prima di procedere.</p>
                    <p style="font-size: 0.875rem; color: var(--text-muted);">Sono supportati solo file JSON esportati da RetroAvia v4.2 Enterprise.</p>
                </div>

                <div class="form-group">
                    <label for="backupFile">Seleziona File Backup (.json)</label>
                    <div class="file-input">
                        <input type="file" id="backupFile" accept=".json" required>
                        <label for="backupFile" class="file-input-label">
                            <span>📂</span> Scegli File
                        </label>
                    </div>
                </div>

                <div id="filePreview" style="display: none; margin: var(--spacing-lg) 0; padding: var(--spacing-lg); background: var(--surface); border-radius: var(--border-radius-lg);">
                    <!-- File preview will be shown here -->
                </div>

                <div class="quick-actions">
                    <button type="button" class="btn btn-warning" onclick="processImportFile()" id="importBtn" disabled>
                        <span>📂</span> Importa Dati
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">
                        <span>❌</span> Annulla
                    </button>
                </div>
            `;
            
            openModal(content);

            setTimeout(() => {
                const fileInput = document.getElementById('backupFile');
                if (fileInput) {
                    fileInput.addEventListener('change', previewImportFile);
                }
            }, 100);
        }

        function previewImportFile(event) {
            const file = event.target.files[0];
            const previewDiv = document.getElementById('filePreview');
            const importBtn = document.getElementById('importBtn');

            if (!file) {
                previewDiv.style.display = 'none';
                importBtn.disabled = true;
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const backup = JSON.parse(e.target.result);
                    
                    if (!backup.data || !backup.version) {
                        throw new Error('File backup non valido');
                    }

                    const data = backup.data;
                    const meta = backup.meta || {};

                    previewDiv.innerHTML = `
                        <h4 style="color: var(--success-light); margin-bottom: var(--spacing-lg);">✅ File Valido</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: var(--spacing-sm); font-size: 0.875rem;">
                            <div><strong>Versione:</strong> ${backup.version}</div>
                            <div><strong>Data:</strong> ${new Date(backup.timestamp).toLocaleDateString('it-IT')}</div>
                            <div><strong>Ordini:</strong> ${(data.orders || []).length}</div>
                            <div><strong>Transazioni:</strong> ${(data.transactions || []).length}</div>
                            <div><strong>Clienti:</strong> ${(data.clients || []).length}</div>
                            <div><strong>Inventario:</strong> ${(data.inventory || []).length}</div>
                        </div>
                    `;
                    previewDiv.style.display = 'block';
                    importBtn.disabled = false;
                    
                    window.backupToImport = backup;

                } catch (error) {
                    previewDiv.innerHTML = `
                        <h4 style="color: var(--error-light); margin-bottom: var(--spacing-sm);">❌ File Non Valido</h4>
                        <p style="color: var(--text-muted);">Errore: ${error.message}</p>
                        <p style="font-size: 0.875rem; color: var(--text-muted);">Assicurati che il file sia un backup JSON valido esportato da RetroAvia.</p>
                    `;
                    previewDiv.style.display = 'block';
                    importBtn.disabled = true;
                    window.backupToImport = null;
                }
            };
            reader.readAsText(file);
        }

        function processImportFile() {
            if (!window.backupToImport) {
                showMessage('Nessun file valido selezionato', 'error');
                return;
            }

            try {
                const backup = window.backupToImport;
                const data = backup.data;

                // Import new data
                appData.orders = Array.isArray(data.orders) ? data.orders : [];
                appData.transactions = Array.isArray(data.transactions) ? data.transactions : [];
                appData.clients = Array.isArray(data.clients) ? data.clients : [];
                appData.inventory = Array.isArray(data.inventory) ? data.inventory : [];

                // Save to localStorage
                saveDataToLocalStorage();
                
                // Update business integration
                updateClientTotalSpent();
                updateBusinessIntegration();

                // Refresh current page
                showPage(appData.currentPage);
                updateDashboard();

                // Clear sync queue and try to sync new data
                appData.syncQueue = [];
                if (appData.connected) {
                    setTimeout(() => {
                        syncData();
                    }, 1000);
                }

                closeModal();
                showMessage(`✅ Backup importato con successo! ${data.orders?.length || 0} ordini, ${data.transactions?.length || 0} transazioni, ${data.clients?.length || 0} clienti, ${data.inventory?.length || 0} componenti.`);

                console.log('Backup imported successfully:', {
                    orders: appData.orders.length,
                    transactions: appData.transactions.length,
                    clients: appData.clients.length,
                    inventory: appData.inventory.length
                });

            } catch (error) {
                console.error('Import error:', error);
                showMessage('Errore nell\'importazione backup', 'error');
            }
        }

        // ===== PAGE NAVIGATION =====
        function showPage(pageId) {
            // Update current page
            appData.currentPage = pageId;

            // Hide all pages
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });

            // Show target page
            const targetPage = document.getElementById(pageId);
            if (targetPage) {
                targetPage.classList.add('active');
            }

            // Update navigation buttons
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            const activeBtn = document.querySelector(`[onclick="showPage('${pageId}')"]`);
            if (activeBtn) {
                activeBtn.classList.add('active');
            }

            // Load page-specific content
            switch(pageId) {
                case 'dashboard':
                    updateDashboard();
                    break;
                case 'orders':
                    loadOrdersPage();
                    break;
                case 'transactions':
                    loadTransactionsPage();
                    break;
                case 'clients':
                    loadClientsPage();
                    break;
                case 'inventory':
                    loadInventoryPage();
                    break;
                case 'calendar':
                    loadCalendarPage();
                    break;
                case 'analytics':
                    loadAnalyticsPage();
                    break;
            }
        }

        // ===== MODAL FUNCTIONS =====
        function openModal(content) {
            const modal = document.getElementById('modal');
            const modalContent = document.getElementById('modalContent');
            
            if (modal && modalContent) {
                modalContent.innerHTML = content;
                modal.classList.add('active');
                
                // Focus management for accessibility
                setTimeout(() => {
                    const firstInput = modal.querySelector('input, select, textarea, button');
                    if (firstInput) firstInput.focus();
                }, 100);
            }
        }

        function closeModal() {
            const modal = document.getElementById('modal');
            if (modal) {
                modal.classList.remove('active');
                appData.editingId = null;
                window.backupToImport = null;
            }
        }

        // ===== CONFIRMATION DIALOG =====
        function showConfirmDialog(title, message, onConfirm) {
            const dialog = document.getElementById('confirmDialog');
            const titleEl = document.getElementById('confirmTitle');
            const messageEl = document.getElementById('confirmMessage');
            const yesBtn = document.getElementById('confirmYes');
            const noBtn = document.getElementById('confirmNo');

            if (dialog && titleEl && messageEl && yesBtn && noBtn) {
                titleEl.textContent = title;
                messageEl.textContent = message;
                
                // Remove existing listeners
                const newYesBtn = yesBtn.cloneNode(true);
                const newNoBtn = noBtn.cloneNode(true);
                yesBtn.parentNode.replaceChild(newYesBtn, yesBtn);
                noBtn.parentNode.replaceChild(newNoBtn, noBtn);

                // Add new listeners
                newYesBtn.addEventListener('click', () => {
                    dialog.classList.remove('active');
                    if (typeof onConfirm === 'function') {
                        onConfirm();
                    }
                });

                newNoBtn.addEventListener('click', () => {
                    dialog.classList.remove('active');
                });

                dialog.classList.add('active');
            }
        }

        // ===== DASHBOARD FUNCTIONS =====
        function updateDashboard() {
            updateStats();
            updateBusinessMetrics();
        }

        function updateStats() {
            const totalRevenue = appData.transactions
                .filter(t => t.type === 'revenue')
                .reduce((sum, t) => sum + (parseFloat(t.amount) || 0), 0);

            const totalExpenses = appData.transactions
                .filter(t => t.type === 'expense')
                .reduce((sum, t) => sum + (parseFloat(t.amount) || 0), 0);

            const netProfit = totalRevenue - totalExpenses;
            const totalOrders = appData.orders.length;

            // Update DOM elements
            const elements = {
                totalRevenue: document.getElementById('totalRevenue'),
                totalExpenses: document.getElementById('totalExpenses'),
                netProfit: document.getElementById('netProfit'),
                totalOrders: document.getElementById('totalOrders')
            };

            if (elements.totalRevenue) elements.totalRevenue.textContent = formatCurrency(totalRevenue);
            if (elements.totalExpenses) elements.totalExpenses.textContent = formatCurrency(totalExpenses);
            if (elements.netProfit) elements.netProfit.textContent = formatCurrency(netProfit);
            if (elements.totalOrders) elements.totalOrders.textContent = totalOrders;
        }

        function updateBusinessMetrics() {
            const activeOrders = appData.orders.filter(o => o.status !== 'completed' && o.status !== 'cancelled').length;
            
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            
            const activeClients = new Set(
                appData.transactions
                    .filter(t => new Date(t.transaction_date || t.created_at) >= thirtyDaysAgo)
                    .map(t => t.client)
                    .filter(client => client)
            ).size;

            const totalRevenue = appData.transactions
                .filter(t => t.type === 'revenue')
                .reduce((sum, t) => sum + (parseFloat(t.amount) || 0), 0);

            const totalExpenses = appData.transactions
                .filter(t => t.type === 'expense')
                .reduce((sum, t) => sum + (parseFloat(t.amount) || 0), 0);

            const profitMargin = totalRevenue > 0 ? ((totalRevenue - totalExpenses) / totalRevenue * 100) : 0;

            const revenueTransactions = appData.transactions.filter(t => t.type === 'revenue');
            const avgOrderValue = revenueTransactions.length > 0 ? 
                totalRevenue / revenueTransactions.length : 0;

            // Update DOM elements
            const elements = {
                activeOrdersCount: document.getElementById('activeOrdersCount'),
                activeClientsCount: document.getElementById('activeClientsCount'),
                profitMargin: document.getElementById('profitMargin'),
                avgOrderValue: document.getElementById('avgOrderValue')
            };

            if (elements.activeOrdersCount) elements.activeOrdersCount.textContent = activeOrders;
            if (elements.activeClientsCount) elements.activeClientsCount.textContent = activeClients;
            if (elements.profitMargin) {
                elements.profitMargin.textContent = `${profitMargin.toFixed(1)}%`;
                elements.profitMargin.className = `metric-value ${profitMargin >= 0 ? 'metric-positive' : 'metric-negative'}`;
            }
            if (elements.avgOrderValue) elements.avgOrderValue.textContent = formatCurrency(avgOrderValue);
        }

        function updateBusinessIntegration() {
            updateClientTotalSpent();
            updateStats();
            updateBusinessMetrics();
        }

        function updateClientTotalSpent() {
            appData.clients.forEach(client => {
                const totalSpent = appData.transactions
                    .filter(t => t.type === 'revenue' && t.client === client.client_name)
                    .reduce((sum, t) => sum + (parseFloat(t.amount) || 0), 0);
                client.total_spent = totalSpent;
            });
        }

        // ===== AI FUNCTIONS =====
        function runAIAnalysis() {
            const suggestions = document.getElementById('aiSuggestions');
            if (!suggestions) return;

            // Show loading state
            suggestions.innerHTML = `
                <div style="text-align: center; padding: var(--spacing-lg);">
                    <div class="loading" style="margin: 0 auto var(--spacing-sm);"></div>
                    <p>Spider-AI sta analizzando i tuoi dati...</p>
                </div>
            `;

            // Simulate AI analysis
            setTimeout(() => {
                const analysis = generateAIAnalysis();
                suggestions.innerHTML = analysis;
            }, 2000);
        }

        function generateAIAnalysis() {
            const totalOrders = appData.orders.length;
            const totalRevenue = appData.transactions
                .filter(t => t.type === 'revenue')
                .reduce((sum, t) => sum + (parseFloat(t.amount) || 0), 0);
            
            const totalExpenses = appData.transactions
                .filter(t => t.type === 'expense')
                .reduce((sum, t) => sum + (parseFloat(t.amount) || 0), 0);

            const profitMargin = totalRevenue > 0 ? ((totalRevenue - totalExpenses) / totalRevenue * 100) : 0;

            const pendingOrders = appData.orders.filter(o => o.status === 'pending').length;
            const lowStockItems = appData.inventory.filter(item => 
                item.quantity <= (item.threshold || 5)
            ).length;

            let suggestions = [];

            // Revenue analysis
            if (totalRevenue > 1000) {
                suggestions.push(`• Eccellente! Hai generato ${formatCurrency(totalRevenue)} di entrate totali`);
            } else if (totalRevenue > 0) {
                suggestions.push(`• Buon inizio con ${formatCurrency(totalRevenue)} di entrate. Continua così!`);
            } else {
                suggestions.push(`• Inizia a registrare le tue prime vendite per vedere le analisi`);
            }

            // Profit margin analysis
            if (profitMargin > 30) {
                suggestions.push(`• Eccellente margine di profitto del ${profitMargin.toFixed(1)}%!`);
            } else if (profitMargin > 10) {
                suggestions.push(`• Margine di profitto buono (${profitMargin.toFixed(1)}%). Cerca di ottimizzare i costi`);
            } else if (profitMargin > 0) {
                suggestions.push(`• Margine di profitto basso (${profitMargin.toFixed(1)}%). Riduci le spese o aumenta i prezzi`);
            } else {
                suggestions.push(`• Attenzione: stai operando in perdita. Rivedi la strategia di pricing`);
            }

            // Orders analysis
            if (pendingOrders > 0) {
                suggestions.push(`• Hai ${pendingOrders} ordini in sospeso. Prioritizza il completamento`);
            }

            if (totalOrders > 10) {
                suggestions.push(`• Ottimo! Hai gestito ${totalOrders} ordini totali`);
            }

            // Inventory analysis
            if (lowStockItems > 0) {
                suggestions.push(`• ⚠️ ${lowStockItems} componenti hanno scorte basse. Considera il riordino`);
            }

            // Client analysis
            const topClients = appData.clients
                .sort((a, b) => (b.total_spent || 0) - (a.total_spent || 0))
                .slice(0, 3);

            if (topClients.length > 0 && topClients[0].total_spent > 0) {
                suggestions.push(`• Il tuo miglior cliente è ${topClients[0].client_name} con ${formatCurrency(topClients[0].total_spent)}`);
            }

            // Growth suggestions
            if (totalOrders > 5) {
                suggestions.push(`• Considera di implementare un sistema di fidelizzazione clienti`);
            }

            if (appData.clients.length > 3) {
                suggestions.push(`• Potresti inviare newsletter periodiche ai tuoi ${appData.clients.length} clienti`);
            }

            return suggestions.map(s => `<p>${s}</p>`).join('');
        }

        function generatePredictions() {
            const suggestions = document.getElementById('aiSuggestions');
            if (!suggestions) return;

            suggestions.innerHTML = `
                <div style="text-align: center; padding: var(--spacing-lg);">
                    <div class="loading" style="margin: 0 auto var(--spacing-sm);"></div>
                    <p>Spider-AI sta generando predizioni...</p>
                </div>
            `;

            setTimeout(() => {
                const predictions = generateAIPredictions();
                suggestions.innerHTML = predictions;
            }, 2500);
        }

        function generateAIPredictions() {
            const recentTransactions = appData.transactions
                .filter(t => {
                    const transactionDate = new Date(t.transaction_date || t.created_at);
                    const thirtyDaysAgo = new Date();
                    thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                    return transactionDate >= thirtyDaysAgo;
                });

            const monthlyRevenue = recentTransactions
                .filter(t => t.type === 'revenue')
                .reduce((sum, t) => sum + (parseFloat(t.amount) || 0), 0);

            const predictions = [];

            // Revenue prediction
            if (monthlyRevenue > 0) {
                const projectedMonthly = monthlyRevenue * 1.15; // 15% growth prediction
                predictions.push(`🔮 Proiezione entrate prossimo mese: ${formatCurrency(projectedMonthly)}`);
                predictions.push(`📈 Crescita stimata: +15% basata sui trend attuali`);
            }

            // Order prediction
            const recentOrders = appData.orders.filter(o => {
                const orderDate = new Date(o.created_at);
                const thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                return orderDate >= thirtyDaysAgo;
            }).length;

            if (recentOrders > 0) {
                const projectedOrders = Math.ceil(recentOrders * 1.1);
                predictions.push(`📋 Ordini previsti prossimo mese: ${projectedOrders}`);
            }

            // Seasonal predictions
            const currentMonth = new Date().getMonth();
            const seasonalTips = [
                "Gennaio: Ottimo periodo per riparazioni post-feste",
                "Febbraio: San Valentino - considera offerte speciali per coppie",
                "Marzo: Primavera - tempo di pulizie e manutenzione",
                "Aprile: Pasqua - possibili regali tecnologici",
                "Maggio: Festa della mamma - mercato regali attivo",
                "Giugno: Lauree e matrimoni - alta domanda",
                "Luglio: Vacanze estive - rallentamento normale",
                "Agosto: Ferie - preparati per settembre",
                "Settembre: Ritorno a scuola/lavoro - boom di richieste",
                "Ottobre: Halloween - gaming e intrattenimento",
                "Novembre: Black Friday - massimizza le vendite",
                "Dicembre: Natale - picco annuale di vendite"
            ];

            predictions.push(`🎯 ${seasonalTips[currentMonth]}`);

            // Market trends
            predictions.push(`🕹️ Trend: Il mercato retrogaming cresce del 20% annuo`);
            predictions.push(`💡 Suggerimento: Investi in componenti rare per Game Boy Color`);

            return predictions.map(p => `<p>${p}</p>`).join('');
        }

        // ===== QUICK ACTION FUNCTIONS =====
        function openQuickSale() {
            const content = `
                <h3 id="modalTitle" style="color: var(--success-light); margin-bottom: var(--spacing-xl);">💰 Vendita Rapida</h3>
                
                <form onsubmit="processQuickSale(event)" class="form-grid">
                    <div class="form-group">
                        <label for="saleAmount">Importo Vendita</label>
                        <input type="number" id="saleAmount" step="0.01" min="0" required placeholder="es. 45.00">
                    </div>
                    
                    <div class="form-group">
                        <label for="saleClient">Cliente</label>
                        <select id="saleClient">
                            <option value="">Cliente Generico</option>
                            ${appData.clients.map(client => 
                                `<option value="${client.client_name}">${client.client_name}</option>`
                            ).join('')}
                        </select>
                    </div>
                    
                    <div class="form-group form-grid-full">
                        <label for="saleDescription">Descrizione</label>
                        <input type="text" id="saleDescription" required placeholder="es. Riparazione Game Boy DMG">
                    </div>
                    
                    <div class="form-group">
                        <label for="saleDate">Data</label>
                        <input type="date" id="saleDate" value="${formatDate()}" required>
                    </div>
                </form>
                
                <div class="quick-actions">
                    <button type="submit" class="btn btn-success" onclick="processQuickSale(event)">
                        <span>💰</span> Registra Vendita
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">
                        <span>❌</span> Annulla
                    </button>
                </div>
            `;
            
            openModal(content);
        }

        async function processQuickSale(event) {
            if (event) event.preventDefault();
            
            const amount = document.getElementById('saleAmount')?.value;
            const client = document.getElementById('saleClient')?.value || 'Cliente Generico';
            const description = document.getElementById('saleDescription')?.value;
            const date = document.getElementById('saleDate')?.value;
            
            if (!amount || !description) {
                showMessage('Compila tutti i campi obbligatori', 'error');
                return;
            }
            
            const transaction = {
                id: generateId(),
                type: 'revenue',
                amount: parseFloat(amount),
                description: description,
                client: client,
                transaction_date: date,
                created_at: formatDateTime()
            };
            
            const success = await enhancedSave('transactions', transaction, appData.transactions, 'Vendita registrata');
            
            if (success) {
                closeModal();
                updateDashboard();
                
                // Refresh current page if on transactions
                if (appData.currentPage === 'transactions') {
                    loadTransactionsPage();
                }
            }
        }

        function openQuickOrder() {
            const content = `
                <h3 id="modalTitle" style="color: var(--warning-light); margin-bottom: var(--spacing-xl);">📋 Nuovo Ordine Rapido</h3>
                
                <form onsubmit="processQuickOrder(event)" class="form-grid">
                    <div class="form-group">
                        <label for="orderClientName">Nome Cliente</label>
                        <input type="text" id="orderClientName" required placeholder="es. Mario Rossi">
                    </div>
                    
                    <div class="form-group">
                        <label for="orderClientEmail">Email Cliente</label>
                        <input type="email" id="orderClientEmail" placeholder="es. mario@email.com">
                    </div>
                    
                    <div class="form-group form-grid-full">
                        <label for="orderSpecs">Specifiche Ordine</label>
                        <textarea id="orderSpecs" placeholder="es. Riparazione Game Boy DMG - sostituzione schermo" required></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="orderDueDate">Data Scadenza</label>
                        <input type="date" id="orderDueDate" value="${formatDate(new Date(Date.now() + 7*24*60*60*1000))}" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="orderStatus">Stato</label>
                        <select id="orderStatus" required>
                            <option value="pending">In Attesa</option>
                            <option value="in-progress">In Lavorazione</option>
                            <option value="completed">Completato</option>
                        </select>
                    </div>
                </form>
                
                <div class="quick-actions">
                    <button type="submit" class="btn btn-warning" onclick="processQuickOrder(event)">
                        <span>📋</span> Crea Ordine
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">
                        <span>❌</span> Annulla
                    </button>
                </div>
            `;
            
            openModal(content);
        }

        async function processQuickOrder(event) {
            if (event) event.preventDefault();
            
            const clientName = document.getElementById('orderClientName')?.value;
            const clientEmail = document.getElementById('orderClientEmail')?.value;
            const specs = document.getElementById('orderSpecs')?.value;
            const dueDate = document.getElementById('orderDueDate')?.value;
            const status = document.getElementById('orderStatus')?.value;
            
            if (!clientName || !specs || !dueDate || !status) {
                showMessage('Compila tutti i campi obbligatori', 'error');
                return;
            }
            
            const order = {
                id: generateId(),
                client_name: clientName,
                client_email: clientEmail || '',
                specs: { description: specs },
                due_date: dueDate,
                status: status,
                created_at: formatDateTime()
            };
            
            const success = await enhancedSave('orders', order, appData.orders, 'Ordine creato');
            
            if (success) {
                // Add client if not exists
                const existingClient = appData.clients.find(c => c.client_name === clientName);
                if (!existingClient && clientEmail) {
                    const newClient = {
                        id: generateId(),
                        client_name: clientName,
                        client_email: clientEmail,
                        client_phone: '',
                        client_source: 'Ordine Rapido',
                        total_spent: 0,
                        created_at: formatDateTime()
                    };
                    
                    await enhancedSave('clients', newClient, appData.clients, 'Cliente aggiunto automaticamente');
                }
                
                closeModal();
                updateDashboard();
                
                if (appData.currentPage === 'orders') {
                    loadOrdersPage();
                }
            }
        }

        function openQuickClient() {
            const content = `
                <h3 id="modalTitle" style="color: var(--warning-light); margin-bottom: var(--spacing-xl);">👤 Cliente Rapido</h3>
                
                <form onsubmit="processQuickClient(event)" class="form-grid">
                    <div class="form-group">
                        <label for="clientName">Nome Cliente</label>
                        <input type="text" id="clientName" required placeholder="es. Mario Rossi">
                    </div>
                    
                    <div class="form-group">
                        <label for="clientEmail">Email</label>
                        <input type="email" id="clientEmail" placeholder="es. mario@email.com">
                    </div>
                    
                    <div class="form-group">
                        <label for="clientPhone">Telefono</label>
                        <input type="tel" id="clientPhone" placeholder="es. +39 123 456 7890">
                    </div>
                    
                    <div class="form-group">
                        <label for="clientSource">Come ci ha conosciuto</label>
                        <select id="clientSource">
                            <option value="">Seleziona...</option>
                            <option value="Instagram">Instagram</option>
                            <option value="Wallapop">Wallapop</option>
                            <option value="Subito">Subito</option>
                            <option value="Vinted">Vinted</option>
                            <option value="Facebook">Facebook</option>
                            <option value="Ebay">Ebay</option>
                            <option value="Altro">Altro</option>
                        </select>
                    </div>
                </form>
                
                <div class="quick-actions">
                    <button type="submit" class="btn btn-warning" onclick="processQuickClient(event)">
                        <span>👤</span> Aggiungi Cliente
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">
                        <span>❌</span> Annulla
                    </button>
                </div>
            `;
            
            openModal(content);
        }

        async function processQuickClient(event) {
            if (event) event.preventDefault();
            
            const name = document.getElementById('clientName')?.value;
            const email = document.getElementById('clientEmail')?.value;
            const phone = document.getElementById('clientPhone')?.value;
            const source = document.getElementById('clientSource')?.value;
            
            if (!name) {
                showMessage('Il nome del cliente è obbligatorio', 'error');
                return;
            }
            
            // Check if client already exists
            const existingClient = appData.clients.find(c => 
                c.client_name.toLowerCase() === name.toLowerCase() ||
                (email && c.client_email.toLowerCase() === email.toLowerCase())
            );
            
            if (existingClient) {
                showMessage('Cliente già esistente', 'error');
                return;
            }
            
            const client = {
                id: generateId(),
                client_name: name,
                client_email: email || '',
                client_phone: phone || '',
                client_source: source || '',
                total_spent: 0,
                created_at: formatDateTime()
            };
            
            const success = await enhancedSave('clients', client, appData.clients, 'Cliente aggiunto');
            
            if (success) {
                closeModal();
                updateDashboard();
                
                if (appData.currentPage === 'clients') {
                    loadClientsPage();
                }
            }
        }

        function openQuickInventory() {
            const content = `
                <h3 id="modalTitle" style="color: var(--primary-light); margin-bottom: var(--spacing-xl);">📦 Componente Rapido</h3>
                
                <form onsubmit="processQuickInventory(event)" class="form-grid">
                    <div class="form-group">
                        <label for="itemName">Nome Componente</label>
                        <input type="text" id="itemName" required placeholder="es. Schermo LCD Game Boy DMG">
                    </div>
                    
                    <div class="form-group">
                        <label for="itemQuantity">Quantità</label>
                        <input type="number" id="itemQuantity" min="0" required value="1">
                    </div>
                    
                    <div class="form-group">
                        <label for="itemThreshold">Soglia Minima</label>
                        <input type="number" id="itemThreshold" min="0" value="5">
                    </div>
                    
                    <div class="form-group">
                        <label for="itemPrice">Prezzo Unitario</label>
                        <input type="number" id="itemPrice" step="0.01" min="0" placeholder="es. 25.00">
                    </div>
                    
                    <div class="form-group form-grid-full">
                        <label for="itemSupplier">Fornitore</label>
                        <input type="text" id="itemSupplier" placeholder="es. TechParts Italia">
                    </div>
                </form>
                
                <div class="quick-actions">
                    <button type="submit" class="btn" onclick="processQuickInventory(event)">
                        <span>📦</span> Aggiungi Componente
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">
                        <span>❌</span> Annulla
                    </button>
                </div>
            `;
            
            openModal(content);
        }

        async function processQuickInventory(event) {
            if (event) event.preventDefault();
            
            const name = document.getElementById('itemName')?.value;
            const quantity = document.getElementById('itemQuantity')?.value;
            const threshold = document.getElementById('itemThreshold')?.value;
            const price = document.getElementById('itemPrice')?.value;
            const supplier = document.getElementById('itemSupplier')?.value;
            
            if (!name || !quantity) {
                showMessage('Nome e quantità sono obbligatori', 'error');
                return;
            }
            
            const item = {
                id: generateId(),
                item_name: name,
                quantity: parseInt(quantity),
                threshold: parseInt(threshold) || 5,
                price: parseFloat(price) || 0,
                supplier: supplier || '',
                created_at: formatDateTime()
            };
            
            const success = await enhancedSave('inventory', item, appData.inventory, 'Componente aggiunto');
            
            if (success) {
                closeModal();
                updateDashboard();
                
                if (appData.currentPage === 'inventory') {
                    loadInventoryPage();
                }
            }
        }

        // ===== CALENDAR FUNCTIONS =====
        function loadCalendarPage() {
            renderCalendar();
        }

        function renderCalendar() {
            const calendarGrid = document.getElementById('calendarGrid');
            const calendarMonth = document.getElementById('calendarMonth');
            
            if (!calendarGrid || !calendarMonth) return;

            const now = new Date();
            const year = appData.calendarDate.getFullYear();
            const month = appData.calendarDate.getMonth();
            
            // Update month display
            const monthNames = [
                'Gennaio', 'Febbraio', 'Marzo', 'Aprile', 'Maggio', 'Giugno',
                'Luglio', 'Agosto', 'Settembre', 'Ottobre', 'Novembre', 'Dicembre'
            ];
            calendarMonth.textContent = `${monthNames[month]} ${year}`;

            // Clear previous calendar
            calendarGrid.innerHTML = '';

            // Add day headers
            const dayHeaders = ['Lun', 'Mar', 'Mer', 'Gio', 'Ven', 'Sab', 'Dom'];
            dayHeaders.forEach(day => {
                const header = document.createElement('div');
                header.className = 'calendar-day-header';
                header.textContent = day;
                calendarGrid.appendChild(header);
            });

            // Get first day of month and number of days
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            
            // Adjust first day (Monday = 0)
            let startDay = firstDay.getDay() - 1;
            if (startDay < 0) startDay = 6;

            // Add empty cells for days before month starts
            for (let i = 0; i < startDay; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.className = 'calendar-day other-month';
                calendarGrid.appendChild(emptyDay);
            }

            // Add days of current month
            for (let day = 1; day <= daysInMonth; day++) {
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                
                const currentDate = new Date(year, month, day);
                const dateStr = formatDate(currentDate);
                
                // Check if it's today
                if (currentDate.toDateString() === now.toDateString()) {
                    dayElement.classList.add('today');
                }
                
                dayElement.innerHTML = `
                    <div class="calendar-day-number">${day}</div>
                    <div class="calendar-events" id="events-${dateStr}"></div>
                `;
                
                // Add click handler
                dayElement.addEventListener('click', () => openCalendarDay(dateStr));
                
                calendarGrid.appendChild(dayElement);
                
                // Load events for this day
                loadCalendarEvents(dateStr);
            }
        }

        function loadCalendarEvents(dateStr) {
            const eventsContainer = document.getElementById(`events-${dateStr}`);
            if (!eventsContainer) return;

            eventsContainer.innerHTML = '';

            // Load orders for this date
            const ordersForDate = appData.orders.filter(order => {
                const orderDate = parseStoredDate(order.due_date);
                return orderDate === dateStr;
            });

            ordersForDate.forEach(order => {
                const event = document.createElement('div');
                event.className = 'calendar-event order';
                event.textContent = `📋 ${order.client_name}`;
                event.title = `Ordine: ${order.specs?.description || 'N/A'}`;
                eventsContainer.appendChild(event);
            });

            // Load transactions for this date
            const transactionsForDate = appData.transactions.filter(transaction => {
                const transactionDate = parseStoredDate(transaction.transaction_date);
                return transactionDate === dateStr;
            });

            transactionsForDate.forEach(transaction => {
                const event = document.createElement('div');
                event.className = `calendar-event transaction-${transaction.type}`;
                const icon = transaction.type === 'revenue' ? '💰' : '💸';
                event.textContent = `${icon} ${formatCurrency(transaction.amount)}`;
                event.title = `${transaction.description} - ${transaction.client || 'N/A'}`;
                eventsContainer.appendChild(event);
            });
        }

        function changeMonth(direction) {
            const currentMonth = appData.calendarDate.getMonth();
            const currentYear = appData.calendarDate.getFullYear();
            
            if (direction === 1) {
                // Next month
                if (currentMonth === 11) {
                    appData.calendarDate = new Date(currentYear + 1, 0, 1);
                } else {
                    appData.calendarDate = new Date(currentYear, currentMonth + 1, 1);
                }
            } else {
                // Previous month
                if (currentMonth === 0) {
                    appData.calendarDate = new Date(currentYear - 1, 11, 1);
                } else {
                    appData.calendarDate = new Date(currentYear, currentMonth - 1, 1);
                }
            }
            
            renderCalendar();
        }

        function goToToday() {
            appData.calendarDate = new Date();
            renderCalendar();
        }

        function openCalendarDay(dateStr) {
            const ordersForDate = appData.orders.filter(order => {
                const orderDate = parseStoredDate(order.due_date);
                return orderDate === dateStr;
            });

            const transactionsForDate = appData.transactions.filter(transaction => {
                const transactionDate = parseStoredDate(transaction.transaction_date);
                return transactionDate === dateStr;
            });

            const date = new Date(dateStr);
            const formattedDate = date.toLocaleDateString('it-IT', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });

            let content = `
                <h3 style="color: var(--primary-light); margin-bottom: var(--spacing-xl);">📅 ${formattedDate}</h3>
            `;

            if (ordersForDate.length === 0 && transactionsForDate.length === 0) {
                content += `
                    <div class="empty-state">
                        <div class="empty-state-icon">📅</div>
                        <p>Nessun evento per questa data</p>
                    </div>
                `;
            } else {
                if (ordersForDate.length > 0) {
                    content += `
                        <h4 style="color: var(--warning-light); margin: var(--spacing-lg) 0;">📋 Ordini in Scadenza</h4>
                        <div style="margin-bottom: var(--spacing-xl);">
                    `;
                    
                    ordersForDate.forEach(order => {
                        content += `
                            <div class="card" style="margin: var(--spacing-md) 0; padding: var(--spacing-lg);">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <h5 style="color: var(--text-primary); margin-bottom: var(--spacing-sm);">${order.client_name}</h5>
                                        <p style="color: var(--text-muted); font-size: 0.875rem;">${order.specs?.description || 'N/A'}</p>
                                        <div class="status-badge status-${order.status}" style="margin-top: var(--spacing-sm);">
                                            ${order.status}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    
                    content += `</div>`;
                }

                if (transactionsForDate.length > 0) {
                    content += `
                        <h4 style="color: var(--success-light); margin: var(--spacing-lg) 0;">💰 Transazioni</h4>
                        <div>
                    `;
                    
                    transactionsForDate.forEach(transaction => {
                        const isRevenue = transaction.type === 'revenue';
                        content += `
                            <div class="card" style="margin: var(--spacing-md) 0; padding: var(--spacing-lg);">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <h5 style="color: ${isRevenue ? 'var(--success-light)' : 'var(--error-light)'}; margin-bottom: var(--spacing-xs);">
                                            ${isRevenue ? '💰' : '💸'} ${formatCurrency(transaction.amount)}
                                        </h5>
                                        <p style="color: var(--text-primary); margin-bottom: var(--spacing-xs);">${transaction.description}</p>
                                        <p style="color: var(--text-muted); font-size: 0.875rem;">Cliente: ${transaction.client || 'N/A'}</p>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    
                    content += `</div>`;
                }
            }

            const dayContent = document.getElementById('calendarDayContent');
            const dayView = document.getElementById('calendarDayView');
            
            if (dayContent && dayView) {
                dayContent.innerHTML = content;
                dayView.classList.add('active');
            }
        }

        function closeCalendarDayView() {
            const dayView = document.getElementById('calendarDayView');
            if (dayView) {
                dayView.classList.remove('active');
            }
        }

        // ===== PAGE LOAD FUNCTIONS =====
        function loadOrdersPage() {
            const container = document.getElementById('ordersContainer');
            if (!container) return;

            if (appData.orders.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">📋</div>
                        <h4>Nessun ordine presente</h4>
                        <p>Inizia creando il tuo primo ordine</p>
                        <button class="btn btn-success" onclick="addOrder()">
                            <span>📋</span> Nuovo Ordine
                        </button>
                    </div>
                `;
                return;
            }

            let html = '<table class="data-table"><thead><tr>';
            html += '<th>Cliente</th><th>Descrizione</th><th>Stato</th><th>Scadenza</th><th>Azioni</th>';
            html += '</tr></thead><tbody>';

            appData.orders.forEach(order => {
                const dueDate = new Date(order.due_date);
                const isOverdue = dueDate < new Date() && order.status !== 'completed';
                
                html += `
                    <tr>
                        <td>
                            <strong>${order.client_name}</strong><br>
                            <small style="color: var(--text-muted);">${order.client_email || 'N/A'}</small>
                        </td>
                        <td>${order.specs?.description || 'N/A'}</td>
                        <td>
                            <div class="status-badge status-${order.status}">
                                ${order.status}
                            </div>
                            ${isOverdue ? '<div style="color: var(--error-light); font-size: 0.75rem; margin-top: 4px;">⚠️ In ritardo</div>' : ''}
                        </td>
                        <td>${dueDate.toLocaleDateString('it-IT')}</td>
                        <td>
                            <button class="btn btn-secondary" onclick="editOrder('${order.id}')" style="margin: 2px;">
                                <span>✏️</span> Modifica
                            </button>
                            <button class="btn btn-error" onclick="deleteOrder('${order.id}')" style="margin: 2px;">
                                <span>🗑️</span> Elimina
                            </button>
                        </td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            container.innerHTML = html;

            // Setup search
            setupSearch('orderSearch', 'ordersContainer', appData.orders, formatOrderForSearch);
        }

        function loadTransactionsPage() {
            const container = document.getElementById('transactionsContainer');
            if (!container) return;

            if (appData.transactions.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">💰</div>
                        <h4>Nessuna transazione presente</h4>
                        <p>Inizia registrando la tua prima transazione</p>
                        <div class="quick-actions">
                            <button class="btn btn-success" onclick="addTransaction('revenue')">
                                <span>💰</span> Nuova Entrata
                            </button>
                            <button class="btn btn-error" onclick="addTransaction('expense')">
                                <span>💸</span> Nuova Spesa
                            </button>
                        </div>
                    </div>
                `;
                return;
            }

            let html = '<table class="data-table"><thead><tr>';
            html += '<th>Data</th><th>Tipo</th><th>Importo</th><th>Descrizione</th><th>Cliente</th><th>Azioni</th>';
            html += '</tr></thead><tbody>';

            appData.transactions
                .sort((a, b) => new Date(b.transaction_date || b.created_at) - new Date(a.transaction_date || a.created_at))
                .forEach(transaction => {
                    const isRevenue = transaction.type === 'revenue';
                    const date = new Date(transaction.transaction_date || transaction.created_at);
                    
                    html += `
                        <tr>
                            <td>${date.toLocaleDateString('it-IT')}</td>
                            <td>
                                <span style="color: ${isRevenue ? 'var(--success-light)' : 'var(--error-light)'};">
                                    ${isRevenue ? '💰 Entrata' : '💸 Spesa'}
                                </span>
                            </td>
                            <td>
                                <strong style="color: ${isRevenue ? 'var(--success-light)' : 'var(--error-light)'};">
                                    ${isRevenue ? '+' : '-'}${formatCurrency(Math.abs(transaction.amount))}
                                </strong>
                            </td>
                            <td>${transaction.description}</td>
                            <td>${transaction.client || 'N/A'}</td>
                            <td>
                                <button class="btn btn-secondary" onclick="editTransaction('${transaction.id}')" style="margin: 2px;">
                                    <span>✏️</span> Modifica
                                </button>
                                <button class="btn btn-error" onclick="deleteTransaction('${transaction.id}')" style="margin: 2px;">
                                    <span>🗑️</span> Elimina
                                </button>
                            </td>
                        </tr>
                    `;
                });

            html += '</tbody></table>';
            container.innerHTML = html;

            // Setup search
            setupSearch('transactionSearch', 'transactionsContainer', appData.transactions, formatTransactionForSearch);
        }

        function loadClientsPage() {
            const container = document.getElementById('clientsContainer');
            if (!container) return;

            if (appData.clients.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">👤</div>
                        <h4>Nessun cliente presente</h4>
                        <p>Inizia aggiungendo il tuo primo cliente</p>
                        <button class="btn btn-success" onclick="addClient()">
                            <span>👤</span> Nuovo Cliente
                        </button>
                    </div>
                `;
                return;
            }

            let html = '<table class="data-table"><thead><tr>';
            html += '<th>Nome</th><th>Contatti</th><th>Fonte</th><th>Totale Speso</th><th>Ultimo Ordine</th><th>Azioni</th>';
            html += '</tr></thead><tbody>';

            appData.clients
                .sort((a, b) => (b.total_spent || 0) - (a.total_spent || 0))
                .forEach(client => {
                    const lastOrder = appData.orders
                        .filter(o => o.client_name === client.client_name)
                        .sort((a, b) => new Date(b.created_at) - new Date(a.created_at))[0];
                    
                    html += `
                        <tr>
                            <td>
                                <strong>${client.client_name}</strong><br>
                                <small style="color: var(--text-muted);">Cliente dal ${new Date(client.created_at).toLocaleDateString('it-IT')}</small>
                            </td>
                            <td>
                                ${client.client_email ? `📧 ${client.client_email}<br>` : ''}
                                ${client.client_phone ? `📞 ${client.client_phone}` : ''}
                                ${!client.client_email && !client.client_phone ? 'N/A' : ''}
                            </td>
                            <td>${client.client_source || 'N/A'}</td>
                            <td>
                                <strong style="color: var(--success-light);">
                                    ${formatCurrency(client.total_spent || 0)}
                                </strong>
                            </td>
                            <td>${lastOrder ? new Date(lastOrder.created_at).toLocaleDateString('it-IT') : 'Nessuno'}</td>
                            <td>
                                <button class="btn btn-secondary" onclick="editClient('${client.id}')" style="margin: 2px;">
                                    <span>✏️</span> Modifica
                                </button>
                                <button class="btn btn-error" onclick="deleteClient('${client.id}')" style="margin: 2px;">
                                    <span>🗑️</span> Elimina
                                </button>
                            </td>
                        </tr>
                    `;
                });

            html += '</tbody></table>';
            container.innerHTML = html;

            // Setup search
            setupSearch('clientSearch', 'clientsContainer', appData.clients, formatClientForSearch);
        }

        function loadInventoryPage() {
            const container = document.getElementById('inventoryContainer');
            if (!container) return;

            if (appData.inventory.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">📦</div>
                        <h4>Nessun componente in inventario</h4>
                        <p>Inizia aggiungendo il tuo primo componente</p>
                        <button class="btn btn-success" onclick="addInventoryItem()">
                            <span>📦</span> Nuovo Componente
                        </button>
                    </div>
                `;
                return;
            }

            let html = '<table class="data-table"><thead><tr>';
            html += '<th>Componente</th><th>Quantità</th><th>Soglia</th><th>Prezzo</th><th>Fornitore</th><th>Azioni</th>';
            html += '</tr></thead><tbody>';

            appData.inventory.forEach(item => {
                const isLowStock = item.quantity <= (item.threshold || 5);
                
                html += `
                    <tr ${isLowStock ? 'style="background-color: rgba(239, 68, 68, 0.1);"' : ''}>
                        <td>
                            <strong>${item.item_name}</strong>
                            ${isLowStock ? '<br><small style="color: var(--error-light);">⚠️ Scorte basse</small>' : ''}
                        </td>
                        <td>
                            <strong style="color: ${isLowStock ? 'var(--error-light)' : 'var(--success-light)'};">
                                ${item.quantity}
                            </strong>
                        </td>
                        <td>${item.threshold || 5}</td>
                        <td>${formatCurrency(item.price || 0)}</td>
                        <td>${item.supplier || 'N/A'}</td>
                        <td>
                            <button class="btn btn-secondary" onclick="editInventoryItem('${item.id}')" style="margin: 2px;">
                                <span>✏️</span> Modifica
                            </button>
                            <button class="btn btn-error" onclick="deleteInventoryItem('${item.id}')" style="margin: 2px;">
                                <span>🗑️</span> Elimina
                            </button>
                        </td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            container.innerHTML = html;

            // Setup search
            setupSearch('inventorySearch', 'inventoryContainer', appData.inventory, formatInventoryForSearch);
        }

        function loadAnalyticsPage() {
            generateMonthlyTrends();
            generateTopClients();
            generateMonthlyPerformance();
            generateKPIDashboard();
        }

        // ===== SEARCH FUNCTIONS =====
        function setupSearch(searchInputId, containerId, dataArray, formatFunction) {
            const searchInput = document.getElementById(searchInputId);
            if (!searchInput) return;

            searchInput.addEventListener('input', (e) => {
                const query = e.target.value.toLowerCase().trim();
                
                if (query === '') {
                    // Show all items
                    switch(containerId) {
                        case 'ordersContainer':
                            loadOrdersPage();
                            break;
                        case 'transactionsContainer':
                            loadTransactionsPage();
                            break;
                        case 'clientsContainer':
                            loadClientsPage();
                            break;
                        case 'inventoryContainer':
                            loadInventoryPage();
                            break;
                    }
                } else {
                    // Filter and show results
                    const filteredData = dataArray.filter(item => 
                        formatFunction(item).toLowerCase().includes(query)
                    );
                    displaySearchResults(containerId, filteredData, formatFunction);
                }
            });
        }

        function formatOrderForSearch(order) {
            return `${order.client_name} ${order.client_email || ''} ${order.specs?.description || ''} ${order.status}`;
        }

        function formatTransactionForSearch(transaction) {
            return `${transaction.description} ${transaction.client || ''} ${transaction.type}`;
        }

        function formatClientForSearch(client) {
            return `${client.client_name} ${client.client_email || ''} ${client.client_phone || ''} ${client.client_source || ''}`;
        }

        function formatInventoryForSearch(item) {
            return `${item.item_name} ${item.supplier || ''}`;
        }

        function displaySearchResults(containerId, filteredData, formatFunction) {
            const container = document.getElementById(containerId);
            if (!container) return;

            if (filteredData.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">🔍</div>
                        <h4>Nessun risultato trovato</h4>
                        <p>Prova con termini di ricerca diversi</p>
                    </div>
                `;
                return;
            }

            // This would need specific implementation for each data type
            // For now, just reload the appropriate page
            switch(containerId) {
                case 'ordersContainer':
                    loadOrdersPage();
                    break;
                case 'transactionsContainer':
                    loadTransactionsPage();
                    break;
                case 'clientsContainer':
                    loadClientsPage();
                    break;
                case 'inventoryContainer':
                    loadInventoryPage();
                    break;
            }
        }

        // ===== CRUD FUNCTIONS =====
        function addOrder() {
            openQuickOrder();
        }

        function addTransaction(type) {
            if (type === 'revenue') {
                openQuickSale();
            } else {
                // Open expense modal
                const content = `
                    <h3 id="modalTitle" style="color: var(--error-light); margin-bottom: var(--spacing-xl);">💸 Nuova Spesa</h3>
                    
                    <form onsubmit="processExpense(event)" class="form-grid">
                        <div class="form-group">
                            <label for="expenseAmount">Importo Spesa</label>
                            <input type="number" id="expenseAmount" step="0.01" min="0" required placeholder="es. 25.00">
                        </div>
                        
                        <div class="form-group">
                            <label for="expenseDescription">Descrizione</label>
                            <input type="text" id="expenseDescription" required placeholder="es. Componenti elettronici">
                        </div>
                        
                        <div class="form-group">
                            <label for="expenseDate">Data</label>
                            <input type="date" id="expenseDate" value="${formatDate()}" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="expenseCategory">Categoria</label>
                            <select id="expenseCategory">
                                <option value="">Seleziona categoria...</option>
                                <option value="Componenti">Componenti</option>
                                <option value="Attrezzature">Attrezzature</option>
                                <option value="Marketing">Marketing</option>
                                <option value="Trasporti">Trasporti</option>
                                <option value="Altro">Altro</option>
                            </select>
                        </div>
                    </form>
                    
                    <div class="quick-actions">
                        <button type="submit" class="btn btn-error" onclick="processExpense(event)">
                            <span>💸</span> Registra Spesa
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="closeModal()">
                            <span>❌</span> Annulla
                        </button>
                    </div>
                `;
                
                openModal(content);
            }
        }

        async function processExpense(event) {
            if (event) event.preventDefault();
            
            const amount = document.getElementById('expenseAmount')?.value;
            const description = document.getElementById('expenseDescription')?.value;
            const date = document.getElementById('expenseDate')?.value;
            const category = document.getElementById('expenseCategory')?.value;
            
            if (!amount || !description) {
                showMessage('Compila tutti i campi obbligatori', 'error');
                return;
            }
            
            const transaction = {
                id: generateId(),
                type: 'expense',
                amount: parseFloat(amount),
                description: description,
                client: category || 'Spesa Generale',
                transaction_date: date,
                created_at: formatDateTime()
            };
            
            const success = await enhancedSave('transactions', transaction, appData.transactions, 'Spesa registrata');
            
            if (success) {
                closeModal();
                updateDashboard();
                
                if (appData.currentPage === 'transactions') {
                    loadTransactionsPage();
                }
            }
        }

        function addClient() {
            openQuickClient();
        }

        function addInventoryItem() {
            openQuickInventory();
        }

        // ===== EDIT FUNCTIONS =====
        function editOrder(id) {
            const order = appData.orders.find(o => o.id === id);
            if (!order) return;

            appData.editingId = id;

            const content = `
                <h3 id="modalTitle" style="color: var(--warning-light); margin-bottom: var(--spacing-xl);">📋 Modifica Ordine</h3>
                
                <form onsubmit="processQuickOrder(event)" class="form-grid">
                    <div class="form-group">
                        <label for="orderClientName">Nome Cliente</label>
                        <input type="text" id="orderClientName" required value="${order.client_name}">
                    </div>
                    
                    <div class="form-group">
                        <label for="orderClientEmail">Email Cliente</label>
                        <input type="email" id="orderClientEmail" value="${order.client_email || ''}">
                    </div>
                    
                    <div class="form-group form-grid-full">
                        <label for="orderSpecs">Specifiche Ordine</label>
                        <textarea id="orderSpecs" required>${order.specs?.description || ''}</textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="orderDueDate">Data Scadenza</label>
                        <input type="date" id="orderDueDate" value="${parseStoredDate(order.due_date)}" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="orderStatus">Stato</label>
                        <select id="orderStatus" required>
                            <option value="pending" ${order.status === 'pending' ? 'selected' : ''}>In Attesa</option>
                            <option value="in-progress" ${order.status === 'in-progress' ? 'selected' : ''}>In Lavorazione</option>
                            <option value="completed" ${order.status === 'completed' ? 'selected' : ''}>Completato</option>
                            <option value="cancelled" ${order.status === 'cancelled' ? 'selected' : ''}>Annullato</option>
                        </select>
                    </div>
                </form>
                
                <div class="quick-actions">
                    <button type="submit" class="btn btn-warning" onclick="processQuickOrder(event)">
                        <span>💾</span> Salva Modifiche
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">
                        <span>❌</span> Annulla
                    </button>
                </div>
            `;
            
            openModal(content);
        }

        function editTransaction(id) {
            const transaction = appData.transactions.find(t => t.id === id);
            if (!transaction) return;

            appData.editingId = id;

            const isRevenue = transaction.type === 'revenue';
            const content = `
                <h3 id="modalTitle" style="color: ${isRevenue ? 'var(--success-light)' : 'var(--error-light)'}; margin-bottom: var(--spacing-xl);">
                    ${isRevenue ? '💰 Modifica Entrata' : '💸 Modifica Spesa'}
                </h3>
                
                <form onsubmit="${isRevenue ? 'processQuickSale(event)' : 'processExpense(event)'}" class="form-grid">
                    <div class="form-group">
                        <label for="${isRevenue ? 'saleAmount' : 'expenseAmount'}">Importo</label>
                        <input type="number" id="${isRevenue ? 'saleAmount' : 'expenseAmount'}" step="0.01" min="0" required value="${transaction.amount}">
                    </div>
                    
                    <div class="form-group">
                        <label for="${isRevenue ? 'saleDescription' : 'expenseDescription'}">Descrizione</label>
                        <input type="text" id="${isRevenue ? 'saleDescription' : 'expenseDescription'}" required value="${transaction.description}">
                    </div>
                    
                    <div class="form-group">
                        <label for="${isRevenue ? 'saleDate' : 'expenseDate'}">Data</label>
                        <input type="date" id="${isRevenue ? 'saleDate' : 'expenseDate'}" value="${parseStoredDate(transaction.transaction_date)}" required>
                    </div>
                    
                    ${isRevenue ? `
                        <div class="form-group">
                            <label for="saleClient">Cliente</label>
                            <select id="saleClient">
                                <option value="">Cliente Generico</option>
                                ${appData.clients.map(client => 
                                    `<option value="${client.client_name}" ${transaction.client === client.client_name ? 'selected' : ''}>${client.client_name}</option>`
                                ).join('')}
                            </select>
                        </div>
                    ` : `
                        <div class="form-group">
                            <label for="expenseCategory">Categoria</label>
                            <select id="expenseCategory">
                                <option value="">Seleziona categoria...</option>
                                <option value="Componenti" ${transaction.client === 'Componenti' ? 'selected' : ''}>Componenti</option>
                                <option value="Attrezzature" ${transaction.client === 'Attrezzature' ? 'selected' : ''}>Attrezzature</option>
                                <option value="Marketing" ${transaction.client === 'Marketing' ? 'selected' : ''}>Marketing</option>
                                <option value="Trasporti" ${transaction.client === 'Trasporti' ? 'selected' : ''}>Trasporti</option>
                                <option value="Altro" ${transaction.client === 'Altro' ? 'selected' : ''}>Altro</option>
                            </select>
                        </div>
                    `}
                </form>
                
                <div class="quick-actions">
                    <button type="submit" class="btn ${isRevenue ? 'btn-success' : 'btn-error'}" onclick="${isRevenue ? 'processQuickSale(event)' : 'processExpense(event)'}">
                        <span>💾</span> Salva Modifiche
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">
                        <span>❌</span> Annulla
                    </button>
                </div>
            `;
            
            openModal(content);
        }

        function editClient(id) {
            const client = appData.clients.find(c => c.id === id);
            if (!client) return;

            appData.editingId = id;

            const content = `
                <h3 id="modalTitle" style="color: var(--warning-light); margin-bottom: var(--spacing-xl);">👤 Modifica Cliente</h3>
                
                <form onsubmit="processQuickClient(event)" class="form-grid">
                    <div class="form-group">
                        <label for="clientName">Nome Cliente</label>
                        <input type="text" id="clientName" required value="${client.client_name}">
                    </div>
                    
                    <div class="form-group">
                        <label for="clientEmail">Email</label>
                        <input type="email" id="clientEmail" value="${client.client_email || ''}">
                    </div>
                    
                    <div class="form-group">
                        <label for="clientPhone">Telefono</label>
                        <input type="tel" id="clientPhone" value="${client.client_phone || ''}">
                    </div>
                    
                    <div class="form-group">
                        <label for="clientSource">Come ci ha conosciuto</label>
                        <select id="clientSource">
                            <option value="">Seleziona...</option>
                            <option value="Instagram" ${client.client_source === 'Instagram' ? 'selected' : ''}>Instagram</option>
                            <option value="Wallapop" ${client.client_source === 'Wallapop' ? 'selected' : ''}>Wallapop</option>
                            <option value="Subito" ${client.client_source === 'Subito' ? 'selected' : ''}>Subito</option>
                            <option value="Vinted" ${client.client_source === 'Vinted' ? 'selected' : ''}>Vinted</option>
                            <option value="Facebook" ${client.client_source === 'Facebook' ? 'selected' : ''}>Facebook</option>
                            <option value="Ebay" ${client.client_source === 'Ebay' ? 'selected' : ''}>Ebay</option>
                            <option value="Altro" ${client.client_source === 'Altro' ? 'selected' : ''}>Altro</option>
                        </select>
                    </div>
                </form>
                
                <div class="quick-actions">
                    <button type="submit" class="btn btn-warning" onclick="processQuickClient(event)">
                        <span>💾</span> Salva Modifiche
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">
                        <span>❌</span> Annulla
                    </button>
                </div>
            `;
            
            openModal(content);
        }

        function editInventoryItem(id) {
            const item = appData.inventory.find(i => i.id === id);
            if (!item) return;

            appData.editingId = id;

            const content = `
                <h3 id="modalTitle" style="color: var(--primary-light); margin-bottom: var(--spacing-xl);">📦 Modifica Componente</h3>
                
                <form onsubmit="processQuickInventory(event)" class="form-grid">
                    <div class="form-group">
                        <label for="itemName">Nome Componente</label>
                        <input type="text" id="itemName" required value="${item.item_name}">
                    </div>
                    
                    <div class="form-group">
                        <label for="itemQuantity">Quantità</label>
                        <input type="number" id="itemQuantity" min="0" required value="${item.quantity}">
                    </div>
                    
                    <div class="form-group">
                        <label for="itemThreshold">Soglia Minima</label>
                        <input type="number" id="itemThreshold" min="0" value="${item.threshold || 5}">
                    </div>
                    
                    <div class="form-group">
                        <label for="itemPrice">Prezzo Unitario</label>
                        <input type="number" id="itemPrice" step="0.01" min="0" value="${item.price || 0}">
                    </div>
                    
                    <div class="form-group form-grid-full">
                        <label for="itemSupplier">Fornitore</label>
                        <input type="text" id="itemSupplier" value="${item.supplier || ''}">
                    </div>
                </form>
                
                <div class="quick-actions">
                    <button type="submit" class="btn" onclick="processQuickInventory(event)">
                        <span>💾</span> Salva Modifiche
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">
                        <span>❌</span> Annulla
                    </button>
                </div>
            `;
            
            openModal(content);
        }

        // ===== DELETE FUNCTIONS =====
        function deleteOrder(id) {
            const order = appData.orders.find(o => o.id === id);
            if (!order) return;

            showConfirmDialog(
                'Elimina Ordine',
                `Sei sicuro di voler eliminare l'ordine di ${order.client_name}?`,
                async () => {
                    const success = await enhancedDelete('orders', id, appData.orders, 'Ordine');
                    if (success) {
                        loadOrdersPage();
                        updateDashboard();
                    }
                }
            );
        }

        function deleteTransaction(id) {
            const transaction = appData.transactions.find(t => t.id === id);
            if (!transaction) return;

            showConfirmDialog(
                'Elimina Transazione',
                `Sei sicuro di voler eliminare la transazione "${transaction.description}"?`,
                async () => {
                    const success = await enhancedDelete('transactions', id, appData.transactions, 'Transazione');
                    if (success) {
                        loadTransactionsPage();
                        updateDashboard();
                    }
                }
            );
        }

        function deleteClient(id) {
            const client = appData.clients.find(c => c.id === id);
            if (!client) return;

            showConfirmDialog(
                'Elimina Cliente',
                `Sei sicuro di voler eliminare il cliente ${client.client_name}?`,
                async () => {
                    const success = await enhancedDelete('clients', id, appData.clients, 'Cliente');
                    if (success) {
                        loadClientsPage();
                        updateDashboard();
                    }
                }
            );
        }

        function deleteInventoryItem(id) {
            const item = appData.inventory.find(i => i.id === id);
            if (!item) return;

            showConfirmDialog(
                'Elimina Componente',
                `Sei sicuro di voler eliminare il componente "${item.item_name}"?`,
                async () => {
                    const success = await enhancedDelete('inventory', id, appData.inventory, 'Componente');
                    if (success) {
                        loadInventoryPage();
                        updateDashboard();
                    }
                }
            );
        }

        // ===== ANALYTICS FUNCTIONS =====
        function generateMonthlyTrends() {
            const container = document.getElementById('monthlyTrends');
            if (!container) return;

            const months = [];
            const revenues = [];
            const expenses = [];

            // Get last 6 months
            for (let i = 5; i >= 0; i--) {
                const date = new Date();
                date.setMonth(date.getMonth() - i);
                const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                
                months.push(date.toLocaleDateString('it-IT', { month: 'short', year: 'numeric' }));

                const monthRevenues = appData.transactions
                    .filter(t => t.type === 'revenue' && (t.transaction_date || t.created_at).startsWith(monthKey))
                    .reduce((sum, t) => sum + (parseFloat(t.amount) || 0), 0);

                const monthExpenses = appData.transactions
                    .filter(t => t.type === 'expense' && (t.transaction_date || t.created_at).startsWith(monthKey))
                    .reduce((sum, t) => sum + (parseFloat(t.amount) || 0), 0);

                revenues.push(monthRevenues);
                expenses.push(monthExpenses);
            }

            let html = `
                <div style="margin-bottom: var(--spacing-lg);">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Mese</th>
                                <th>Entrate</th>
                                <th>Spese</th>
                                <th>Profitto</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            months.forEach((month, index) => {
                const revenue = revenues[index];
                const expense = expenses[index];
                const profit = revenue - expense;

                html += `
                    <tr>
                        <td>${month}</td>
                        <td style="color: var(--success-light);">${formatCurrency(revenue)}</td>
                        <td style="color: var(--error-light);">${formatCurrency(expense)}</td>
                        <td style="color: ${profit >= 0 ? 'var(--success-light)' : 'var(--error-light)'};">${formatCurrency(profit)}</td>
                    </tr>
                `;
            });

            html += `
                        </tbody>
                    </table>
                </div>
            `;

            container.innerHTML = html;
        }

        function generateTopClients() {
            const container = document.getElementById('topClients');
            if (!container) return;

            const topClients = appData.clients
                .filter(client => client.total_spent > 0)
                .sort((a, b) => (b.total_spent || 0) - (a.total_spent || 0))
                .slice(0, 5);

            if (topClients.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">👤</div>
                        <p>Nessun cliente con acquisti registrati</p>
                    </div>
                `;
                return;
            }

            let html = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Posizione</th>
                            <th>Cliente</th>
                            <th>Totale Speso</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            topClients.forEach((client, index) => {
                const medal = index === 0 ? '🥇' : index === 1 ? '🥈' : index === 2 ? '🥉' : `${index + 1}°`;
                
                html += `
                    <tr>
                        <td>${medal}</td>
                        <td>${client.client_name}</td>
                        <td style="color: var(--success-light); font-weight: bold;">${formatCurrency(client.total_spent)}</td>
                    </tr>
                `;
            });

            html += `
                    </tbody>
                </table>
            `;

            container.innerHTML = html;
        }

        function generateMonthlyPerformance() {
            const container = document.getElementById('monthlyPerformance');
            if (!container) return;

            const currentMonth = new Date();
            const currentMonthKey = `${currentMonth.getFullYear()}-${String(currentMonth.getMonth() + 1).padStart(2, '0')}`;
            
            const lastMonth = new Date();
            lastMonth.setMonth(lastMonth.getMonth() - 1);
            const lastMonthKey = `${lastMonth.getFullYear()}-${String(lastMonth.getMonth() + 1).padStart(2, '0')}`;

            const currentRevenues = appData.transactions
                .filter(t => t.type === 'revenue' && (t.transaction_date || t.created_at).startsWith(currentMonthKey))
                .reduce((sum, t) => sum + (parseFloat(t.amount) || 0), 0);

            const lastRevenues = appData.transactions
                .filter(t => t.type === 'revenue' && (t.transaction_date || t.created_at).startsWith(lastMonthKey))
                .reduce((sum, t) => sum + (parseFloat(t.amount) || 0), 0);

            const currentOrders = appData.orders
                .filter(o => o.created_at.startsWith(currentMonthKey)).length;

            const lastOrders = appData.orders
                .filter(o => o.created_at.startsWith(lastMonthKey)).length;

            const revenueGrowth = lastRevenues > 0 ? ((currentRevenues - lastRevenues) / lastRevenues * 100) : 0;
            const orderGrowth = lastOrders > 0 ? ((currentOrders - lastOrders) / lastOrders * 100) : 0;

            const html = `
                <div class="business-summary">
                    <div class="business-metric">
                        <span class="metric-label">Entrate questo mese:</span>
                        <span class="metric-value metric-positive">${formatCurrency(currentRevenues)}</span>
                    </div>
                    <div class="business-metric">
                        <span class="metric-label">Crescita entrate:</span>
                        <span class="metric-value ${revenueGrowth >= 0 ? 'metric-positive' : 'metric-negative'}">
                            ${revenueGrowth >= 0 ? '+' : ''}${revenueGrowth.toFixed(1)}%
                        </span>
                    </div>
                    <div class="business-metric">
                        <span class="metric-label">Ordini questo mese:</span>
                        <span class="metric-value metric-neutral">${currentOrders}</span>
                    </div>
                    <div class="business-metric">
                        <span class="metric-label">Crescita ordini:</span>
                        <span class="metric-value ${orderGrowth >= 0 ? 'metric-positive' : 'metric-negative'}">
                            ${orderGrowth >= 0 ? '+' : ''}${orderGrowth.toFixed(1)}%
                        </span>
                    </div>
                </div>
            `;

            container.innerHTML = html;
        }

        function generateKPIDashboard() {
            const container = document.getElementById('kpiDashboard');
            if (!container) return;

            const totalRevenue = appData.transactions
                .filter(t => t.type === 'revenue')
                .reduce((sum, t) => sum + (parseFloat(t.amount) || 0), 0);

            const totalExpenses = appData.transactions
                .filter(t => t.type === 'expense')
                .reduce((sum, t) => sum + (parseFloat(t.amount) || 0), 0);

            const completedOrders = appData.orders.filter(o => o.status === 'completed').length;
            const totalOrders = appData.orders.length;
            const completionRate = totalOrders > 0 ? (completedOrders / totalOrders * 100) : 0;

            const activeClients = new Set(
                appData.transactions
                    .filter(t => {
                        const transactionDate = new Date(t.transaction_date || t.created_at);
                        const thirtyDaysAgo = new Date();
                        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                        return transactionDate >= thirtyDaysAgo;
                    })
                    .map(t => t.client)
                    .filter(client => client)
            ).size;

            const avgOrderValue = totalOrders > 0 ? totalRevenue / totalOrders : 0;

            const html = `
                <div class="grid grid-2">
                    <div class="stat-box" style="background: var(--gradient-primary);">
                        <div class="stat-value">${completionRate.toFixed(1)}%</div>
                        <div class="stat-label">Tasso Completamento</div>
                    </div>
                    <div class="stat-box" style="background: var(--gradient-secondary);">
                        <div class="stat-value">${activeClients}</div>
                        <div class="stat-label">Clienti Attivi</div>
                    </div>
                    <div class="stat-box" style="background: linear-gradient(135deg, var(--success), var(--success-light));">
                        <div class="stat-value">${formatCurrency(avgOrderValue)}</div>
                        <div class="stat-label">Valore Medio Ordine</div>
                    </div>
                    <div class="stat-box" style="background: linear-gradient(135deg, var(--warning), var(--warning-light));">
                        <div class="stat-value">${appData.inventory.filter(i => i.quantity <= (i.threshold || 5)).length}</div>
                        <div class="stat-label">Articoli Scorte Basse</div>
                    </div>
                </div>
            `;

            container.innerHTML = html;
        }

        // ===== UTILITY FUNCTIONS =====
        function checkLowStock() {
            const lowStockItems = appData.inventory.filter(item => 
                item.quantity <= (item.threshold || 5)
            );

            if (lowStockItems.length === 0) {
                showMessage('✅ Tutte le scorte sono sufficienti!');
            } else {
                const itemNames = lowStockItems.map(item => item.item_name).join(', ');
                showMessage(`⚠️ ${lowStockItems.length} componenti hanno scorte basse: ${itemNames}`, 'error');
                
                // Switch to inventory page to show low stock items
                showPage('inventory');
            }
        }

        function showOrdersAnalytics() {
            showMessage('Analisi ordini in sviluppo - Presto disponibile!');
        }

        function showTransactionAnalytics() {
            showMessage('Analisi transazioni in sviluppo - Presto disponibile!');
        }

        function showClientAnalytics() {
            showMessage('Analisi clienti in sviluppo - Presto disponibile!');
        }

        // ===== INITIALIZATION =====
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('🚀 RetroAvia 4.2 Enterprise starting...');

            // Initialize network monitoring
            initializeNetworkMonitoring();

            // Load data from localStorage first
            loadDataFromLocalStorage();
            
            // Update UI with local data
            updateDashboard();
            showPage('dashboard');

            // Try to initialize Supabase connection
            const connected = await initializeSupabase();
            
            if (connected) {
                // Sync data if connected
                setTimeout(syncData, 1000);
            } else {
                // Show offline message
                showMessage('🔴 Modalità offline - I dati verranno sincronizzati quando torni online', 'error');
            }

            // Setup modal close handlers
            window.addEventListener('click', (e) => {
                const modal = document.getElementById('modal');
                const confirmDialog = document.getElementById('confirmDialog');
                const calendarDayView = document.getElementById('calendarDayView');
                
                if (e.target === modal) {
                    closeModal();
                }
                if (e.target === confirmDialog) {
                    confirmDialog.classList.remove('active');
                }
                if (e.target === calendarDayView) {
                    closeCalendarDayView();
                }
            });

            // Setup keyboard handlers
            window.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    const modal = document.getElementById('modal');
                    const confirmDialog = document.getElementById('confirmDialog');
                    const calendarDayView = document.getElementById('calendarDayView');
                    
                    if (modal?.classList.contains('active')) {
                        closeModal();
                    } else if (confirmDialog?.classList.contains('active')) {
                        confirmDialog.classList.remove('active');
                    } else if (calendarDayView?.classList.contains('active')) {
                        closeCalendarDayView();
                    }
                }
            });

            console.log('✅ RetroAvia 4.2 Enterprise initialized successfully');
        });

        // ===== PERFORMANCE OPTIMIZATIONS =====
        
        // Debounce function for search
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Optimize search with debouncing
        function optimizedSetupSearch(searchInputId, containerId, dataArray, formatFunction) {
            const searchInput = document.getElementById(searchInputId);
            if (!searchInput) return;

            const debouncedSearch = debounce((query) => {
                if (query === '') {
                    switch(containerId) {
                        case 'ordersContainer':
                            loadOrdersPage();
                            break;
                        case 'transactionsContainer':
                            loadTransactionsPage();
                            break;
                        case 'clientsContainer':
                            loadClientsPage();
                            break;
                        case 'inventoryContainer':
                            loadInventoryPage();
                            break;
                    }
                } else {
                    const filteredData = dataArray.filter(item => 
                        formatFunction(item).toLowerCase().includes(query)
                    );
                    displaySearchResults(containerId, filteredData, formatFunction);
                }
            }, 300);

            searchInput.addEventListener('input', (e) => {
                const query = e.target.value.toLowerCase().trim();
                debouncedSearch(query);
            });
        }

        // ===== DATA INTEGRITY CHECKS =====
        
        function validateDataIntegrity() {
            try {
                // Check for duplicate IDs
                const allIds = [
                    ...appData.orders.map(item => item.id),
                    ...appData.transactions.map(item => item.id),
                    ...appData.clients.map(item => item.id),
                    ...appData.inventory.map(item => item.id)
                ];
                
                const uniqueIds = new Set(allIds);
                if (allIds.length !== uniqueIds.size) {
                    console.warn('⚠️ Duplicate IDs detected - cleaning up...');
                    cleanupDuplicateIds();
                }

                // Validate required fields
                appData.orders.forEach(order => {
                    if (!order.client_name || !order.specs) {
                        console.warn('⚠️ Invalid order detected:', order.id);
                    }
                });

                appData.transactions.forEach(transaction => {
                    if (!transaction.type || !transaction.amount || !transaction.description) {
                        console.warn('⚠️ Invalid transaction detected:', transaction.id);
                    }
                });

                appData.clients.forEach(client => {
                    if (!client.client_name) {
                        console.warn('⚠️ Invalid client detected:', client.id);
                    }
                });

                appData.inventory.forEach(item => {
                    if (!item.item_name || item.quantity === undefined) {
                        console.warn('⚠️ Invalid inventory item detected:', item.id);
                    }
                });

                console.log('✅ Data integrity check completed');
                return true;
            } catch (error) {
                console.error('❌ Data integrity check failed:', error);
                return false;
            }
        }

        function cleanupDuplicateIds() {
            const seenIds = new Set();
            
            // Clean orders
            appData.orders = appData.orders.filter(item => {
                if (seenIds.has(item.id)) {
                    return false;
                }
                seenIds.add(item.id);
                return true;
            });

            // Clean transactions
            appData.transactions = appData.transactions.filter(item => {
                if (seenIds.has(item.id)) {
                    return false;
                }
                seenIds.add(item.id);
                return true;
            });

            // Clean clients
            appData.clients = appData.clients.filter(item => {
                if (seenIds.has(item.id)) {
                    return false;
                }
                seenIds.add(item.id);
                return true;
            });

            // Clean inventory
            appData.inventory = appData.inventory.filter(item => {
                if (seenIds.has(item.id)) {
                    return false;
                }
                seenIds.add(item.id);
                return true;
            });

            saveDataToLocalStorage();
            console.log('✅ Duplicate IDs cleaned up');
        }

        // ===== ENHANCED ERROR HANDLING =====
        
        window.addEventListener('error', (event) => {
            console.error('Global error:', event.error);
            showMessage('Si è verificato un errore. L\'app continua a funzionare.', 'error');
        });

        window.addEventListener('unhandledrejection', (event) => {
            console.error('Unhandled promise rejection:', event.reason);
            // Prevent the default handling (which would log the error to console)
            event.preventDefault();
        });

        // ===== ENHANCED NOTIFICATIONS =====
        
        function showEnhancedNotification(title, message, type = 'info', duration = 4000) {
            // Create notification element if it doesn't exist
            let notificationContainer = document.getElementById('notification-container');
            if (!notificationContainer) {
                notificationContainer = document.createElement('div');
                notificationContainer.id = 'notification-container';
                notificationContainer.style.cssText = `
                    position: fixed;
                    top: var(--spacing-lg);
                    right: var(--spacing-lg);
                    z-index: 10000;
                    max-width: 400px;
                    pointer-events: none;
                `;
                document.body.appendChild(notificationContainer);
            }

            const notification = document.createElement('div');
            notification.style.cssText = `
                background: var(--gradient-glass);
                border: 1px solid var(--${type === 'error' ? 'error' : type === 'success' ? 'success' : 'info'});
                border-radius: var(--border-radius-lg);
                padding: var(--spacing-lg);
                margin-bottom: var(--spacing-sm);
                box-shadow: var(--shadow-lg);
                backdrop-filter: blur(20px);
                transform: translateX(100%);
                transition: transform 0.3s ease;
                pointer-events: auto;
                position: relative;
            `;

            notification.innerHTML = `
                <div style="display: flex; align-items: flex-start; gap: var(--spacing-sm);">
                    <div style="font-size: 1.2rem;">
                        ${type === 'success' ? '✅' : type === 'error' ? '❌' : type === 'warning' ? '⚠️' : 'ℹ️'}
                    </div>
                    <div style="flex: 1;">
                        <div style="font-weight: 600; color: var(--text-primary); margin-bottom: var(--spacing-xs);">${title}</div>
                        <div style="color: var(--text-secondary); font-size: 0.875rem;">${message}</div>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" style="
                        background: none;
                        border: none;
                        color: var(--text-muted);
                        cursor: pointer;
                        padding: var(--spacing-xs);
                        border-radius: var(--border-radius);
                        transition: color 0.2s ease;
                    " onmouseover="this.style.color = 'var(--text-primary)'" onmouseout="this.style.color = 'var(--text-muted)'">×</button>
                </div>
            `;

            notificationContainer.appendChild(notification);

            // Animate in
            setTimeout(() => {
                notification.style.transform = 'translateX(0)';
            }, 100);

            // Auto remove
            setTimeout(() => {
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (notification.parentElement) {
                        notification.remove();
                    }
                }, 300);
            }, duration);
        }

        // ===== KEYBOARD SHORTCUTS =====
        
        function initializeKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                // Only trigger if not in an input field
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') {
                    return;
                }

                // Ctrl/Cmd + shortcuts
                if (e.ctrlKey || e.metaKey) {
                    switch (e.key) {
                        case 's':
                            e.preventDefault();
                            syncData();
                            showEnhancedNotification('Sincronizzazione', 'Avviata sincronizzazione dati', 'info');
                            break;
                        case 'e':
                            e.preventDefault();
                            exportBackup();
                            break;
                        case 'n':
                            e.preventDefault();
                            if (appData.currentPage === 'orders') {
                                openQuickOrder();
                            } else if (appData.currentPage === 'transactions') {
                                openQuickSale();
                            } else if (appData.currentPage === 'clients') {
                                openQuickClient();
                            } else if (appData.currentPage === 'inventory') {
                                openQuickInventory();
                            }
                            break;
                    }
                }

                // Number keys for page navigation
                if (e.key >= '1' && e.key <= '7' && !e.ctrlKey && !e.metaKey && !e.altKey) {
                    const pages = ['dashboard', 'orders', 'transactions', 'clients', 'inventory', 'calendar', 'analytics'];
                    const pageIndex = parseInt(e.key) - 1;
                    if (pageIndex < pages.length) {
                        showPage(pages[pageIndex]);
                    }
                }
            });
        }

        // ===== AUTO-SAVE FUNCTIONALITY =====
        
        let autoSaveInterval;
        
        function startAutoSave() {
            // Auto-save every 5 minutes
            autoSaveInterval = setInterval(() => {
                if (appData.connected && appData.syncQueue.length > 0) {
                    console.log('🔄 Auto-sync triggered...');
                    processSyncQueue();
                }
            }, 5 * 60 * 1000);
        }

        function stopAutoSave() {
            if (autoSaveInterval) {
                clearInterval(autoSaveInterval);
                autoSaveInterval = null;
            }
        }

        // ===== ENHANCED CALENDAR INTEGRATION =====
        
        function getCalendarEventColor(type, status = null) {
            if (type === 'order') {
                switch (status) {
                    case 'pending': return '#f59e0b';
                    case 'in-progress': return '#3b82f6';
                    case 'completed': return '#10b981';
                    case 'cancelled': return '#ef4444';
                    default: return '#f59e0b';
                }
            } else if (type === 'transaction-revenue') {
                return '#10b981';
            } else if (type === 'transaction-expense') {
                return '#ef4444';
            }
            return '#6b7280';
        }

        // ===== BUSINESS INTELLIGENCE ENHANCEMENTS =====
        
        function generateBusinessInsights() {
            const insights = [];
            
            // Revenue trend analysis
            const last3Months = [];
            for (let i = 2; i >= 0; i--) {
                const date = new Date();
                date.setMonth(date.getMonth() - i);
                const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                
                const monthRevenue = appData.transactions
                    .filter(t => t.type === 'revenue' && (t.transaction_date || t.created_at).startsWith(monthKey))
                    .reduce((sum, t) => sum + (parseFloat(t.amount) || 0), 0);
                
                last3Months.push(monthRevenue);
            }

            if (last3Months.length >= 3) {
                const trend = last3Months[2] - last3Months[0];
                if (trend > 0) {
                    insights.push(`📈 Trend positivo: le entrate sono cresciute di ${formatCurrency(trend)} negli ultimi 3 mesi`);
                } else if (trend < 0) {
                    insights.push(`📉 Attenzione: le entrate sono diminuite di ${formatCurrency(Math.abs(trend))} negli ultimi 3 mesi`);
                }
            }

            // Client retention analysis
            const uniqueClients = new Set(appData.transactions.filter(t => t.type === 'revenue').map(t => t.client));
            const repeatClients = [];
            
            uniqueClients.forEach(client => {
                const clientTransactions = appData.transactions.filter(t => t.client === client && t.type === 'revenue');
                if (clientTransactions.length > 1) {
                    repeatClients.push(client);
                }
            });

            const retentionRate = uniqueClients.size > 0 ? (repeatClients.length / uniqueClients.size * 100) : 0;
            if (retentionRate > 50) {
                insights.push(`🎯 Ottima fidelizzazione: ${retentionRate.toFixed(1)}% dei clienti effettua acquisti ripetuti`);
            } else if (retentionRate < 25) {
                insights.push(`⚠️ Bassa fidelizzazione: solo ${retentionRate.toFixed(1)}% dei clienti torna`);
            }

            // Inventory optimization
            const lowStockValue = appData.inventory
                .filter(item => item.quantity <= (item.threshold || 5))
                .reduce((sum, item) => sum + ((item.price || 0) * item.quantity), 0);

            if (lowStockValue > 0) {
                insights.push(`📦 Valore scorte basse: ${formatCurrency(lowStockValue)} di inventario da riordinare`);
            }

            return insights;
        }

        // ===== ADVANCED SEARCH AND FILTERS =====
        
        function initializeAdvancedFilters() {
            // This would implement advanced filtering functionality
            // For now, we'll keep the existing search functionality
            console.log('Advanced filters initialized');
        }

        // ===== ENHANCED INITIALIZATION =====
        
        // Override the previous initialization to include new features
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('🚀 RetroAvia 4.2 Enterprise - Enhanced Edition starting...');

            try {
                // Initialize all components
                initializeNetworkMonitoring();
                initializeKeyboardShortcuts();
                initializeAdvancedFilters();

                // Load and validate data
                loadDataFromLocalStorage();
                validateDataIntegrity();
                
                // Update UI
                updateDashboard();
                showPage('dashboard');

                // Start auto-save
                startAutoSave();

                // Try to connect to Supabase
                const connected = await initializeSupabase();
                
                if (connected) {
                    setTimeout(syncData, 1000);
                    showEnhancedNotification(
                        'Sistema Connesso', 
                        'RetroAvia è online e pronto all\'uso', 
                        'success'
                    );
                } else {
                    showEnhancedNotification(
                        'Modalità Offline', 
                        'I dati verranno sincronizzati quando torni online', 
                        'warning',
                        6000
                    );
                }

                // Setup event listeners
                setupGlobalEventListeners();

                console.log('✅ RetroAvia 4.2 Enterprise initialized successfully');
                
                // Show welcome notification
                setTimeout(() => {
                    showEnhancedNotification(
                        'Benvenuto in RetroAvia 4.2',
                        'Sistema Enterprise completamente operativo',
                        'info'
                    );
                }, 1000);

            } catch (error) {
                console.error('❌ Initialization failed:', error);
                showMessage('Errore durante l\'inizializzazione. Ricarica la pagina.', 'error');
            }
        });

        function setupGlobalEventListeners() {
            // Modal close handlers
            window.addEventListener('click', (e) => {
                const modal = document.getElementById('modal');
                const confirmDialog = document.getElementById('confirmDialog');
                const calendarDayView = document.getElementById('calendarDayView');
                
                if (e.target === modal) closeModal();
                if (e.target === confirmDialog) confirmDialog.classList.remove('active');
                if (e.target === calendarDayView) closeCalendarDayView();
            });

            // Escape key handler
            window.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    const modal = document.getElementById('modal');
                    const confirmDialog = document.getElementById('confirmDialog');
                    const calendarDayView = document.getElementById('calendarDayView');
                    
                    if (modal?.classList.contains('active')) {
                        closeModal();
                    } else if (confirmDialog?.classList.contains('active')) {
                        confirmDialog.classList.remove('active');
                    } else if (calendarDayView?.classList.contains('active')) {
                        closeCalendarDayView();
                    }
                }
            });

            // Prevent accidental page refresh
            window.addEventListener('beforeunload', (e) => {
                if (appData.syncQueue.length > 0) {
                    e.preventDefault();
                    e.returnValue = 'Ci sono dati non sincronizzati. Sei sicuro di voler uscire?';
                }
            });

            // Handle visibility change (tab switching)
            document.addEventListener('visibilitychange', () => {
                if (!document.hidden && appData.connected && appData.syncQueue.length > 0) {
                    // Try to sync when tab becomes visible again
                    setTimeout(processSyncQueue, 1000);
                }
            });
        }

        // ===== UTILITY FUNCTIONS FOR ENHANCED FEATURES =====
        
        function formatRelativeTime(date) {
            const now = new Date();
            const diffInSeconds = Math.floor((now - date) / 1000);
            
            if (diffInSeconds < 60) return 'Pochi secondi fa';
            if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)} minuti fa`;
            if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)} ore fa`;
            if (diffInSeconds < 604800) return `${Math.floor(diffInSeconds / 86400)} giorni fa`;
            
            return date.toLocaleDateString('it-IT');
        }

        function generateReportSummary() {
            const summary = {
                totalRevenue: appData.transactions.filter(t => t.type === 'revenue').reduce((sum, t) => sum + parseFloat(t.amount || 0), 0),
                totalExpenses: appData.transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + parseFloat(t.amount || 0), 0),
                totalOrders: appData.orders.length,
                activeClients: appData.clients.length,
                lowStockItems: appData.inventory.filter(item => item.quantity <= (item.threshold || 5)).length,
                completionRate: appData.orders.length > 0 ? (appData.orders.filter(o => o.status === 'completed').length / appData.orders.length * 100) : 0
            };
            
            summary.netProfit = summary.totalRevenue - summary.totalExpenses;
            summary.profitMargin = summary.totalRevenue > 0 ? (summary.netProfit / summary.totalRevenue * 100) : 0;
            
            return summary;
        }

        // ===== CLEANUP AND MEMORY MANAGEMENT =====
        
        window.addEventListener('unload', () => {
            stopAutoSave();
            console.log('👋 RetroAvia shutting down gracefully');
        });

        // ===== GLOBAL HELPER FOR DEBUGGING =====
        
        window.RetroAvia = {
            version: '4.2',
            data: appData,
            sync: syncData,
            export: exportBackup,
            validate: validateDataIntegrity,
            insights: generateBusinessInsights,
            summary: generateReportSummary
        };

        console.log('🎯 RetroAvia 4.2 Enterprise - All systems ready!');
    </script>
</body>
</html>
