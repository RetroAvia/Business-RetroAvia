<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RetroAvia 4.2 - Game Boy Business Manager</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' https:; frame-ancestors 'none';">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="Cache-Control" content="public, max-age=31536000">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary: #3b82f6;
            --primary-dark: #1e40af;
            --secondary: #10b981;
            --accent: #f59e0b;
            --accent-dark: #d97706;
            --bg-primary: #0f0f23;
            --bg-secondary: #1a1b3c;
            --bg-tertiary: #252647;
            --surface: #2d2f52;
            --surface-elevated: #363862;
            --text-primary: #ffffff;
            --text-secondary: #e2e8f0;
            --text-muted: #94a3b8;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --info: #3b82f6;
            --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-secondary: linear-gradient(135deg, #667eea 0%, #4338ca 100%);
            --gradient-card: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%);
            --gradient-surface: linear-gradient(135deg, var(--surface) 0%, var(--surface-elevated) 100%);
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --shadow-2xl: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            --radius-sm: 0.375rem;
            --radius-md: 0.5rem;
            --radius-lg: 1rem;
            --radius-xl: 1.5rem;
            --radius-2xl: 2rem;
            --space-1: 0.25rem;
            --space-2: 0.5rem;
            --space-3: 0.75rem;
            --space-4: 1rem;
            --space-5: 1.25rem;
            --space-6: 1.5rem;
            --space-8: 2rem;
            --space-10: 2.5rem;
            --space-12: 3rem;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: radial-gradient(ellipse at top, rgba(59, 130, 246, 0.15) 0%, transparent 70%), 
                        radial-gradient(ellipse at bottom right, rgba(16, 185, 129, 0.1) 0%, transparent 70%),
                        var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: var(--space-6);
        }
        
        .header {
            text-align: center;
            margin-bottom: var(--space-8);
            position: relative;
        }
        
        .logo {
            font-family: 'Orbitron', monospace;
            font-size: clamp(2rem, 5vw, 3.5rem);
            font-weight: 900;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: var(--space-2);
            animation: logoGlow 4s ease-in-out infinite alternate;
            position: relative;
        }
        
        .logo::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--gradient-primary);
            opacity: 0.1;
            filter: blur(20px);
            animation: logoGlow 4s ease-in-out infinite alternate;
            z-index: -1;
        }
        
        @keyframes logoGlow {
            0% { filter: drop-shadow(0 0 20px rgba(59, 130, 246, 0.5)); }
            100% { filter: drop-shadow(0 0 40px rgba(102, 126, 234, 0.8)); }
        }
        
        .subtitle {
            font-size: 1.125rem;
            color: var(--text-muted);
            font-weight: 500;
            margin-bottom: var(--space-4);
        }
        
        .version-badge {
            display: inline-flex;
            align-items: center;
            gap: var(--space-2);
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: var(--space-2) var(--space-4);
            border-radius: var(--radius-xl);
            font-size: 0.875rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            box-shadow: var(--shadow-lg);
        }
        
        .connection-status {
            position: absolute;
            top: var(--space-4);
            right: var(--space-4);
            display: flex;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-2) var(--space-3);
            background: var(--gradient-surface);
            border-radius: var(--radius-lg);
            font-size: 0.875rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }
        
        .connection-status.connected {
            border-color: var(--success);
            box-shadow: 0 0 10px rgba(16, 185, 129, 0.3);
        }
        
        .connection-status.disconnected {
            border-color: var(--error);
            box-shadow: 0 0 10px rgba(239, 68, 68, 0.3);
        }
        
        .connection-status.syncing {
            border-color: var(--warning);
            box-shadow: 0 0 10px rgba(245, 158, 11, 0.3);
        }
        
        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        .status-indicator.connected {
            background: var(--success);
        }
        
        .status-indicator.disconnected {
            background: var(--error);
        }
        
        .status-indicator.syncing {
            background: var(--warning);
            animation: syncPulse 1s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        @keyframes syncPulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.2); }
        }
        
        .nav {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: var(--space-3);
            margin: var(--space-8) 0;
            padding: var(--space-6);
            background: var(--gradient-card);
            border-radius: var(--radius-2xl);
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            box-shadow: var(--shadow-2xl);
            position: relative;
            overflow: hidden;
        }
        
        .nav::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
        }
        
        .nav-btn {
            background: var(--gradient-surface);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--text-secondary);
            padding: var(--space-3) var(--space-5);
            border-radius: var(--radius-lg);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            display: flex;
            align-items: center;
            gap: var(--space-2);
            position: relative;
            overflow: hidden;
        }
        
        .nav-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transition: left 0.5s ease;
        }
        
        .nav-btn:hover::before {
            left: 100%;
        }
        
        .nav-btn:hover, .nav-btn:focus {
            transform: translateY(-2px) scale(1.02);
            border-color: var(--primary);
            color: var(--text-primary);
            outline: none;
            box-shadow: var(--shadow-lg);
        }
        
        .nav-btn.active {
            background: var(--gradient-primary);
            color: white;
            transform: translateY(-2px) scale(1.02);
            box-shadow: var(--shadow-xl);
        }
        
        .page {
            display: none;
            animation: fadeInUp 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .page.active {
            display: block;
        }
        
        @keyframes fadeInUp {
            from { 
                opacity: 0; 
                transform: translateY(30px) scale(0.95); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0) scale(1); 
            }
        }
        
        .card {
            background: var(--gradient-card);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--radius-2xl);
            padding: var(--space-8);
            margin: var(--space-6) 0;
            box-shadow: var(--shadow-xl);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
        }
        
        .card:hover {
            transform: translateY(-4px) scale(1.01);
            border-color: rgba(255, 255, 255, 0.2);
            box-shadow: var(--shadow-2xl);
        }
        
        .card h3 {
            font-family: 'Orbitron', monospace;
            font-size: 1.5rem;
            margin-bottom: var(--space-6);
            color: var(--accent);
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: var(--space-4);
        }
        
        .grid {
            display: grid;
            gap: var(--space-6);
        }
        
        .grid-2 {
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
        }
        
        .grid-3 {
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        }
        
        .grid-4 {
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        }
        
        .stat-box {
            background: var(--gradient-primary);
            border-radius: var(--radius-2xl);
            padding: var(--space-8);
            text-align: center;
            color: white;
            font-weight: 700;
            box-shadow: var(--shadow-xl);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            cursor: pointer;
        }
        
        .stat-box:hover {
            transform: scale(1.05) translateY(-8px);
            box-shadow: var(--shadow-2xl);
        }
        
        .stat-box::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent 30%, rgba(255,255,255,0.15) 50%, transparent 70%);
            transform: translateX(-100%);
            transition: transform 0.6s;
        }
        
        .stat-box:hover::before {
            transform: translateX(100%);
        }
        
        .stat-value {
            font-family: 'Orbitron', monospace;
            font-size: clamp(1.5rem, 4vw, 2.5rem);
            font-weight: 900;
            margin-bottom: var(--space-2);
            position: relative;
            z-index: 1;
        }
        
        .stat-label {
            font-size: 0.875rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            opacity: 0.9;
            position: relative;
            z-index: 1;
        }
        
        .btn {
            display: inline-flex;
            align-items: center;
            gap: var(--space-2);
            background: var(--gradient-primary);
            border: none;
            color: white;
            padding: var(--space-3) var(--space-5);
            border-radius: var(--radius-lg);
            cursor: pointer;
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            margin: var(--space-2);
            text-decoration: none;
            position: relative;
            overflow: hidden;
            box-shadow: var(--shadow-md);
        }
        
        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s ease;
        }
        
        .btn:hover::before {
            left: 100%;
        }
        
        .btn:hover, .btn:focus {
            transform: translateY(-2px) scale(1.02);
            outline: none;
            box-shadow: var(--shadow-xl);
        }
        
        .btn:active {
            transform: translateY(0) scale(0.98);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-success { background: linear-gradient(135deg, var(--success), #059669); }
        .btn-warning { background: linear-gradient(135deg, var(--warning), #d97706); }
        .btn-error { background: linear-gradient(135deg, var(--error), #dc2626); }
        .btn-info { background: linear-gradient(135deg, var(--info), #1e40af); }
        .btn-secondary { 
            background: var(--gradient-surface); 
            color: var(--text-secondary); 
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        /* Calendar Styles */
        .calendar-container {
            background: var(--gradient-card);
            border-radius: var(--radius-2xl);
            padding: var(--space-6);
            box-shadow: var(--shadow-xl);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-6);
            padding-bottom: var(--space-4);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .calendar-month {
            font-family: 'Orbitron', monospace;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent);
        }
        
        .calendar-nav {
            display: flex;
            gap: var(--space-2);
        }
        
        .calendar-nav-btn {
            width: 40px;
            height: 40px;
            border-radius: var(--radius-lg);
            background: var(--gradient-surface);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        
        .calendar-nav-btn:hover {
            background: var(--gradient-primary);
            transform: scale(1.1);
        }
        
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: var(--radius-lg);
            overflow: hidden;
        }
        
        .calendar-day-header {
            background: var(--surface);
            padding: var(--space-3);
            text-align: center;
            font-weight: 600;
            font-size: 0.875rem;
            color: var(--accent);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .calendar-day {
            background: var(--bg-secondary);
            min-height: 100px;
            padding: var(--space-2);
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            display: flex;
            flex-direction: column;
        }
        
        .calendar-day:hover {
            background: var(--surface);
        }
        
        .calendar-day.other-month {
            opacity: 0.3;
        }
        
        .calendar-day.today {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(102, 126, 234, 0.2));
            border: 1px solid var(--primary);
        }
        
        .calendar-day.selected {
            background: var(--gradient-primary);
            color: white;
        }
        
        .calendar-day-number {
            font-weight: 600;
            margin-bottom: var(--space-1);
            font-size: 0.875rem;
        }
        
        .calendar-event {
            background: var(--gradient-primary);
            color: white;
            padding: 1px var(--space-1);
            border-radius: var(--radius-sm);
            font-size: 0.75rem;
            margin-bottom: 1px;
            cursor: pointer;
            transition: all 0.2s ease;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .calendar-event.order {
            background: linear-gradient(135deg, var(--warning), var(--accent-dark));
        }
        
        .calendar-event.transaction-revenue {
            background: linear-gradient(135deg, var(--success), #059669);
        }
        
        .calendar-event.transaction-expense {
            background: linear-gradient(135deg, var(--error), #dc2626);
        }
        
        .calendar-event:hover {
            transform: scale(1.02);
            z-index: 10;
        }
        
        .calendar-day-view {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(10px);
        }
        
        .calendar-day-view.active {
            display: flex;
        }
        
        .calendar-day-content {
            background: var(--gradient-card);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: var(--radius-2xl);
            padding: var(--space-8);
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }
        
        /* Form Improvements */
        .form-group {
            margin: var(--space-5) 0;
        }
        
        .form-group label {
            display: block;
            margin-bottom: var(--space-2);
            color: var(--accent);
            font-weight: 600;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: var(--space-4);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--radius-lg);
            background: var(--surface);
            color: var(--text-primary);
            font-family: 'Inter', sans-serif;
            font-size: 1rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: var(--shadow-sm);
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15), var(--shadow-md);
            transform: scale(1.01);
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }
        
        .quick-actions {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-3);
            justify-content: center;
        }
        
        .ai-panel {
            background: linear-gradient(135deg, var(--bg-secondary), var(--bg-tertiary));
            border: 2px solid var(--accent);
            border-radius: var(--radius-2xl);
            padding: var(--space-8);
            margin: var(--space-6) 0;
            position: relative;
            box-shadow: 0 0 50px rgba(245, 158, 11, 0.2);
            overflow: hidden;
        }
        
        .ai-panel::before {
            content: 'SPIDER-AI NEURAL NETWORK';
            position: absolute;
            top: -15px;
            left: var(--space-6);
            background: var(--accent);
            color: var(--bg-primary);
            padding: var(--space-2) var(--space-4);
            border-radius: var(--radius-lg);
            font-family: 'Orbitron', monospace;
            font-weight: 700;
            font-size: 0.75rem;
            letter-spacing: 0.1em;
        }
        
        .ai-suggestions {
            margin: var(--space-6) 0;
            padding: var(--space-6);
            background: rgba(245, 158, 11, 0.1);
            border-radius: var(--radius-lg);
            border: 1px solid var(--accent);
            backdrop-filter: blur(10px);
        }
        
        .ai-suggestions p {
            margin: var(--space-2) 0;
            line-height: 1.6;
        }
        
        .message-box {
            padding: var(--space-6);
            border-radius: var(--radius-lg);
            margin: var(--space-6) 0;
            display: none;
            font-weight: 500;
            border: 1px solid;
            backdrop-filter: blur(10px);
            box-shadow: var(--shadow-lg);
        }
        
        .error-box {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.15), rgba(220, 38, 38, 0.15));
            color: #fecaca;
            border-color: var(--error);
        }
        
        .success-box {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(5, 150, 105, 0.15));
            color: #a7f3d0;
            border-color: var(--success);
        }
        
        .message-box.show {
            display: block;
            animation: slideInRight 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        @keyframes slideInRight {
            from { transform: translateX(100%) scale(0.95); opacity: 0; }
            to { transform: translateX(0) scale(1); opacity: 1; }
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(15px);
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: var(--gradient-card);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: var(--radius-2xl);
            padding: var(--space-8);
            max-width: 800px;
            width: 90%;
            position: relative;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: var(--shadow-2xl);
            animation: modalSlideIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        @keyframes modalSlideIn {
            from { transform: scale(0.95) translateY(-20px); opacity: 0; }
            to { transform: scale(1) translateY(0); opacity: 1; }
        }
        
        .close {
            position: absolute;
            top: var(--space-4);
            right: var(--space-4);
            font-size: 2rem;
            cursor: pointer;
            color: var(--error);
            transition: all 0.3s ease;
            background: none;
            border: none;
            padding: var(--space-2);
            border-radius: var(--radius-lg);
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .close:hover, .close:focus {
            color: white;
            background: var(--error);
            transform: rotate(90deg) scale(1.1);
            outline: none;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin: var(--space-6) 0;
            background: var(--gradient-surface);
            border-radius: var(--radius-lg);
            overflow: hidden;
            box-shadow: var(--shadow-lg);
        }
        
        .data-table th,
        .data-table td {
            padding: var(--space-4);
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .data-table th {
            background: var(--surface);
            color: var(--accent);
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.875rem;
            letter-spacing: 0.05em;
        }
        
        .data-table tr {
            transition: all 0.3s ease;
        }
        
        .data-table tr:hover {
            background: rgba(255, 255, 255, 0.05);
            transform: scale(1.01);
        }
        
        .search-box {
            width: 100%;
            max-width: 400px;
            margin: 0 auto var(--space-6);
            padding: var(--space-4);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--radius-lg);
            background: var(--surface);
            color: var(--text-primary);
            font-family: 'Inter', sans-serif;
            box-shadow: var(--shadow-md);
            transition: all 0.3s ease;
        }
        
        .search-box:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15), var(--shadow-lg);
            transform: scale(1.02);
        }
        
        .empty-state {
            text-align: center;
            padding: var(--space-10);
            color: var(--text-muted);
        }
        
        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: var(--space-4);
            opacity: 0.7;
        }

        /* Loading State */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Enhanced Status Badges */
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.375rem 0.75rem;
            border-radius: var(--radius-lg);
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            box-shadow: var(--shadow-sm);
            transition: all 0.3s ease;
        }

        .status-badge:hover {
            transform: scale(1.05);
            box-shadow: var(--shadow-md);
        }

        .status-pending {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.2), rgba(217, 119, 6, 0.2));
            color: var(--warning);
            border: 1px solid var(--warning);
        }

        .status-in-progress {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(30, 64, 175, 0.2));
            color: var(--primary);
            border: 1px solid var(--primary);
        }

        .status-completed {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(5, 150, 105, 0.2));
            color: var(--success);
            border: 1px solid var(--success);
        }

        .status-cancelled {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(220, 38, 38, 0.2));
            color: var(--error);
            border: 1px solid var(--error);
        }

        /* Confirmation Dialog */
        .confirm-dialog {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(15px);
        }

        .confirm-dialog.active {
            display: flex;
        }

        .confirm-content {
            background: var(--gradient-card);
            border: 2px solid var(--error);
            border-radius: var(--radius-2xl);
            padding: var(--space-8);
            max-width: 500px;
            width: 90%;
            text-align: center;
            box-shadow: var(--shadow-2xl);
            position: relative;
            animation: modalSlideIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .confirm-icon {
            font-size: 3rem;
            margin-bottom: var(--space-4);
        }

        .confirm-title {
            color: var(--error);
            font-family: 'Orbitron', monospace;
            font-size: 1.5rem;
            margin-bottom: var(--space-4);
        }

        .confirm-message {
            color: var(--text-secondary);
            margin-bottom: var(--space-6);
            line-height: 1.6;
        }

        .confirm-actions {
            display: flex;
            gap: var(--space-4);
            justify-content: center;
        }

        /* Form Grid */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: var(--space-4);
        }

        .form-grid-full {
            grid-column: 1 / -1;
        }

        /* Order details styling */
        .order-details {
            margin: var(--space-6) 0;
            padding: var(--space-6);
            background: var(--surface);
            border-radius: var(--radius-lg);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .order-details h4 {
            color: var(--primary);
            margin-bottom: var(--space-4);
            font-family: 'Orbitron', monospace;
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        .order-spec {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: var(--space-2) 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .order-spec:last-child {
            border-bottom: none;
        }

        .spec-label {
            color: var(--text-muted);
            font-weight: 600;
            min-width: 120px;
            flex-shrink: 0;
        }

        .spec-value {
            color: var(--text-primary);
            text-align: right;
            flex-grow: 1;
            margin-left: var(--space-4);
        }

        /* Chart styles */
        .chart-container {
            padding: var(--space-4);
        }

        .chart-bar {
            border-radius: var(--radius-sm);
            transition: all 0.3s ease;
            margin-bottom: var(--space-1);
        }

        .chart-bar:hover {
            transform: scale(1.02);
            box-shadow: var(--shadow-md);
        }

        /* File Input Styling */
        .file-input {
            position: relative;
            display: inline-block;
        }

        .file-input input[type="file"] {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .file-input-label {
            display: inline-flex;
            align-items: center;
            gap: var(--space-2);
            background: var(--gradient-surface);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--text-secondary);
            padding: var(--space-3) var(--space-5);
            border-radius: var(--radius-lg);
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .file-input-label:hover {
            background: var(--gradient-primary);
            color: white;
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        /* Sync Queue Indicator */
        .sync-queue {
            position: fixed;
            bottom: var(--space-4);
            right: var(--space-4);
            background: var(--gradient-card);
            border: 1px solid var(--warning);
            border-radius: var(--radius-lg);
            padding: var(--space-3);
            color: var(--warning);
            font-size: 0.875rem;
            display: none;
            align-items: center;
            gap: var(--space-2);
            box-shadow: var(--shadow-lg);
            z-index: 999;
        }

        .sync-queue.show {
            display: flex;
        }

        /* Responsive Improvements */
        @media (max-width: 768px) {
            .container { 
                padding: var(--space-4); 
            }
            
            .nav { 
                flex-direction: column; 
                gap: var(--space-2);
                padding: var(--space-4);
            }
            
            .nav-btn { 
                width: 100%; 
                justify-content: center;
            }
            
            .grid-2, .grid-3, .grid-4 { 
                grid-template-columns: 1fr; 
            }
            
            .card { 
                padding: var(--space-6); 
                margin: var(--space-4) 0;
            }
            
            .quick-actions {
                flex-direction: column;
                align-items: stretch;
            }
            
            .quick-actions .btn {
                width: 100%;
                justify-content: center;
                margin: var(--space-2) 0;
            }
            
            .data-table {
                font-size: 0.875rem;
            }
            
            .data-table th,
            .data-table td {
                padding: var(--space-3);
            }

            .calendar-day {
                min-height: 80px;
                padding: var(--space-1);
            }

            .calendar-event {
                font-size: 0.625rem;
                padding: 1px 2px;
            }
            
            .connection-status {
                position: relative;
                top: auto;
                right: auto;
                margin: var(--space-4) auto;
                width: fit-content;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .spec-label {
                min-width: 100px;
            }

            .order-spec {
                flex-direction: column;
                align-items: flex-start;
                gap: var(--space-1);
            }

            .spec-value {
                text-align: left;
                margin-left: 0;
                margin-top: var(--space-1);
            }
        }
        
        @media (max-width: 480px) {
            .modal-content {
                width: 95%;
                padding: var(--space-6);
            }
            
            .stat-value {
                font-size: 1.5rem;
            }
            
            .data-table {
                display: block;
                overflow-x: auto;
                white-space: nowrap;
            }

            .calendar-day {
                min-height: 60px;
            }

            .calendar-day-number {
                font-size: 0.75rem;
            }

            .calendar-event {
                font-size: 0.5rem;
                padding: 1px;
            }

            .confirm-content {
                width: 95%;
                padding: var(--space-6);
            }

            .confirm-actions {
                flex-direction: column;
            }
        }

        /* Enhanced Animations */
        @media (prefers-reduced-motion: no-preference) {
            .card, .btn, .nav-btn, .stat-box {
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            }
            
            .page.active {
                animation: fadeInUp 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            }
        }

        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="connection-status" id="connectionStatus">
                <div class="status-indicator" id="statusIndicator"></div>
                <span id="statusText">Connessione...</span>
            </div>
            <h1 class="logo">🕷️ RetroAvia</h1>
            <p class="subtitle">Advanced Game Boy Business Manager</p>
            <div class="version-badge">
                <span>⚡</span>
                Version 4.2 - Sync Fixed Edition
            </div>
        </header>
        
        <nav class="nav" role="navigation" aria-label="Main navigation">
            <button class="nav-btn active" onclick="showPage('dashboard')" aria-label="Dashboard">
                <span>📊</span> Dashboard
            </button>
            <button class="nav-btn" onclick="showPage('orders')" aria-label="Ordini">
                <span>📋</span> Ordini
            </button>
            <button class="nav-btn" onclick="showPage('transactions')" aria-label="Transazioni">
                <span>💰</span> Transazioni
            </button>
            <button class="nav-btn" onclick="showPage('clients')" aria-label="Clienti">
                <span>👤</span> Clienti
            </button>
            <button class="nav-btn" onclick="showPage('inventory')" aria-label="Inventario">
                <span>📦</span> Inventario
            </button>
            <button class="nav-btn" onclick="showPage('calendar')" aria-label="Calendario">
                <span>📅</span> Calendario
            </button>
            <button class="nav-btn" onclick="showPage('analytics')" aria-label="Analytics">
                <span>📈</span> Analytics
            </button>
        </nav>
        
        <div class="error-box message-box" id="errorBox" role="alert"></div>
        <div class="success-box message-box" id="successBox" role="status"></div>
        
        <!-- Sync Queue Indicator -->
        <div class="sync-queue" id="syncQueue">
            <div class="loading"></div>
            <span id="syncQueueText">Sincronizzazione in corso...</span>
        </div>
        
        <!-- Dashboard Page -->
        <div class="page active" id="dashboard" role="main">
            <div class="grid grid-4">
                <div class="stat-box">
                    <div class="stat-value" id="totalRevenue">€0</div>
                    <div class="stat-label">Guadagni Totali</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="totalExpenses">€0</div>
                    <div class="stat-label">Spese Totali</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="netProfit">€0</div>
                    <div class="stat-label">Profitto Netto</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="totalOrders">0</div>
                    <div class="stat-label">Ordini Totali</div>
                </div>
            </div>
            
            <div class="ai-panel">
                <h3>🧠 Spider-AI Neural Analysis</h3>
                <div class="ai-suggestions" id="aiSuggestions">
                    <p>• Benvenuto in RetroAvia 4.2! Sistema sync completamente riparato!</p>
                    <p>• Errori database risolti con schema standardizzato!</p>
                </div>
                <div class="quick-actions">
                    <button class="btn" onclick="runAIAnalysis()">
                        <span>🧠</span> Analizza Ora
                    </button>
                    <button class="btn btn-secondary" onclick="generatePredictions()">
                        <span>🔮</span> Predizioni AI
                    </button>
                    <button class="btn btn-info" onclick="syncData()">
                        <span>🔄</span> Sincronizza
                    </button>
                </div>
            </div>
            
            <div class="card">
                <h3><span>⚡</span> Azioni Rapide</h3>
                <div class="quick-actions">
                    <button class="btn btn-success" onclick="openQuickSale()">
                        <span>💰</span> Vendita Rapida
                    </button>
                    <button class="btn btn-warning" onclick="openQuickOrder()">
                        <span>📋</span> Nuovo Ordine
                    </button>
                    <button class="btn btn-warning" onclick="openQuickClient()">
                        <span>👤</span> Cliente Rapido
                    </button>
                    <button class="btn" onclick="openQuickInventory()">
                        <span>📦</span> Componente Rapido
                    </button>
                    <button class="btn btn-secondary" onclick="exportBackup()">
                        <span>💾</span> Esporta Backup
                    </button>
                    <button class="btn btn-secondary" onclick="showImportModal()">
                        <span>📂</span> Importa Backup
                    </button>
                </div>
            </div>
        </div>

        <!-- Calendar Page -->
        <div class="page" id="calendar" role="main">
            <div class="card">
                <h3><span>📅</span> Calendario Business</h3>
                <div class="calendar-container">
                    <div class="calendar-header">
                        <div class="calendar-month" id="calendarMonth">Gennaio 2025</div>
                        <div class="calendar-nav">
                            <button class="calendar-nav-btn" onclick="changeMonth(-1)" aria-label="Mese precedente">‹</button>
                            <button class="calendar-nav-btn" onclick="goToToday()" aria-label="Vai a oggi">📅</button>
                            <button class="calendar-nav-btn" onclick="changeMonth(1)" aria-label="Mese successivo">›</button>
                        </div>
                    </div>
                    <div class="calendar-grid" id="calendarGrid">
                        <!-- Calendar will be generated here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Calendar Day View Modal -->
        <div class="calendar-day-view" id="calendarDayView">
            <div class="calendar-day-content">
                <button class="close" onclick="closeCalendarDayView()" aria-label="Chiudi">&times;</button>
                <div id="calendarDayContent">
                    <!-- Day details will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Orders Page -->
        <div class="page" id="orders" role="main">
            <div class="card">
                <h3><span>📋</span> Gestione Ordini</h3>
                <div class="quick-actions">
                    <button class="btn btn-success" onclick="addOrder()">
                        <span>📋</span> Nuovo Ordine
                    </button>
                </div>
                <input type="text" class="search-box" id="orderSearch" placeholder="🔍 Cerca ordini..." aria-label="Cerca ordini">
                <div id="ordersContainer">
                    <!-- Orders will be loaded here -->
                </div>
            </div>
        </div>
        
        <!-- Transactions Page -->
        <div class="page" id="transactions" role="main">
            <div class="card">
                <h3><span>💰</span> Gestione Transazioni</h3>
                <div class="quick-actions">
                    <button class="btn btn-success" onclick="addTransaction('revenue')">
                        <span>💰</span> Nuova Entrata
                    </button>
                    <button class="btn btn-error" onclick="addTransaction('expense')">
                        <span>💸</span> Nuova Spesa
                    </button>
                </div>
                <input type="text" class="search-box" id="transactionSearch" placeholder="🔍 Cerca transazioni..." aria-label="Cerca transazioni">
                <div id="transactionsContainer">
                    <!-- Transactions will be loaded here -->
                </div>
            </div>
        </div>
        
        <!-- Clients Page -->
        <div class="page" id="clients" role="main">
            <div class="card">
                <h3><span>👤</span> Gestione Clienti</h3>
                <div class="quick-actions">
                    <button class="btn btn-success" onclick="addClient()">
                        <span>👤</span> Nuovo Cliente
                    </button>
                </div>
                <input type="text" class="search-box" id="clientSearch" placeholder="🔍 Cerca clienti..." aria-label="Cerca clienti">
                <div id="clientsContainer">
                    <!-- Clients will be loaded here -->
                </div>
            </div>
        </div>
        
        <!-- Inventory Page -->
        <div class="page" id="inventory" role="main">
            <div class="card">
                <h3><span>📦</span> Gestione Inventario</h3>
                <div class="quick-actions">
                    <button class="btn btn-success" onclick="addInventoryItem()">
                        <span>📦</span> Nuovo Componente
                    </button>
                </div>
                <input type="text" class="search-box" id="inventorySearch" placeholder="🔍 Cerca componenti..." aria-label="Cerca componenti">
                <div id="inventoryContainer">
                    <!-- Inventory will be loaded here -->
                </div>
            </div>
        </div>
        
        <!-- Analytics Page -->
        <div class="page" id="analytics" role="main">
            <div class="card">
                <h3><span>📈</span> Analytics Avanzate</h3>
                <div class="grid grid-2">
                    <div class="card">
                        <h4>📊 Trend Mensili (Ultimi 6 Mesi)</h4>
                        <div id="monthlyTrends" class="chart-container">
                            <!-- Monthly trends chart will be here -->
                        </div>
                    </div>
                    <div class="card">
                        <h4>🏆 Top Clienti</h4>
                        <div id="topClients">
                            <!-- Top clients will be here -->
                        </div>
                    </div>
                </div>
                
                <div class="grid grid-2">
                    <div class="card">
                        <h4>📈 Performance Mensile</h4>
                        <div id="monthlyPerformance">
                            <!-- Monthly performance metrics -->
                        </div>
                    </div>
                    <div class="card">
                        <h4>🎯 KPI Dashboard</h4>
                        <div id="kpiDashboard">
                            <!-- Key performance indicators -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Main Modal -->
    <div class="modal" id="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
        <div class="modal-content">
            <button class="close" onclick="closeModal()" aria-label="Chiudi finestra">&times;</button>
            <div id="modalContent"></div>
        </div>
    </div>

    <!-- Confirmation Dialog -->
    <div class="confirm-dialog" id="confirmDialog">
        <div class="confirm-content">
            <div class="confirm-icon">⚠️</div>
            <h3 class="confirm-title" id="confirmTitle">Conferma Eliminazione</h3>
            <p class="confirm-message" id="confirmMessage">Sei sicuro di voler procedere?</p>
            <div class="confirm-actions">
                <button class="btn btn-error" id="confirmYes">
                    <span>🗑️</span> Elimina
                </button>
                <button class="btn btn-secondary" id="confirmNo">
                    <span>❌</span> Annulla
                </button>
            </div>
        </div>
    </div>
    
    <script>
        // ===== SUPABASE CONFIGURATION =====
        const supabaseUrl = 'https://lzcphhnakmmimoglknon.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx6Y3BoaG5ha21taW1vZ2xrbm9uIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc2MDQxMTgsImV4cCI6MjA3MzE4MDExOH0.2hACcRIDxd9GbSq4_eq2_Stpn8yWyLf7YYY1xSzPTMU';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
        
        // ===== SCHEMA MAPPING =====
        const SCHEMA_MAPPING = {
            transactions: {
                id: 'id',
                type: 'type',
                amount: 'amount',
                description: 'description',
                transaction_date: 'transaction_date',
                client: 'client',
                created_at: 'created_at'
            },
            orders: {
                id: 'id',
                client_name: 'client_name',
                client_email: 'client_email',
                status: 'status',
                created_at: 'created_at',
                due_date: 'due_date',
                specs: 'specs'
            },
            clients: {
                id: 'id',
                client_name: 'client_name',
                client_email: 'client_email',
                client_phone: 'client_phone',
                client_source: 'client_source',
                total_spent: 'total_spent',
                created_at: 'created_at'
            },
            inventory: {
                id: 'id',
                item_name: 'item_name',
                quantity: 'quantity',
                threshold: 'threshold',
                price: 'price',
                supplier: 'supplier',
                created_at: 'created_at'
            }
        };
        
        // ===== GLOBAL STATE =====
        let appData = {
            orders: [],
            transactions: [],
            clients: [],
            inventory: [],
            editingId: null,
            currentPage: 'dashboard',
            version: '4.2',
            calendarDate: new Date(),
            connected: false,
            syncQueue: [],
            retryAttempts: 0,
            maxRetryAttempts: 3,
            isOnline: navigator.onLine,
            healthCheck: {
                lastCheck: null,
                status: 'unknown'
            }
        };
        
        // ===== UTILITY FUNCTIONS =====
        function formatCurrency(amount) {
            return new Intl.NumberFormat('it-IT', {
                style: 'currency',
                currency: 'EUR'
            }).format(parseFloat(amount || 0));
        }
        
        function generateId() {
            return 'id_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }
        
        function formatDate(date = new Date()) {
            if (date instanceof Date) {
                return date.toISOString().split('T')[0];
            }
            return date;
        }
        
        function formatDateTime(date = new Date()) {
            if (typeof date === 'string') {
                date = new Date(date);
            }
            return date.toISOString();
        }
        
        function showMessage(message, type = 'success') {
            const box = document.getElementById(type === 'error' ? 'errorBox' : 'successBox');
            if (!box) return;
            
            box.textContent = message;
            box.classList.add('show');
            
            setTimeout(() => {
                box.classList.remove('show');
            }, type === 'error' ? 6000 : 4000);
        }

        // ===== CONNECTION STATUS MANAGEMENT =====
        function updateConnectionStatus(status, text) {
            appData.connected = (status === 'connected');
            const statusEl = document.getElementById('connectionStatus');
            const indicatorEl = document.getElementById('statusIndicator');
            const textEl = document.getElementById('statusText');
            
            if (statusEl && indicatorEl && textEl) {
                statusEl.className = `connection-status ${status}`;
                indicatorEl.className = `status-indicator ${status}`;
                textEl.textContent = text || status;
            }
        }

        function showSyncQueue(text) {
            const queueEl = document.getElementById('syncQueue');
            const textEl = document.getElementById('syncQueueText');
            
            if (queueEl && textEl) {
                textEl.textContent = text;
                queueEl.classList.add('show');
            }
        }

        function hideSyncQueue() {
            const queueEl = document.getElementById('syncQueue');
            if (queueEl) {
                queueEl.classList.remove('show');
            }
        }

        // ===== DATA VALIDATION AND CLEANING =====
        function validateAndCleanData(table, data) {
            const schema = SCHEMA_MAPPING[table];
            if (!schema) {
                throw new Error(`Unknown table: ${table}`);
            }
            
            const cleaned = {};
            
            // Map and validate required fields
            Object.keys(schema).forEach(field => {
                const sourceField = schema[field];
                
                // Handle legacy field mapping
                let value = data[sourceField] || data[field];
                
                // Special handling for legacy fields
                if (field === 'transaction_date' && !value) {
                    value = data.date || data.transactionDate;
                }
                if (field === 'client_name' && !value) {
                    value = data.name || data.clientName;
                }
                if (field === 'client_email' && !value) {
                    value = data.email || data.clientEmail;
                }
                if (field === 'client_phone' && !value) {
                    value = data.phone || data.clientPhone;
                }
                if (field === 'client_source' && !value) {
                    value = data.source || data.clientSource;
                }
                if (field === 'total_spent' && !value) {
                    value = data.totalSpent;
                }
                if (field === 'item_name' && !value) {
                    value = data.name;
                }
                if (field === 'due_date' && !value) {
                    value = data.dueDate;
                }
                
                // Apply transformations
                if (value !== undefined && value !== null) {
                    switch (field) {
                        case 'amount':
                        case 'price':
                        case 'total_spent':
                            cleaned[field] = parseFloat(value) || 0;
                            break;
                        case 'quantity':
                        case 'threshold':
                            cleaned[field] = parseInt(value) || 0;
                            break;
                        case 'transaction_date':
                        case 'due_date':
                            // Ensure proper date format for Supabase
                            if (typeof value === 'string' && !value.includes('T')) {
                                cleaned[field] = value + 'T00:00:00.000Z';
                            } else {
                                cleaned[field] = value;
                            }
                            break;
                        case 'created_at':
                            if (!value) {
                                cleaned[field] = formatDateTime();
                            } else {
                                cleaned[field] = value;
                            }
                            break;
                        case 'specs':
                            // Ensure specs is an object
                            if (typeof value === 'string') {
                                try {
                                    cleaned[field] = JSON.parse(value);
                                } catch {
                                    cleaned[field] = {};
                                }
                            } else {
                                cleaned[field] = value || {};
                            }
                            break;
                        default:
                            cleaned[field] = value;
                    }
                }
            });
            
            // Ensure required fields
            if (!cleaned.id) {
                cleaned.id = generateId();
            }
            if (!cleaned.created_at) {
                cleaned.created_at = formatDateTime();
            }
            
            return cleaned;
        }

        // ===== ENHANCED RETRY MECHANISM =====
        async function retryOperation(operation, maxRetries = 3, delay = 1000, description = 'operation') {
            for (let attempt = 1; attempt <= maxRetries; attempt++) {
                try {
                    const result = await operation();
                    if (attempt > 1) {
                        console.log(`✅ ${description} succeeded on attempt ${attempt}`);
                    }
                    return result;
                } catch (error) {
                    console.warn(`⚠️ ${description} failed on attempt ${attempt}/${maxRetries}:`, error.message);
                    
                    if (attempt === maxRetries) {
                        throw error;
                    }
                    
                    // Exponential backoff with jitter
                    const jitter = Math.random() * 500;
                    const backoffDelay = (delay * Math.pow(2, attempt - 1)) + jitter;
                    await new Promise(resolve => setTimeout(resolve, Math.min(backoffDelay, 10000)));
                }
            }
        }

        // ===== HEALTH CHECK =====
        async function performHealthCheck() {
            try {
                updateConnectionStatus('syncing', 'Verifica salute...');
                console.log('🔍 Performing health check...');
                
                const healthCheckOp = async () => {
                    const { data, error, count } = await supabase
                        .from('transactions')
                        .select('id', { count: 'exact', head: true })
                        .limit(1);
                    
                    if (error) {
                        throw error;
                    }
                    
                    return { data, count };
                };
                
                const result = await retryOperation(healthCheckOp, 2, 1000, 'health check');
                
                appData.healthCheck = {
                    lastCheck: new Date(),
                    status: 'healthy',
                    transactionCount: result.count
                };
                
                console.log(`✅ Health check passed - ${result.count} transactions in database`);
                return true;
                
            } catch (error) {
                console.error('❌ Health check failed:', error);
                appData.healthCheck = {
                    lastCheck: new Date(),
                    status: 'unhealthy',
                    error: error.message
                };
                return false;
            }
        }

        // ===== ENHANCED SUPABASE FUNCTIONS =====
        async function initializeSupabase() {
            try {
                updateConnectionStatus('syncing', 'Inizializzazione...');
                console.log('🔌 Initializing Supabase connection...');
                
                const isHealthy = await performHealthCheck();
                
                if (isHealthy) {
                    updateConnectionStatus('connected', 'Connesso');
                    console.log('✅ Supabase initialized successfully');
                    
                    // Process any queued operations
                    await processSyncQueue();
                    
                    return true;
                } else {
                    throw new Error('Health check failed');
                }
                
            } catch (error) {
                console.error('❌ Supabase initialization failed:', error);
                updateConnectionStatus('disconnected', 'Offline');
                showMessage('Modalità offline - Dati salvati localmente', 'error');
                return false;
            }
        }

        async function saveToSupabase(table, data) {
            if (!appData.connected || !appData.isOnline) {
                // Add to sync queue for later
                appData.syncQueue.push({ action: 'upsert', table, data });
                console.log(`📝 Added to sync queue: ${table}`, data.id);
                throw new Error('Offline - added to queue');
            }

            // Clean and validate data according to schema
            const cleanData = validateAndCleanData(table, data);
            
            const saveOperation = async () => {
                console.log(`💾 Saving to ${table}:`, cleanData.id);

                const { data: result, error } = await supabase
                    .from(table)
                    .upsert(cleanData, { 
                        onConflict: 'id',
                        ignoreDuplicates: false 
                    })
                    .select();

                if (error) {
                    console.error(`❌ Supabase error for ${table}:`, error);
                    throw error;
                }
                
                console.log(`✅ Saved to ${table}:`, result?.[0]?.id);
                return result;
            };

            try {
                return await retryOperation(saveOperation, 3, 1000, `save to ${table}`);
            } catch (error) {
                // Add to sync queue for retry later
                appData.syncQueue.push({ action: 'upsert', table, data: cleanData });
                updateSyncQueueStatus();
                throw error;
            }
        }

        async function loadFromSupabase(table) {
            if (!appData.connected || !appData.isOnline) {
                console.log(`📥 Loading from ${table} not possible - offline`);
                return [];
            }

            const loadOperation = async () => {
                console.log(`📥 Loading from ${table}...`);

                const { data, error } = await supabase
                    .from(table)
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) {
                    console.error(`❌ Load error for ${table}:`, error);
                    throw error;
                }
                
                console.log(`✅ Loaded ${data?.length || 0} records from ${table}`);
                return data || [];
            };

            try {
                return await retryOperation(loadOperation, 3, 1000, `load from ${table}`);
            } catch (error) {
                console.error(`💥 Load failed for ${table}:`, error);
                return [];
            }
        }

        async function deleteFromSupabase(table, id) {
            if (!appData.connected || !appData.isOnline) {
                // Add to sync queue for later
                appData.syncQueue.push({ action: 'delete', table, id });
                console.log(`🗑️ Added to delete queue: ${table} ID:`, id);
                throw new Error('Offline - added to queue');
            }

            const deleteOperation = async () => {
                console.log(`🗑️ Deleting from ${table} ID:`, id);

                const { error } = await supabase
                    .from(table)
                    .delete()
                    .eq('id', id);

                if (error) {
                    console.error(`❌ Delete error for ${table}:`, error);
                    throw error;
                }
                
                console.log(`✅ Deleted from ${table} ID:`, id);
                return true;
            };

            try {
                return await retryOperation(deleteOperation, 3, 1000, `delete from ${table}`);
            } catch (error) {
                // Add to sync queue for retry later
                appData.syncQueue.push({ action: 'delete', table, id });
                updateSyncQueueStatus();
                throw error;
            }
        }

        // ===== SYNC QUEUE MANAGEMENT =====
        async function processSyncQueue() {
            if (!appData.connected || !appData.isOnline || appData.syncQueue.length === 0) {
                hideSyncQueue();
                return;
            }

            console.log(`🔄 Processing ${appData.syncQueue.length} queued operations...`);
            showSyncQueue(`Sincronizzando ${appData.syncQueue.length} operazioni...`);

            const queue = [...appData.syncQueue];
            appData.syncQueue = [];

            let successCount = 0;
            let errorCount = 0;

            for (const operation of queue) {
                try {
                    if (operation.action === 'upsert') {
                        await saveToSupabase(operation.table, operation.data);
                    } else if (operation.action === 'delete') {
                        await deleteFromSupabase(operation.table, operation.id);
                    }
                    successCount++;
                } catch (error) {
                    console.error('Sync queue error:', error);
                    // Re-add failed operations to queue
                    appData.syncQueue.push(operation);
                    errorCount++;
                }
            }

            console.log(`✅ Sync queue processed: ${successCount} successes, ${errorCount} errors`);
            
            if (successCount > 0) {
                showMessage(`✅ ${successCount} operazioni sincronizzate!`);
            }
            
            if (errorCount > 0) {
                showMessage(`⚠️ ${errorCount} operazioni rimaste in coda`, 'error');
                updateSyncQueueStatus();
            } else {
                hideSyncQueue();
            }
        }

        function updateSyncQueueStatus() {
            if (appData.syncQueue.length > 0) {
                showSyncQueue(`${appData.syncQueue.length} operazioni in attesa di sync`);
            } else {
                hideSyncQueue();
            }
        }

        async function syncData() {
            try {
                updateConnectionStatus('syncing', 'Sincronizzazione...');

                if (!appData.connected) {
                    // Try to reconnect
                    const connected = await initializeSupabase();
                    if (!connected) {
                        throw new Error('Connessione non disponibile');
                    }
                }

                showMessage('🔄 Sincronizzazione in corso...');

                // First, process any queued operations
                await processSyncQueue();

                // Then load fresh data from Supabase
                const results = await Promise.allSettled([
                    loadFromSupabase('orders'),
                    loadFromSupabase('transactions'),
                    loadFromSupabase('clients'),
                    loadFromSupabase('inventory')
                ]);

                // Process results with proper error handling
                const newOrders = results[0].status === 'fulfilled' ? results[0].value : appData.orders;
                const newTransactions = results[1].status === 'fulfilled' ? results[1].value : appData.transactions;
                const newClients = results[2].status === 'fulfilled' ? results[2].value : appData.clients;
                const newInventory = results[3].status === 'fulfilled' ? results[3].value : appData.inventory;

                // Only update if we got valid data
                if (Array.isArray(newOrders)) appData.orders = newOrders;
                if (Array.isArray(newTransactions)) appData.transactions = newTransactions;
                if (Array.isArray(newClients)) appData.clients = newClients;
                if (Array.isArray(newInventory)) appData.inventory = newInventory;

                // Check for failures
                const failures = results.filter(r => r.status === 'rejected');
                if (failures.length > 0) {
                    console.warn('⚠️ Some sync operations failed:', failures);
                    showMessage(`Sincronizzazione parziale (${failures.length} errori)`, 'error');
                } else {
                    showMessage('✅ Sincronizzazione completata!');
                }

                // Always save to localStorage as backup
                saveDataToLocalStorage();
                updateClientTotalSpent();

                // Refresh current page
                showPage(appData.currentPage);
                updateDashboard();

                updateConnectionStatus('connected', 'Connesso');

                console.log('📊 Data synced:', {
                    orders: appData.orders.length,
                    transactions: appData.transactions.length,
                    clients: appData.clients.length,
                    inventory: appData.inventory.length,
                    queueRemaining: appData.syncQueue.length
                });

            } catch (error) {
                console.error('💥 Sync error:', error);
                updateConnectionStatus('disconnected', 'Errore sync');
                showMessage('Errore nella sincronizzazione', 'error');
            }
        }

        // ===== NETWORK STATUS MONITORING =====
        function initializeNetworkMonitoring() {
            window.addEventListener('online', async () => {
                appData.isOnline = true;
                console.log('🌐 Internet connection restored');
                
                // Try to reconnect to Supabase
                await initializeSupabase();
                
                // Process sync queue if we have pending operations
                if (appData.syncQueue.length > 0) {
                    setTimeout(processSyncQueue, 1000);
                }
            });

            window.addEventListener('offline', () => {
                appData.isOnline = false;
                console.log('🌐 Internet connection lost');
                updateConnectionStatus('disconnected', 'Offline');
                showMessage('Modalità offline attivata', 'error');
            });
        }

        // ===== ENHANCED SAVE FUNCTIONS =====
        async function enhancedSave(table, data, localArray, successMessage) {
            try {
                // Always save locally first
                const index = appData.editingId ? 
                    localArray.findIndex(item => item.id === appData.editingId) : -1;
                
                if (appData.editingId && index !== -1) {
                    localArray[index] = data;
                } else {
                    localArray.push(data);
                }
                
                saveDataToLocalStorage();
                
                // Try to save to Supabase
                try {
                    await saveToSupabase(table, data);
                    showMessage(`✅ ${successMessage} e sincronizzato su cloud!`);
                } catch (error) {
                    console.warn('⚠️ Supabase save failed, saved locally:', error.message);
                    if (appData.connected) {
                        showMessage(`✅ ${successMessage} localmente (sync in corso...)`, 'error');
                    } else {
                        showMessage(`✅ ${successMessage} offline (sync automatico quando online)`, 'error');
                    }
                }
                
                return true;
            } catch (error) {
                console.error('Enhanced save error:', error);
                showMessage(`Errore nel salvataggio: ${error.message}`, 'error');
                return false;
            }
        }

        async function enhancedDelete(table, id, localArray, itemName) {
            try {
                const initialLength = localArray.length;
                const newArray = localArray.filter(item => item.id !== id);
                
                // Update local array
                localArray.length = 0;
                localArray.push(...newArray);
                
                saveDataToLocalStorage();
                
                // Try to delete from Supabase
                try {
                    await deleteFromSupabase(table, id);
                    showMessage(`✅ ${itemName} eliminato e sincronizzato!`);
                } catch (error) {
                    console.warn('⚠️ Supabase delete failed, deleted locally:', error.message);
                    if (appData.connected) {
                        showMessage(`✅ ${itemName} eliminato localmente (sync in corso...)`, 'error');
                    } else {
                        showMessage(`✅ ${itemName} eliminato offline (sync automatico quando online)`, 'error');
                    }
                }
                
                return newArray.length < initialLength;
            } catch (error) {
                console.error('Enhanced delete error:', error);
                showMessage(`Errore nell'eliminazione: ${error.message}`, 'error');
                return false;
            }
        }

        // ===== LOCAL STORAGE FUNCTIONS =====
        function saveDataToLocalStorage() {
            try {
                const dataToSave = {
                    orders: appData.orders,
                    transactions: appData.transactions,
                    clients: appData.clients,
                    inventory: appData.inventory,
                    version: appData.version,
                    lastSaved: new Date().toISOString()
                };
                
                localStorage.setItem('retroavia_data', JSON.stringify(dataToSave));
                console.log('💾 Data saved to localStorage');
            } catch (error) {
                console.error('❌ LocalStorage save failed:', error);
                showMessage('Errore nel salvataggio locale', 'error');
            }
        }

        function loadDataFromLocalStorage() {
            try {
                const saved = localStorage.getItem('retroavia_data');
                if (saved) {
                    const data = JSON.parse(saved);
                    
                    // Validate and load data
                    appData.orders = Array.isArray(data.orders) ? data.orders : [];
                    appData.transactions = Array.isArray(data.transactions) ? data.transactions : [];
                    appData.clients = Array.isArray(data.clients) ? data.clients : [];
                    appData.inventory = Array.isArray(data.inventory) ? data.inventory : [];
                    
                    console.log('📥 Data loaded from localStorage:', {
                        orders: appData.orders.length,
                        transactions: appData.transactions.length,
                        clients: appData.clients.length,
                        inventory: appData.inventory.length,
                        lastSaved: data.lastSaved
                    });
                    
                    return true;
                }
                return false;
            } catch (error) {
                console.error('❌ LocalStorage load failed:', error);
                showMessage('Errore nel caricamento dati locali', 'error');
                return false;
            }
        }

        // ===== IMPORT/EXPORT FUNCTIONS =====
        function exportBackup() {
            try {
                const backup = {
                    version: appData.version,
                    timestamp: new Date().toISOString(),
                    data: {
                        orders: appData.orders,
                        transactions: appData.transactions,
                        clients: appData.clients,
                        inventory: appData.inventory
                    },
                    meta: {
                        totalTransactions: appData.transactions.length,
                        totalClients: appData.clients.length,
                        totalInventoryItems: appData.inventory.length,
                        totalOrders: appData.orders.length,
                        exportedBy: 'RetroAvia Spider-System v4.2',
                        syncQueueLength: appData.syncQueue.length,
                        healthStatus: appData.healthCheck.status
                    }
                };
                
                const dataStr = JSON.stringify(backup, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `retroavia_backup_${formatDate().replace(/-/g, '')}_${Date.now()}.json`;
                link.click();
                
                // Clean up
                setTimeout(() => URL.revokeObjectURL(link.href), 100);
                
                showMessage('📦 Backup esportato con successo!');
                console.log('Backup exported successfully');
            } catch (error) {
                console.error('Export error:', error);
                showMessage('Errore nell\'esportazione backup', 'error');
            }
        }

        function showImportModal() {
            const content = `
                <h3 id="modalTitle" style="color: var(--accent); margin-bottom: var(--space-6);">📂 Importa Backup</h3>
                
                <div style="margin: var(--space-6) 0; padding: var(--space-4); background: rgba(245, 158, 11, 0.1); border-radius: var(--radius-lg); border: 1px solid var(--warning);">
                    <h4 style="color: var(--warning); margin-bottom: var(--space-2);">⚠️ Attenzione</h4>
                    <p style="margin-bottom: var(--space-2);">L'importazione sostituirà tutti i dati correnti. Assicurati di aver fatto un backup prima di procedere.</p>
                    <p style="font-size: 0.875rem; color: var(--text-muted);">Sono supportati solo file JSON esportati da RetroAvia v4.2.</p>
                </div>

                <div class="form-group">
                    <label for="backupFile">Seleziona File Backup (.json)</label>
                    <div class="file-input">
                        <input type="file" id="backupFile" accept=".json" required>
                        <label for="backupFile" class="file-input-label">
                            <span>📂</span> Scegli File
                        </label>
                    </div>
                </div>

                <div id="filePreview" style="display: none; margin: var(--space-4) 0; padding: var(--space-4); background: var(--surface); border-radius: var(--radius-lg);">
                    <!-- File preview will be shown here -->
                </div>

                <div class="quick-actions">
                    <button type="button" class="btn btn-warning" onclick="processImportFile()" id="importBtn" disabled>
                        <span>📂</span> Importa Dati
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">
                        <span>❌</span> Annulla
                    </button>
                </div>
            `;
            
            openModal(content);

            // Setup file input listener
            setTimeout(() => {
                const fileInput = document.getElementById('backupFile');
                if (fileInput) {
                    fileInput.addEventListener('change', previewImportFile);
                }
            }, 100);
        }

        function previewImportFile(event) {
            const file = event.target.files[0];
            const previewDiv = document.getElementById('filePreview');
            const importBtn = document.getElementById('importBtn');

            if (!file) {
                previewDiv.style.display = 'none';
                importBtn.disabled = true;
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const backup = JSON.parse(e.target.result);
                    
                    // Validate backup structure
                    if (!backup.data || !backup.version) {
                        throw new Error('File backup non valido');
                    }

                    const data = backup.data;
                    const meta = backup.meta || {};

                    previewDiv.innerHTML = `
                        <h4 style="color: var(--success); margin-bottom: var(--space-4);">✅ File Valido</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: var(--space-2); font-size: 0.875rem;">
                            <div><strong>Versione:</strong> ${backup.version}</div>
                            <div><strong>Data:</strong> ${new Date(backup.timestamp).toLocaleDateString('it-IT')}</div>
                            <div><strong>Ordini:</strong> ${(data.orders || []).length}</div>
                            <div><strong>Transazioni:</strong> ${(data.transactions || []).length}</div>
                            <div><strong>Clienti:</strong> ${(data.clients || []).length}</div>
                            <div><strong>Inventario:</strong> ${(data.inventory || []).length}</div>
                        </div>
                    `;
                    previewDiv.style.display = 'block';
                    importBtn.disabled = false;
                    
                    // Store backup data for import
                    window.importData = backup;
                    
                } catch (error) {
                    previewDiv.innerHTML = `
                        <h4 style="color: var(--error); margin-bottom: var(--space-2);">❌ File Non Valido</h4>
                        <p style="color: var(--text-muted); font-size: 0.875rem;">Errore: ${error.message}</p>
                    `;
                    previewDiv.style.display = 'block';
                    importBtn.disabled = true;
                }
            };
            reader.readAsText(file);
        }

        async function processImportFile() {
            try {
                const backup = window.importData;
                if (!backup || !backup.data) {
                    showMessage('Dati backup non validi', 'error');
                    return;
                }

                const importBtn = document.getElementById('importBtn');
                importBtn.disabled = true;
                importBtn.innerHTML = '<span class="loading"></span> Importando...';

                // Import data locally
                appData.orders = backup.data.orders || [];
                appData.transactions = backup.data.transactions || [];
                appData.clients = backup.data.clients || [];
                appData.inventory = backup.data.inventory || [];

                // Save to localStorage
                saveDataToLocalStorage();

                // Update client spending
                updateClientTotalSpent();

                // If connected, sync to Supabase
                if (appData.connected && appData.isOnline) {
                    try {
                        showMessage('🔄 Sincronizzando dati importati...');
                        
                        // Add all data to sync queue
                        appData.orders.forEach(order => {
                            appData.syncQueue.push({ action: 'upsert', table: 'orders', data: order });
                        });
                        appData.transactions.forEach(transaction => {
                            appData.syncQueue.push({ action: 'upsert', table: 'transactions', data: transaction });
                        });
                        appData.clients.forEach(client => {
                            appData.syncQueue.push({ action: 'upsert', table: 'clients', data: client });
                        });
                        appData.inventory.forEach(item => {
                            appData.syncQueue.push({ action: 'upsert', table: 'inventory', data: item });
                        });

                        // Process sync queue
                        await processSyncQueue();
                        
                        showMessage('✅ Dati importati e sincronizzati su cloud!');
                    } catch (error) {
                        console.warn('Sync after import failed:', error);
                        showMessage('✅ Dati importati localmente (sync in corso...)', 'error');
                    }
                } else {
                    showMessage('✅ Dati importati localmente (sync quando online)');
                }

                // Refresh current page
                showPage(appData.currentPage);
                updateDashboard();

                closeModal();

            } catch (error) {
                console.error('Import error:', error);
                showMessage(`Errore nell'importazione: ${error.message}`, 'error');
                
                const importBtn = document.getElementById('importBtn');
                if (importBtn) {
                    importBtn.disabled = false;
                    importBtn.innerHTML = '<span>📂</span> Importa Dati';
                }
            }
        }

        // ===== CLIENT MANAGEMENT =====
        function updateClientTotalSpent() {
            appData.clients.forEach(client => {
                const clientTransactions = appData.transactions.filter(t => 
                    t.client === client.client_name || t.client === client.name
                );
                
                const totalSpent = clientTransactions
                    .filter(t => t.type === 'revenue')
                    .reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);
                
                client.total_spent = totalSpent;
            });
        }

        // ===== MODAL FUNCTIONS =====
        function openModal(content) {
            const modal = document.getElementById('modal');
            const modalContent = document.getElementById('modalContent');
            
            if (modal && modalContent) {
                modalContent.innerHTML = content;
                modal.classList.add('active');
                
                // Focus management for accessibility
                const firstInput = modalContent.querySelector('input, select, textarea, button');
                if (firstInput) {
                    setTimeout(() => firstInput.focus(), 100);
                }
            }
        }

        function closeModal() {
            const modal = document.getElementById('modal');
            if (modal) {
                modal.classList.remove('active');
                appData.editingId = null;
            }
        }

        function showConfirmDialog(title, message, onConfirm) {
            const dialog = document.getElementById('confirmDialog');
            const titleEl = document.getElementById('confirmTitle');
            const messageEl = document.getElementById('confirmMessage');
            const yesBtn = document.getElementById('confirmYes');
            const noBtn = document.getElementById('confirmNo');
            
            if (dialog && titleEl && messageEl && yesBtn && noBtn) {
                titleEl.textContent = title;
                messageEl.textContent = message;
                
                // Remove existing listeners
                yesBtn.onclick = null;
                noBtn.onclick = null;
                
                yesBtn.onclick = () => {
                    dialog.classList.remove('active');
                    if (onConfirm) onConfirm();
                };
                
                noBtn.onclick = () => {
                    dialog.classList.remove('active');
                };
                
                dialog.classList.add('active');
            }
        }

        // ===== NAVIGATION FUNCTIONS =====
        function showPage(pageId) {
            // Update current page
            appData.currentPage = pageId;
            
            // Hide all pages
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            // Show selected page
            const targetPage = document.getElementById(pageId);
            if (targetPage) {
                targetPage.classList.add('active');
            }
            
            // Update nav buttons
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Find and activate current nav button
            const navBtns = document.querySelectorAll('.nav-btn');
            navBtns.forEach(btn => {
                const onclick = btn.getAttribute('onclick');
                if (onclick && onclick.includes(pageId)) {
                    btn.classList.add('active');
                }
            });
            
            // Load page-specific content
            switch (pageId) {
                case 'dashboard':
                    updateDashboard();
                    break;
                case 'orders':
                    loadOrdersPage();
                    break;
                case 'transactions':
                    loadTransactionsPage();
                    break;
                case 'clients':
                    loadClientsPage();
                    break;
                case 'inventory':
                    loadInventoryPage();
                    break;
                case 'calendar':
                    loadCalendarPage();
                    break;
                case 'analytics':
                    loadAnalyticsPage();
                    break;
            }
        }

        // ===== DASHBOARD FUNCTIONS =====
        function updateDashboard() {
            try {
                // Calculate totals
                const totalRevenue = appData.transactions
                    .filter(t => t.type === 'revenue')
                    .reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);
                
                const totalExpenses = appData.transactions
                    .filter(t => t.type === 'expense')
                    .reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);
                
                const netProfit = totalRevenue - totalExpenses;
                const totalOrders = appData.orders.length;
                
                // Update display
                const revenueEl = document.getElementById('totalRevenue');
                const expensesEl = document.getElementById('totalExpenses');
                const profitEl = document.getElementById('netProfit');
                const ordersEl = document.getElementById('totalOrders');
                
                if (revenueEl) revenueEl.textContent = formatCurrency(totalRevenue);
                if (expensesEl) expensesEl.textContent = formatCurrency(totalExpenses);
                if (profitEl) profitEl.textContent = formatCurrency(netProfit);
                if (ordersEl) ordersEl.textContent = totalOrders.toString();
                
                // Update AI suggestions
                updateAISuggestions();
                
            } catch (error) {
                console.error('Dashboard update error:', error);
            }
        }

        function updateAISuggestions() {
            const suggestionsEl = document.getElementById('aiSuggestions');
            if (!suggestionsEl) return;
            
            const suggestions = [];
            
            // Low inventory warnings
            const lowStock = appData.inventory.filter(item => 
                item.quantity <= item.threshold
            );
            
            if (lowStock.length > 0) {
                suggestions.push(`⚠️ ${lowStock.length} componenti con scorte basse!`);
            }
            
            // Pending orders
            const pendingOrders = appData.orders.filter(order => 
                order.status === 'pending' || order.status === 'in-progress'
            );
            
            if (pendingOrders.length > 0) {
                suggestions.push(`📋 ${pendingOrders.length} ordini da completare`);
            }
            
            // Monthly performance
            const thisMonth = new Date().getMonth();
            const thisYear = new Date().getFullYear();
            const monthlyRevenue = appData.transactions
                .filter(t => {
                    const date = new Date(t.transaction_date || t.date);
                    return t.type === 'revenue' && 
                           date.getMonth() === thisMonth && 
                           date.getFullYear() === thisYear;
                })
                .reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);
            
            if (monthlyRevenue > 0) {
                suggestions.push(`💰 Guadagni questo mese: ${formatCurrency(monthlyRevenue)}`);
            }
            
            // Default suggestions if empty
            if (suggestions.length === 0) {
                suggestions.push('✅ Tutti i sistemi funzionano correttamente!');
                suggestions.push('📊 Pronto per analisi AI avanzate');
            }
            
            suggestionsEl.innerHTML = suggestions
                .map(s => `<p>• ${s}</p>`)
                .join('');
        }

        // ===== AI FUNCTIONS =====
        function runAIAnalysis() {
            showMessage('🧠 Analisi AI in corso...');
            
            // Simulate AI analysis
            setTimeout(() => {
                const analysis = [];
                
                // Revenue trend analysis
                const recentRevenue = appData.transactions
                    .filter(t => {
                        const date = new Date(t.transaction_date || t.date);
                        const monthsAgo = new Date();
                        monthsAgo.setMonth(monthsAgo.getMonth() - 3);
                        return t.type === 'revenue' && date >= monthsAgo;
                    })
                    .reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);
                
                if (recentRevenue > 1000) {
                    analysis.push('📈 Trend di crescita positivo negli ultimi 3 mesi');
                } else {
                    analysis.push('📊 Considera nuove strategie di marketing');
                }
                
                // Client analysis
                const topClient = appData.clients
                    .sort((a, b) => (b.total_spent || 0) - (a.total_spent || 0))[0];
                
                if (topClient) {
                    analysis.push(`🏆 Cliente top: ${topClient.client_name} (${formatCurrency(topClient.total_spent || 0)})`);
                }
                
                // Inventory optimization
                const totalInventoryValue = appData.inventory
                    .reduce((sum, item) => sum + (item.quantity * item.price), 0);
                
                analysis.push(`📦 Valore inventario: ${formatCurrency(totalInventoryValue)}`);
                
                // Update suggestions
                const suggestionsEl = document.getElementById('aiSuggestions');
                if (suggestionsEl) {
                    suggestionsEl.innerHTML = analysis
                        .map(s => `<p>• ${s}</p>`)
                        .join('');
                }
                
                showMessage('✅ Analisi AI completata!');
            }, 2000);
        }

        function generatePredictions() {
            showMessage('🔮 Generando predizioni...');
            
            setTimeout(() => {
                const predictions = [
                    '📈 Previsione ricavi prossimo mese: +15%',
                    '🎯 Componenti da riordinare entro 2 settimane',
                    '💡 Opportunità: Espandere linea Game Boy Color',
                    '⚡ Trend stagionale: Picco vendite previsto a dicembre'
                ];
                
                const suggestionsEl = document.getElementById('aiSuggestions');
                if (suggestionsEl) {
                    suggestionsEl.innerHTML = predictions
                        .map(s => `<p>• ${s}</p>`)
                        .join('');
                }
                
                showMessage('🔮 Predizioni generate con successo!');
            }, 1500);
        }

        // ===== QUICK ACTION FUNCTIONS =====
        function openQuickSale() {
            const content = `
                <h3 id="modalTitle" style="color: var(--success); margin-bottom: var(--space-6);">💰 Vendita Rapida</h3>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label for="saleAmount">Importo</label>
                        <input type="number" id="saleAmount" step="0.01" min="0" placeholder="0.00" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="saleClient">Cliente</label>
                        <input type="text" id="saleClient" placeholder="Nome cliente" list="clientList">
                        <datalist id="clientList">
                            ${appData.clients.map(c => `<option value="${c.client_name || c.name}">`).join('')}
                        </datalist>
                    </div>
                    
                    <div class="form-group form-grid-full">
                        <label for="saleDescription">Descrizione</label>
                        <textarea id="saleDescription" placeholder="Descrizione della vendita" rows="3"></textarea>
                    </div>
                </div>
                
                <div class="quick-actions">
                    <button type="button" class="btn btn-success" onclick="saveQuickSale()">
                        <span>💰</span> Registra Vendita
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">
                        <span>❌</span> Annulla
                    </button>
                </div>
            `;
            
            openModal(content);
        }

        async function saveQuickSale() {
            const amount = document.getElementById('saleAmount')?.value;
            const client = document.getElementById('saleClient')?.value;
            const description = document.getElementById('saleDescription')?.value;
            
            if (!amount || parseFloat(amount) <= 0) {
                showMessage('Inserisci un importo valido', 'error');
                return;
            }
            
            const transaction = {
                id: generateId(),
                type: 'revenue',
                amount: parseFloat(amount),
                description: description || 'Vendita rapida',
                client: client || 'Cliente anonimo',
                transaction_date: formatDate(),
                created_at: formatDateTime()
            };
            
            const success = await enhancedSave('transactions', transaction, appData.transactions, 'Vendita registrata');
            
            if (success) {
                updateClientTotalSpent();
                updateDashboard();
                closeModal();
            }
        }

        function openQuickOrder() {
            const content = `
                <h3 id="modalTitle" style="color: var(--warning); margin-bottom: var(--space-6);">📋 Nuovo Ordine</h3>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label for="orderClientName">Nome Cliente</label>
                        <input type="text" id="orderClientName" placeholder="Nome cliente" list="clientList" required>
                        <datalist id="clientList">
                            ${appData.clients.map(c => `<option value="${c.client_name || c.name}">`).join('')}
                        </datalist>
                    </div>
                    
                    <div class="form-group">
                        <label for="orderClientEmail">Email Cliente</label>
                        <input type="email" id="orderClientEmail" placeholder="cliente@esempio.it">
                    </div>
                    
                    <div class="form-group">
                        <label for="orderDueDate">Data Scadenza</label>
                        <input type="date" id="orderDueDate" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="orderStatus">Stato</label>
                        <select id="orderStatus" required>
                            <option value="pending">In Attesa</option>
                            <option value="in-progress">In Lavorazione</option>
                            <option value="completed">Completato</option>
                        </select>
                    </div>
                    
                    <div class="form-group form-grid-full">
                        <label for="orderSpecs">Specifiche Ordine</label>
                        <textarea id="orderSpecs" placeholder="Descrivi le specifiche dell'ordine..." rows="4"></textarea>
                    </div>
                </div>
                
                <div class="quick-actions">
                    <button type="button" class="btn btn-warning" onclick="saveQuickOrder()">
                        <span>📋</span> Crea Ordine
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">
                        <span>❌</span> Annulla
                    </button>
                </div>
            `;
            
            openModal(content);
            
            // Set default due date (7 days from now)
            setTimeout(() => {
                const dueDateInput = document.getElementById('orderDueDate');
                if (dueDateInput) {
                    const nextWeek = new Date();
                    nextWeek.setDate(nextWeek.getDate() + 7);
                    dueDateInput.value = formatDate(nextWeek);
                }
            }, 100);
        }

        async function saveQuickOrder() {
            const clientName = document.getElementById('orderClientName')?.value;
            const clientEmail = document.getElementById('orderClientEmail')?.value;
            const dueDate = document.getElementById('orderDueDate')?.value;
            const status = document.getElementById('orderStatus')?.value;
            const specs = document.getElementById('orderSpecs')?.value;
            
            if (!clientName || !dueDate) {
                showMessage('Compila i campi obbligatori', 'error');
                return;
            }
            
            const order = {
                id: generateId(),
                client_name: clientName,
                client_email: clientEmail || '',
                due_date: dueDate,
                status: status || 'pending',
                specs: { description: specs || '' },
                created_at: formatDateTime()
            };
            
            const success = await enhancedSave('orders', order, appData.orders, 'Ordine creato');
            
            if (success) {
                updateDashboard();
                closeModal();
                showPage('orders');
            }
        }

        function openQuickClient() {
            const content = `
                <h3 id="modalTitle" style="color: var(--info); margin-bottom: var(--space-6);">👤 Nuovo Cliente</h3>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label for="clientName">Nome Cliente</label>
                        <input type="text" id="clientName" placeholder="Nome completo" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="clientEmail">Email</label>
                        <input type="email" id="clientEmail" placeholder="cliente@esempio.it">
                    </div>
                    
                    <div class="form-group">
                        <label for="clientPhone">Telefono</label>
                        <input type="tel" id="clientPhone" placeholder="+39 123 456 7890">
                    </div>
                    
                    <div class="form-group">
                        <label for="clientSource">Fonte</label>
                        <select id="clientSource">
                            <option value="">Seleziona fonte</option>
                            <option value="social-media">Social Media</option>
                            <option value="referral">Passaparola</option>
                            <option value="website">Sito Web</option>
                            <option value="marketplace">Marketplace</option>
                            <option value="other">Altro</option>
                        </select>
                    </div>
                </div>
                
                <div class="quick-actions">
                    <button type="button" class="btn btn-success" onclick="saveQuickClient()">
                        <span>👤</span> Aggiungi Cliente
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">
                        <span>❌</span> Annulla
                    </button>
                </div>
            `;
            
            openModal(content);
        }

        async function saveQuickClient() {
            const name = document.getElementById('clientName')?.value;
            const email = document.getElementById('clientEmail')?.value;
            const phone = document.getElementById('clientPhone')?.value;
            const source = document.getElementById('clientSource')?.value;
            
            if (!name) {
                showMessage('Inserisci il nome del cliente', 'error');
                return;
            }
            
            const client = {
                id: generateId(),
                client_name: name,
                client_email: email || '',
                client_phone: phone || '',
                client_source: source || '',
                total_spent: 0,
                created_at: formatDateTime()
            };
            
            const success = await enhancedSave('clients', client, appData.clients, 'Cliente aggiunto');
            
            if (success) {
                updateDashboard();
                closeModal();
                showPage('clients');
            }
        }

        function openQuickInventory() {
            const content = `
                <h3 id="modalTitle" style="color: var(--primary); margin-bottom: var(--space-6);">📦 Nuovo Componente</h3>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label for="itemName">Nome Componente</label>
                        <input type="text" id="itemName" placeholder="Es: LCD Game Boy DMG" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="itemQuantity">Quantità</label>
                        <input type="number" id="itemQuantity" min="0" placeholder="0" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="itemThreshold">Soglia Minima</label>
                        <input type="number" id="itemThreshold" min="0" placeholder="5">
                    </div>
                    
                    <div class="form-group">
                        <label for="itemPrice">Prezzo Unitario</label>
                        <input type="number" id="itemPrice" step="0.01" min="0" placeholder="0.00">
                    </div>
                    
                    <div class="form-group form-grid-full">
                        <label for="itemSupplier">Fornitore</label>
                        <input type="text" id="itemSupplier" placeholder="Nome fornitore">
                    </div>
                </div>
                
                <div class="quick-actions">
                    <button type="button" class="btn btn-success" onclick="saveQuickInventory()">
                        <span>📦</span> Aggiungi Componente
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">
                        <span>❌</span> Annulla
                    </button>
                </div>
            `;
            
            openModal(content);
        }

        async function saveQuickInventory() {
            const name = document.getElementById('itemName')?.value;
            const quantity = document.getElementById('itemQuantity')?.value;
            const threshold = document.getElementById('itemThreshold')?.value;
            const price = document.getElementById('itemPrice')?.value;
            const supplier = document.getElementById('itemSupplier')?.value;
            
            if (!name || !quantity) {
                showMessage('Compila i campi obbligatori', 'error');
                return;
            }
            
            const item = {
                id: generateId(),
                item_name: name,
                quantity: parseInt(quantity) || 0,
                threshold: parseInt(threshold) || 5,
                price: parseFloat(price) || 0,
                supplier: supplier || '',
                created_at: formatDateTime()
            };
            
            const success = await enhancedSave('inventory', item, appData.inventory, 'Componente aggiunto');
            
            if (success) {
                updateDashboard();
                closeModal();
                showPage('inventory');
            }
        }

        // ===== PAGE LOADING FUNCTIONS =====
        function loadOrdersPage() {
            const container = document.getElementById('ordersContainer');
            if (!container) return;
            
            if (appData.orders.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">📋</div>
                        <h3>Nessun ordine trovato</h3>
                        <p>Inizia creando il tuo primo ordine!</p>
                    </div>
                `;
                return;
            }
            
            let ordersHtml = '<table class="data-table"><thead><tr>';
            ordersHtml += '<th>Cliente</th><th>Email</th><th>Stato</th><th>Data Scadenza</th><th>Azioni</th>';
            ordersHtml += '</tr></thead><tbody>';
            
            appData.orders.forEach(order => {
                ordersHtml += `
                    <tr>
                        <td>${order.client_name || 'N/A'}</td>
                        <td>${order.client_email || 'N/A'}</td>
                        <td><span class="status-badge status-${order.status}">${getStatusLabel(order.status)}</span></td>
                        <td>${formatDisplayDate(order.due_date)}</td>
                        <td>
                            <button class="btn btn-info" onclick="editOrder('${order.id}')" title="Modifica">
                                <span>✏️</span>
                            </button>
                            <button class="btn btn-error" onclick="deleteOrder('${order.id}')" title="Elimina">
                                <span>🗑️</span>
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            ordersHtml += '</tbody></table>';
            container.innerHTML = ordersHtml;
        }

        function loadTransactionsPage() {
            const container = document.getElementById('transactionsContainer');
            if (!container) return;
            
            if (appData.transactions.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">💰</div>
                        <h3>Nessuna transazione trovata</h3>
                        <p>Inizia registrando la tua prima transazione!</p>
                    </div>
                `;
                return;
            }
            
            let transactionsHtml = '<table class="data-table"><thead><tr>';
            transactionsHtml += '<th>Data</th><th>Tipo</th><th>Importo</th><th>Descrizione</th><th>Cliente</th><th>Azioni</th>';
            transactionsHtml += '</tr></thead><tbody>';
            
            appData.transactions.forEach(transaction => {
                const typeClass = transaction.type === 'revenue' ? 'success' : 'error';
                const typeIcon = transaction.type === 'revenue' ? '💰' : '💸';
                
                transactionsHtml += `
                    <tr>
                        <td>${formatDisplayDate(transaction.transaction_date || transaction.date)}</td>
                        <td><span class="status-badge status-${typeClass}">${typeIcon} ${transaction.type === 'revenue' ? 'Entrata' : 'Uscita'}</span></td>
                        <td style="color: var(--${typeClass}); font-weight: bold;">${formatCurrency(transaction.amount)}</td>
                        <td>${transaction.description || 'N/A'}</td>
                        <td>${transaction.client || 'N/A'}</td>
                        <td>
                            <button class="btn btn-info" onclick="editTransaction('${transaction.id}')" title="Modifica">
                                <span>✏️</span>
                            </button>
                            <button class="btn btn-error" onclick="deleteTransaction('${transaction.id}')" title="Elimina">
                                <span>🗑️</span>
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            transactionsHtml += '</tbody></table>';
            container.innerHTML = transactionsHtml;
        }

        function loadClientsPage() {
            const container = document.getElementById('clientsContainer');
            if (!container) return;
            
            if (appData.clients.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">👤</div>
                        <h3>Nessun cliente trovato</h3>
                        <p>Inizia aggiungendo il tuo primo cliente!</p>
                    </div>
                `;
                return;
            }
            
            let clientsHtml = '<table class="data-table"><thead><tr>';
            clientsHtml += '<th>Nome</th><th>Email</th><th>Telefono</th><th>Fonte</th><th>Totale Speso</th><th>Azioni</th>';
            clientsHtml += '</tr></thead><tbody>';
            
            appData.clients.forEach(client => {
                clientsHtml += `
                    <tr>
                        <td><strong>${client.client_name || client.name || 'N/A'}</strong></td>
                        <td>${client.client_email || client.email || 'N/A'}</td>
                        <td>${client.client_phone || client.phone || 'N/A'}</td>
                        <td>${client.client_source || client.source || 'N/A'}</td>
                        <td style="color: var(--success); font-weight: bold;">${formatCurrency(client.total_spent || 0)}</td>
                        <td>
                            <button class="btn btn-info" onclick="editClient('${client.id}')" title="Modifica">
                                <span>✏️</span>
                            </button>
                            <button class="btn btn-error" onclick="deleteClient('${client.id}')" title="Elimina">
                                <span>🗑️</span>
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            clientsHtml += '</tbody></table>';
            container.innerHTML = clientsHtml;
        }

        function loadInventoryPage() {
            const container = document.getElementById('inventoryContainer');
            if (!container) return;
            
            if (appData.inventory.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">📦</div>
                        <h3>Nessun componente trovato</h3>
                        <p>Inizia aggiungendo il tuo primo componente!</p>
                    </div>
                `;
                return;
            }
            
            let inventoryHtml = '<table class="data-table"><thead><tr>';
            inventoryHtml += '<th>Nome</th><th>Quantità</th><th>Soglia</th><th>Prezzo</th><th>Fornitore</th><th>Azioni</th>';
            inventoryHtml += '</tr></thead><tbody>';
            
            appData.inventory.forEach(item => {
                const lowStock = item.quantity <= item.threshold;
                const quantityClass = lowStock ? 'error' : 'success';
                const quantityIcon = lowStock ? '⚠️' : '✅';
                
                inventoryHtml += `
                    <tr>
                        <td><strong>${item.item_name || item.name || 'N/A'}</strong></td>
                        <td><span class="status-badge status-${quantityClass}">${quantityIcon} ${item.quantity || 0}</span></td>
                        <td>${item.threshold || 0}</td>
                        <td>${formatCurrency(item.price || 0)}</td>
                        <td>${item.supplier || 'N/A'}</td>
                        <td>
                            <button class="btn btn-info" onclick="editInventoryItem('${item.id}')" title="Modifica">
                                <span>✏️</span>
                            </button>
                            <button class="btn btn-error" onclick="deleteInventoryItem('${item.id}')" title="Elimina">
                                <span>🗑️</span>
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            inventoryHtml += '</tbody></table>';
            container.innerHTML = inventoryHtml;
        }

        function loadCalendarPage() {
            renderCalendar();
        }

        function loadAnalyticsPage() {
            renderMonthlyTrends();
            renderTopClients();
            renderMonthlyPerformance();
            renderKPIDashboard();
        }

        // ===== UTILITY DISPLAY FUNCTIONS =====
        function formatDisplayDate(dateStr) {
            if (!dateStr) return 'N/A';
            
            try {
                const date = new Date(dateStr);
                return date.toLocaleDateString('it-IT', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit'
                });
            } catch {
                return dateStr;
            }
        }

        function getStatusLabel(status) {
            const statusMap = {
                'pending': 'In Attesa',
                'in-progress': 'In Lavorazione',
                'completed': 'Completato',
                'cancelled': 'Cancellato'
            };
            return statusMap[status] || status;
        }

        // ===== CRUD OPERATIONS =====
        function addOrder() {
            openQuickOrder();
        }

        function editOrder(id) {
            const order = appData.orders.find(o => o.id === id);
            if (!order) return;
            
            appData.editingId = id;
            
            const content = `
                <h3 id="modalTitle" style="color: var(--warning); margin-bottom: var(--space-6);">📋 Modifica Ordine</h3>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label for="orderClientName">Nome Cliente</label>
                        <input type="text" id="orderClientName" value="${order.client_name || ''}" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="orderClientEmail">Email Cliente</label>
                        <input type="email" id="orderClientEmail" value="${order.client_email || ''}">
                    </div>
                    
                    <div class="form-group">
                        <label for="orderDueDate">Data Scadenza</label>
                        <input type="date" id="orderDueDate" value="${order.due_date?.split('T')[0] || ''}" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="orderStatus">Stato</label>
                        <select id="orderStatus" required>
                            <option value="pending" ${order.status === 'pending' ? 'selected' : ''}>In Attesa</option>
                            <option value="in-progress" ${order.status === 'in-progress' ? 'selected' : ''}>In Lavorazione</option>
                            <option value="completed" ${order.status === 'completed' ? 'selected' : ''}>Completato</option>
                            <option value="cancelled" ${order.status === 'cancelled' ? 'selected' : ''}>Cancellato</option>
                        </select>
                    </div>
                    
                    <div class="form-group form-grid-full">
                        <label for="orderSpecs">Specifiche Ordine</label>
                        <textarea id="orderSpecs" rows="4">${order.specs?.description || ''}</textarea>
                    </div>
                </div>
                
                <div class="quick-actions">
                    <button type="button" class="btn btn-warning" onclick="saveQuickOrder()">
                        <span>💾</span> Salva Modifiche
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">
                        <span>❌</span> Annulla
                    </button>
                </div>
            `;
            
            openModal(content);
        }

        function deleteOrder(id) {
            showConfirmDialog(
                'Elimina Ordine',
                'Sei sicuro di voler eliminare questo ordine? Questa azione non può essere annullata.',
                async () => {
                    const success = await enhancedDelete('orders', id, appData.orders, 'Ordine');
                    if (success) {
                        loadOrdersPage();
                        updateDashboard();
                    }
                }
            );
        }

        function addTransaction(type) {
            const isRevenue = type === 'revenue';
            const color = isRevenue ? 'success' : 'error';
            const icon = isRevenue ? '💰' : '💸';
            const title = isRevenue ? 'Nuova Entrata' : 'Nuova Spesa';
            
            const content = `
                <h3 id="modalTitle" style="color: var(--${color}); margin-bottom: var(--space-6);">${icon} ${title}</h3>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label for="transactionAmount">Importo</label>
                        <input type="number" id="transactionAmount" step="0.01" min="0" placeholder="0.00" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="transactionDate">Data</label>
                        <input type="date" id="transactionDate" value="${formatDate()}" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="transactionClient">Cliente/Fornitore</label>
                        <input type="text" id="transactionClient" placeholder="${isRevenue ? 'Nome cliente' : 'Nome fornitore'}" list="clientList">
                        <datalist id="clientList">
                            ${appData.clients.map(c => `<option value="${c.client_name || c.name}">`).join('')}
                        </datalist>
                    </div>
                    
                    <div class="form-group form-grid-full">
                        <label for="transactionDescription">Descrizione</label>
                        <textarea id="transactionDescription" placeholder="Descrizione della transazione" rows="3" required></textarea>
                    </div>
                </div>
                
                <input type="hidden" id="transactionType" value="${type}">
                
                <div class="quick-actions">
                    <button type="button" class="btn btn-${color}" onclick="saveTransaction()">
                        <span>${icon}</span> Salva ${isRevenue ? 'Entrata' : 'Spesa'}
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">
                        <span>❌</span> Annulla
                    </button>
                </div>
            `;
            
            openModal(content);
        }

        async function saveTransaction() {
            const amount = document.getElementById('transactionAmount')?.value;
            const date = document.getElementById('transactionDate')?.value;
            const client = document.getElementById('transactionClient')?.value;
            const description = document.getElementById('transactionDescription')?.value;
            const type = document.getElementById('transactionType')?.value;
            
            if (!amount || !date || !description) {
                showMessage('Compila tutti i campi obbligatori', 'error');
                return;
            }
            
            if (parseFloat(amount) <= 0) {
                showMessage('Inserisci un importo valido', 'error');
                return;
            }
            
            const transaction = {
                id: appData.editingId || generateId(),
                type: type,
                amount: parseFloat(amount),
                transaction_date: date,
                client: client || 'N/A',
                description: description,
                created_at: appData.editingId ? 
                    appData.transactions.find(t => t.id === appData.editingId)?.created_at || formatDateTime() : 
                    formatDateTime()
            };
            
            const success = await enhancedSave('transactions', transaction, appData.transactions, 
                appData.editingId ? 'Transazione modificata' : 'Transazione salvata');
            
            if (success) {
                updateClientTotalSpent();
                updateDashboard();
                loadTransactionsPage();
                closeModal();
            }
        }

        function editTransaction(id) {
            const transaction = appData.transactions.find(t => t.id === id);
            if (!transaction) return;
            
            appData.editingId = id;
            
            const isRevenue = transaction.type === 'revenue';
            const color = isRevenue ? 'success' : 'error';
            const icon = isRevenue ? '💰' : '💸';
            const title = isRevenue ? 'Modifica Entrata' : 'Modifica Spesa';
            
            const content = `
                <h3 id="modalTitle" style="color: var(--${color}); margin-bottom: var(--space-6);">${icon} ${title}</h3>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label for="transactionAmount">Importo</label>
                        <input type="number" id="transactionAmount" step="0.01" min="0" value="${transaction.amount || ''}" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="transactionDate">Data</label>
                        <input type="date" id="transactionDate" value="${(transaction.transaction_date || transaction.date)?.split('T')[0] || ''}" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="transactionClient">Cliente/Fornitore</label>
                        <input type="text" id="transactionClient" value="${transaction.client || ''}" list="clientList">
                        <datalist id="clientList">
                            ${appData.clients.map(c => `<option value="${c.client_name || c.name}">`).join('')}
                        </datalist>
                    </div>
                    
                    <div class="form-group form-grid-full">
                        <label for="transactionDescription">Descrizione</label>
                        <textarea id="transactionDescription" rows="3" required>${transaction.description || ''}</textarea>
                    </div>
                </div>
                
                <input type="hidden" id="transactionType" value="${transaction.type}">
                
                <div class="quick-actions">
                    <button type="button" class="btn btn-${color}" onclick="saveTransaction()">
                        <span>💾</span> Salva Modifiche
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">
                        <span>❌</span> Annulla
                    </button>
                </div>
            `;
            
            openModal(content);
        }

        function deleteTransaction(id) {
            showConfirmDialog(
                'Elimina Transazione',
                'Sei sicuro di voler eliminare questa transazione? Questa azione non può essere annullata.',
                async () => {
                    const success = await enhancedDelete('transactions', id, appData.transactions, 'Transazione');
                    if (success) {
                        updateClientTotalSpent();
                        loadTransactionsPage();
                        updateDashboard();
                    }
                }
            );
        }

        function addClient() {
            openQuickClient();
        }

        function editClient(id) {
            const client = appData.clients.find(c => c.id === id);
            if (!client) return;
            
            appData.editingId = id;
            
            const content = `
                <h3 id="modalTitle" style="color: var(--info); margin-bottom: var(--space-6);">👤 Modifica Cliente</h3>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label for="clientName">Nome Cliente</label>
                        <input type="text" id="clientName" value="${client.client_name || client.name || ''}" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="clientEmail">Email</label>
                        <input type="email" id="clientEmail" value="${client.client_email || client.email || ''}">
                    </div>
                    
                    <div class="form-group">
                        <label for="clientPhone">Telefono</label>
                        <input type="tel" id="clientPhone" value="${client.client_phone || client.phone || ''}">
                    </div>
                    
                    <div class="form-group">
                        <label for="clientSource">Fonte</label>
                        <select id="clientSource">
                            <option value="">Seleziona fonte</option>
                            <option value="social-media" ${(client.client_source || client.source) === 'social-media' ? 'selected' : ''}>Social Media</option>
                            <option value="referral" ${(client.client_source || client.source) === 'referral' ? 'selected' : ''}>Passaparola</option>
                            <option value="website" ${(client.client_source || client.source) === 'website' ? 'selected' : ''}>Sito Web</option>
                            <option value="marketplace" ${(client.client_source || client.source) === 'marketplace' ? 'selected' : ''}>Marketplace</option>
                            <option value="other" ${(client.client_source || client.source) === 'other' ? 'selected' : ''}>Altro</option>
                        </select>
                    </div>
                </div>
                
                <div class="quick-actions">
                    <button type="button" class="btn btn-success" onclick="saveQuickClient()">
                        <span>💾</span> Salva Modifiche
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">
                        <span>❌</span> Annulla
                    </button>
                </div>
            `;
            
            openModal(content);
        }

        function deleteClient(id) {
            showConfirmDialog(
                'Elimina Cliente',
                'Sei sicuro di voler eliminare questo cliente? Questa azione non può essere annullata.',
                async () => {
                    const success = await enhancedDelete('clients', id, appData.clients, 'Cliente');
                    if (success) {
                        loadClientsPage();
                        updateDashboard();
                    }
                }
            );
        }

        function addInventoryItem() {
            openQuickInventory();
        }

        function editInventoryItem(id) {
            const item = appData.inventory.find(i => i.id === id);
            if (!item) return;
            
            appData.editingId = id;
            
            const content = `
                <h3 id="modalTitle" style="color: var(--primary); margin-bottom: var(--space-6);">📦 Modifica Componente</h3>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label for="itemName">Nome Componente</label>
                        <input type="text" id="itemName" value="${item.item_name || item.name || ''}" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="itemQuantity">Quantità</label>
                        <input type="number" id="itemQuantity" min="0" value="${item.quantity || 0}" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="itemThreshold">Soglia Minima</label>
                        <input type="number" id="itemThreshold" min="0" value="${item.threshold || 5}">
                    </div>
                    
                    <div class="form-group">
                        <label for="itemPrice">Prezzo Unitario</label>
                        <input type="number" id="itemPrice" step="0.01" min="0" value="${item.price || 0}">
                    </div>
                    
                    <div class="form-group form-grid-full">
                        <label for="itemSupplier">Fornitore</label>
                        <input type="text" id="itemSupplier" value="${item.supplier || ''}">
                    </div>
                </div>
                
                <div class="quick-actions">
                    <button type="button" class="btn btn-success" onclick="saveQuickInventory()">
                        <span>💾</span> Salva Modifiche
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">
                        <span>❌</span> Annulla
                    </button>
                </div>
            `;
            
            openModal(content);
        }

        function deleteInventoryItem(id) {
            showConfirmDialog(
                'Elimina Componente',
                'Sei sicuro di voler eliminare questo componente? Questa azione non può essere annullata.',
                async () => {
                    const success = await enhancedDelete('inventory', id, appData.inventory, 'Componente');
                    if (success) {
                        loadInventoryPage();
                        updateDashboard();
                    }
                }
            );
        }

        // ===== CALENDAR FUNCTIONS =====
        function renderCalendar() {
            const calendarGrid = document.getElementById('calendarGrid');
            const calendarMonth = document.getElementById('calendarMonth');
            
            if (!calendarGrid || !calendarMonth) return;
            
            const currentDate = appData.calendarDate;
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            // Update month display
            const monthNames = [
                'Gennaio', 'Febbraio', 'Marzo', 'Aprile', 'Maggio', 'Giugno',
                'Luglio', 'Agosto', 'Settembre', 'Ottobre', 'Novembre', 'Dicembre'
            ];
            calendarMonth.textContent = `${monthNames[month]} ${year}`;
            
            // Get first day of month and number of days
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startingDayOfWeek = firstDay.getDay();
            
            // Day headers
            const dayHeaders = ['Dom', 'Lun', 'Mar', 'Mer', 'Gio', 'Ven', 'Sab'];
            let calendarHtml = '';
            
            // Add day headers
            dayHeaders.forEach(day => {
                calendarHtml += `<div class="calendar-day-header">${day}</div>`;
            });
            
            // Add empty cells for days before the first day of month
            for (let i = 0; i < startingDayOfWeek; i++) {
                const prevMonth = new Date(year, month, 0 - (startingDayOfWeek - 1 - i));
                calendarHtml += `
                    <div class="calendar-day other-month" onclick="selectCalendarDay('${formatDate(prevMonth)}')">
                        <div class="calendar-day-number">${prevMonth.getDate()}</div>
                    </div>
                `;
            }
            
            // Add days of current month
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const dateStr = formatDate(date);
                const isToday = formatDate(new Date()) === dateStr;
                
                // Get events for this day
                const dayEvents = getDayEvents(dateStr);
                
                calendarHtml += `
                    <div class="calendar-day ${isToday ? 'today' : ''}" onclick="selectCalendarDay('${dateStr}')">
                        <div class="calendar-day-number">${day}</div>
                        ${dayEvents.map(event => `<div class="calendar-event ${event.type}">${event.title}</div>`).join('')}
                    </div>
                `;
            }
            
            // Add empty cells for remaining days
            const remainingCells = 42 - (startingDayOfWeek + daysInMonth); // 6 rows * 7 days
            for (let i = 1; i <= remainingCells; i++) {
                const nextMonth = new Date(year, month + 1, i);
                if (nextMonth.getDate() <= 14) { // Only show first two weeks of next month
                    calendarHtml += `
                        <div class="calendar-day other-month" onclick="selectCalendarDay('${formatDate(nextMonth)}')">
                            <div class="calendar-day-number">${nextMonth.getDate()}</div>
                        </div>
                    `;
                }
            }
            
            calendarGrid.innerHTML = calendarHtml;
        }

        function getDayEvents(dateStr) {
            const events = [];
            
            // Add transactions for this day
            appData.transactions.forEach(transaction => {
                const transactionDate = (transaction.transaction_date || transaction.date)?.split('T')[0];
                if (transactionDate === dateStr) {
                    events.push({
                        type: `transaction-${transaction.type}`,
                        title: `${transaction.type === 'revenue' ? '+' : '-'}${formatCurrency(transaction.amount)}`
                    });
                }
            });
            
            // Add orders due on this day
            appData.orders.forEach(order => {
                const dueDate = order.due_date?.split('T')[0];
                if (dueDate === dateStr) {
                    events.push({
                        type: 'order',
                        title: `Ordine: ${order.client_name || 'Cliente'}`
                    });
                }
            });
            
            return events.slice(0, 3); // Show max 3 events per day
        }

        function selectCalendarDay(dateStr) {
            const dayEvents = getDayEvents(dateStr);
            const allDayTransactions = appData.transactions.filter(t => 
                (t.transaction_date || t.date)?.split('T')[0] === dateStr
            );
            const allDayOrders = appData.orders.filter(o => 
                o.due_date?.split('T')[0] === dateStr
            );
            
            let content = `
                <h3 style="color: var(--primary); margin-bottom: var(--space-6);">
                    📅 ${new Date(dateStr + 'T00:00:00').toLocaleDateString('it-IT', {
                        weekday: 'long',
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    })}
                </h3>
            `;
            
            if (allDayTransactions.length > 0) {
                content += '<h4 style="color: var(--success); margin: var(--space-4) 0;">💰 Transazioni</h4>';
                allDayTransactions.forEach(transaction => {
                    const typeColor = transaction.type === 'revenue' ? 'success' : 'error';
                    const typeIcon = transaction.type === 'revenue' ? '💰' : '💸';
                    content += `
                        <div style="padding: var(--space-3); margin: var(--space-2) 0; background: var(--surface); border-radius: var(--radius-lg); border-left: 3px solid var(--${typeColor});">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span><strong>${typeIcon} ${formatCurrency(transaction.amount)}</strong></span>
                                <span style="color: var(--text-muted); font-size: 0.875rem;">${transaction.client || 'N/A'}</span>
                            </div>
                            <div style="color: var(--text-secondary); margin-top: var(--space-1);">${transaction.description || 'N/A'}</div>
                        </div>
                    `;
                });
            }
            
            if (allDayOrders.length > 0) {
                content += '<h4 style="color: var(--warning); margin: var(--space-4) 0;">📋 Ordini in Scadenza</h4>';
                allDayOrders.forEach(order => {
                    content += `
                        <div style="padding: var(--space-3); margin: var(--space-2) 0; background: var(--surface); border-radius: var(--radius-lg); border-left: 3px solid var(--warning);">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span><strong>📋 ${order.client_name || 'Cliente'}</strong></span>
                                <span class="status-badge status-${order.status}">${getStatusLabel(order.status)}</span>
                            </div>
                            <div style="color: var(--text-secondary); margin-top: var(--space-1);">${order.client_email || 'Email non disponibile'}</div>
                        </div>
                    `;
                });
            }
            
            if (allDayTransactions.length === 0 && allDayOrders.length === 0) {
                content += `
                    <div style="text-align: center; padding: var(--space-8); color: var(--text-muted);">
                        <div style="font-size: 2rem; margin-bottom: var(--space-4);">📅</div>
                        <p>Nessun evento programmato per questo giorno</p>
                    </div>
                `;
            }
            
            // Show day view modal
            const dayView = document.getElementById('calendarDayView');
            const dayContent = document.getElementById('calendarDayContent');
            
            if (dayView && dayContent) {
                dayContent.innerHTML = content;
                dayView.classList.add('active');
            }
        }

        function closeCalendarDayView() {
            const dayView = document.getElementById('calendarDayView');
            if (dayView) {
                dayView.classList.remove('active');
            }
        }

        function changeMonth(delta) {
            appData.calendarDate.setMonth(appData.calendarDate.getMonth() + delta);
            renderCalendar();
        }

        function goToToday() {
            appData.calendarDate = new Date();
            renderCalendar();
        }

        // ===== ANALYTICS FUNCTIONS =====
        function renderMonthlyTrends() {
            const container = document.getElementById('monthlyTrends');
            if (!container) return;
            
            // Calculate monthly data for last 6 months
            const months = [];
            const currentDate = new Date();
            
            for (let i = 5; i >= 0; i--) {
                const date = new Date(currentDate.getFullYear(), currentDate.getMonth() - i, 1);
                const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                
                const monthRevenue = appData.transactions
                    .filter(t => {
                        const tDate = new Date(t.transaction_date || t.date);
                        const tMonthKey = `${tDate.getFullYear()}-${String(tDate.getMonth() + 1).padStart(2, '0')}`;
                        return t.type === 'revenue' && tMonthKey === monthKey;
                    })
                    .reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);
                
                const monthExpenses = appData.transactions
                    .filter(t => {
                        const tDate = new Date(t.transaction_date || t.date);
                        const tMonthKey = `${tDate.getFullYear()}-${String(tDate.getMonth() + 1).padStart(2, '0')}`;
                        return t.type === 'expense' && tMonthKey === monthKey;
                    })
                    .reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);
                
                months.push({
                    month: date.toLocaleDateString('it-IT', { month: 'short', year: '2-digit' }),
                    revenue: monthRevenue,
                    expenses: monthExpenses,
                    profit: monthRevenue - monthExpenses
                });
            }
            
            const maxValue = Math.max(...months.map(m => Math.max(m.revenue, m.expenses))) || 100;
            
            let chartsHtml = '<div style="display: flex; flex-direction: column; gap: var(--space-4);">';
            
            months.forEach(month => {
                const revenueHeight = (month.revenue / maxValue) * 100;
                const expenseHeight = (month.expenses / maxValue) * 100;
                const profitColor = month.profit >= 0 ? 'var(--success)' : 'var(--error)';
                
                chartsHtml += `
                    <div style="display: flex; align-items: end; gap: var(--space-2); padding: var(--space-2) 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
                        <div style="min-width: 60px; font-size: 0.875rem; font-weight: 600;">${month.month}</div>
                        <div style="flex: 1; display: flex; align-items: end; gap: var(--space-1); height: 60px;">
                            <div title="Entrate: ${formatCurrency(month.revenue)}" 
                                 style="width: 20px; background: var(--success); height: ${revenueHeight}%; min-height: 2px; border-radius: 2px;"></div>
                            <div title="Spese: ${formatCurrency(month.expenses)}" 
                                 style="width: 20px; background: var(--error); height: ${expenseHeight}%; min-height: 2px; border-radius: 2px;"></div>
                        </div>
                        <div style="min-width: 80px; text-align: right; font-size: 0.875rem; color: ${profitColor}; font-weight: 600;">
                            ${formatCurrency(month.profit)}
                        </div>
                    </div>
                `;
            });
            
            chartsHtml += '</div>';
            
            chartsHtml += `
                <div style="display: flex; justify-content: center; gap: var(--space-6); margin-top: var(--space-4); font-size: 0.875rem;">
                    <div style="display: flex; align-items: center; gap: var(--space-2);">
                        <div style="width: 12px; height: 12px; background: var(--success); border-radius: 2px;"></div>
                        <span>Entrate</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: var(--space-2);">
                        <div style="width: 12px; height: 12px; background: var(--error); border-radius: 2px;"></div>
                        <span>Spese</span>
                    </div>
                </div>
            `;
            
            container.innerHTML = chartsHtml;
        }

        function renderTopClients() {
            const container = document.getElementById('topClients');
            if (!container) return;
            
            const sortedClients = [...appData.clients]
                .sort((a, b) => (b.total_spent || 0) - (a.total_spent || 0))
                .slice(0, 5);
            
            if (sortedClients.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: var(--space-8); color: var(--text-muted);">
                        <div style="font-size: 2rem; margin-bottom: var(--space-4);">👤</div>
                        <p>Nessun cliente trovato</p>
                    </div>
                `;
                return;
            }
            
            const maxSpent = sortedClients[0]?.total_spent || 1;
            
            let clientsHtml = '<div style="display: flex; flex-direction: column; gap: var(--space-3);">';
            
            sortedClients.forEach((client, index) => {
                const percentage = (client.total_spent / maxSpent) * 100;
                const medalEmoji = ['🥇', '🥈', '🥉', '4️⃣', '5️⃣'][index];
                
                clientsHtml += `
                    <div style="padding: var(--space-3); background: var(--surface); border-radius: var(--radius-lg); border: 1px solid rgba(255,255,255,0.1);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-2);">
                            <div style="display: flex; align-items: center; gap: var(--space-2);">
                                <span style="font-size: 1.2rem;">${medalEmoji}</span>
                                <strong>${client.client_name || client.name || 'N/A'}</strong>
                            </div>
                            <span style="color: var(--success); font-weight: 600;">${formatCurrency(client.total_spent || 0)}</span>
                        </div>
                        <div style="width: 100%; height: 8px; background: rgba(255,255,255,0.1); border-radius: 4px; overflow: hidden;">
                            <div style="width: ${percentage}%; height: 100%; background: var(--gradient-primary); transition: width 0.3s ease;"></div>
                        </div>
                    </div>
                `;
            });
            
            clientsHtml += '</div>';
            container.innerHTML = clientsHtml;
        }

        function renderMonthlyPerformance() {
            const container = document.getElementById('monthlyPerformance');
            if (!container) return;
            
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            
            const thisMonthTransactions = appData.transactions.filter(t => {
                const date = new Date(t.transaction_date || t.date);
                return date.getMonth() === currentMonth && date.getFullYear() === currentYear;
            });
            
            const thisMonthRevenue = thisMonthTransactions
                .filter(t => t.type === 'revenue')
                .reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);
            
            const thisMonthExpenses = thisMonthTransactions
                .filter(t => t.type === 'expense')
                .reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);
            
            const thisMonthProfit = thisMonthRevenue - thisMonthExpenses;
            
            const thisMonthOrders = appData.orders.filter(order => {
                const date = new Date(order.created_at);
                return date.getMonth() === currentMonth && date.getFullYear() === currentYear;
            }).length;
            
            const completedOrders = appData.orders.filter(order => 
                order.status === 'completed'
            ).length;
            
            const completionRate = appData.orders.length > 0 ? 
                (completedOrders / appData.orders.length * 100).toFixed(1) : 0;
            
            const performanceHtml = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: var(--space-4);">
                    <div style="text-align: center; padding: var(--space-4); background: var(--surface); border-radius: var(--radius-lg);">
                        <div style="font-size: 1.5rem; color: var(--success); font-weight: 700; margin-bottom: var(--space-1);">
                            ${formatCurrency(thisMonthRevenue)}
                        </div>
                        <div style="font-size: 0.875rem; color: var(--text-muted);">Entrate Mese</div>
                    </div>
                    
                    <div style="text-align: center; padding: var(--space-4); background: var(--surface); border-radius: var(--radius-lg);">
                        <div style="font-size: 1.5rem; color: var(--error); font-weight: 700; margin-bottom: var(--space-1);">
                            ${formatCurrency(thisMonthExpenses)}
                        </div>
                        <div style="font-size: 0.875rem; color: var(--text-muted);">Spese Mese</div>
                    </div>
                    
                    <div style="text-align: center; padding: var(--space-4); background: var(--surface); border-radius: var(--radius-lg);">
                        <div style="font-size: 1.5rem; color: ${thisMonthProfit >= 0 ? 'var(--success)' : 'var(--error)'}; font-weight: 700; margin-bottom: var(--space-1);">
                            ${formatCurrency(thisMonthProfit)}
                        </div>
                        <div style="font-size: 0.875rem; color: var(--text-muted);">Profitto Mese</div>
                    </div>
                    
                    <div style="text-align: center; padding: var(--space-4); background: var(--surface); border-radius: var(--radius-lg);">
                        <div style="font-size: 1.5rem; color: var(--primary); font-weight: 700; margin-bottom: var(--space-1);">
                            ${thisMonthOrders}
                        </div>
                        <div style="font-size: 0.875rem; color: var(--text-muted);">Ordini Mese</div>
                    </div>
                    
                    <div style="text-align: center; padding: var(--space-4); background: var(--surface); border-radius: var(--radius-lg);">
                        <div style="font-size: 1.5rem; color: var(--warning); font-weight: 700; margin-bottom: var(--space-1);">
                            ${completionRate}%
                        </div>
                        <div style="font-size: 0.875rem; color: var(--text-muted);">Tasso Completamento</div>
                    </div>
                </div>
            `;
            
            container.innerHTML = performanceHtml;
        }

        function renderKPIDashboard() {
            const container = document.getElementById('kpiDashboard');
            if (!container) return;
            
            // Calculate average order value
            const revenueTransactions = appData.transactions.filter(t => t.type === 'revenue');
            const avgOrderValue = revenueTransactions.length > 0 ? 
                revenueTransactions.reduce((sum, t) => sum + parseFloat(t.amount || 0), 0) / revenueTransactions.length : 0;
            
            // Active clients (clients with transactions in last 3 months)
            const threeMonthsAgo = new Date();
            threeMonthsAgo.setMonth(threeMonthsAgo.getMonth() - 3);
            
            const activeClients = new Set(
                appData.transactions
                    .filter(t => new Date(t.transaction_date || t.date) >= threeMonthsAgo)
                    .map(t => t.client)
            ).size;
            
            // Low stock items
            const lowStockItems = appData.inventory.filter(item => 
                item.quantity <= item.threshold
            ).length;
            
            // Total inventory value
            const inventoryValue = appData.inventory.reduce((sum, item) => 
                sum + (item.quantity * item.price), 0
            );
            
            // Pending orders
            const pendingOrders = appData.orders.filter(order => 
                order.status === 'pending' || order.status === 'in-progress'
            ).length;
            
            const kpiHtml = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: var(--space-4);">
                    <div style="text-align: center; padding: var(--space-4); background: var(--surface); border-radius: var(--radius-lg);">
                        <div style="font-size: 1.2rem; color: var(--primary); font-weight: 700; margin-bottom: var(--space-1);">
                            ${formatCurrency(avgOrderValue)}
                        </div>
                        <div style="font-size: 0.875rem; color: var(--text-muted);">Valore Medio Ordine</div>
                    </div>
                    
                    <div style="text-align: center; padding: var(--space-4); background: var(--surface); border-radius: var(--radius-lg);">
                        <div style="font-size: 1.2rem; color: var(--success); font-weight: 700; margin-bottom: var(--space-1);">
                            ${activeClients}
                        </div>
                        <div style="font-size: 0.875rem; color: var(--text-muted);">Clienti Attivi (3m)</div>
                    </div>
                    
                    <div style="text-align: center; padding: var(--space-4); background: var(--surface); border-radius: var(--radius-lg);">
                        <div style="font-size: 1.2rem; color: ${lowStockItems > 0 ? 'var(--error)' : 'var(--success)'}; font-weight: 700; margin-bottom: var(--space-1);">
                            ${lowStockItems}
                        </div>
                        <div style="font-size: 0.875rem; color: var(--text-muted);">Scorte Basse</div>
                    </div>
                    
                    <div style="text-align: center; padding: var(--space-4); background: var(--surface); border-radius: var(--radius-lg);">
                        <div style="font-size: 1.2rem; color: var(--info); font-weight: 700; margin-bottom: var(--space-1);">
                            ${formatCurrency(inventoryValue)}
                        </div>
                        <div style="font-size: 0.875rem; color: var(--text-muted);">Valore Inventario</div>
                    </div>
                    
                    <div style="text-align: center; padding: var(--space-4); background: var(--surface); border-radius: var(--radius-lg);">
                        <div style="font-size: 1.2rem; color: var(--warning); font-weight: 700; margin-bottom: var(--space-1);">
                            ${pendingOrders}
                        </div>
                        <div style="font-size: 0.875rem; color: var(--text-muted);">Ordini In Sospeso</div>
                    </div>
                </div>
            `;
            
            container.innerHTML = kpiHtml;
        }

        // ===== SEARCH FUNCTIONALITY =====
        function setupSearchListeners() {
            const orderSearch = document.getElementById('orderSearch');
            const transactionSearch = document.getElementById('transactionSearch');
            const clientSearch = document.getElementById('clientSearch');
            const inventorySearch = document.getElementById('inventorySearch');
            
            if (orderSearch) {
                orderSearch.addEventListener('input', (e) => {
                    // This would implement search functionality
                    console.log('Search orders:', e.target.value);
                });
            }
            
            if (transactionSearch) {
                transactionSearch.addEventListener('input', (e) => {
                    // This would implement search functionality
                    console.log('Search transactions:', e.target.value);
                });
            }
            
            if (clientSearch) {
                clientSearch.addEventListener('input', (e) => {
                    // This would implement search functionality
                    console.log('Search clients:', e.target.value);
                });
            }
            
            if (inventorySearch) {
                inventorySearch.addEventListener('input', (e) => {
                    // This would implement search functionality
                    console.log('Search inventory:', e.target.value);
                });
            }
        }

        // ===== INITIALIZATION =====
        async function initializeApp() {
            try {
                console.log('🚀 Initializing RetroAvia v4.2...');
                
                // Initialize network monitoring
                initializeNetworkMonitoring();
                
                // Load data from localStorage first
                loadDataFromLocalStorage();
                
                // Update UI with local data
                updateClientTotalSpent();
                updateDashboard();
                
                // Initialize Supabase connection
                await initializeSupabase();
                
                // If connected, sync data
                if (appData.connected) {
                    await syncData();
                }
                
                // Setup search listeners
                setupSearchListeners();
                
                // Set up periodic sync
                setInterval(() => {
                    if (appData.connected && appData.syncQueue.length > 0) {
                        processSyncQueue();
                    }
                }, 30000); // Try to sync every 30 seconds
                
                console.log('✅ RetroAvia initialized successfully!');
                
            } catch (error) {
                console.error('💥 App initialization failed:', error);
                showMessage('Errore nell\'inizializzazione - Modalità offline', 'error');
                updateConnectionStatus('disconnected', 'Errore init');
            }
        }

        // ===== EVENT LISTENERS =====
        document.addEventListener('DOMContentLoaded', initializeApp);

        // Close modals when clicking outside
        document.addEventListener('click', (e) => {
            const modal = document.getElementById('modal');
            const confirmDialog = document.getElementById('confirmDialog');
            const calendarDayView = document.getElementById('calendarDayView');
            
            if (e.target === modal) closeModal();
            if (e.target === confirmDialog) confirmDialog.classList.remove('active');
            if (e.target === calendarDayView) closeCalendarDayView();
        });

        // Handle escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeModal();
                document.getElementById('confirmDialog')?.classList.remove('active');
                closeCalendarDayView();
            }
        });

        console.log('📱 RetroAvia 4.2 - Game Boy Business Manager loaded!');
    </script>
</body>
</html>
