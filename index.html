<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RetroAvia 4.0 - Game Boy Business Manager</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary: #3b82f6;
            --primary-dark: #1e40af;
            --secondary: #10b981;
            --accent: #f59e0b;
            --accent-dark: #d97706;
            --bg-primary: #0f0f23;
            --bg-secondary: #1a1b3c;
            --bg-tertiary: #252647;
            --surface: #2d2f52;
            --surface-elevated: #363862;
            --text-primary: #ffffff;
            --text-secondary: #e2e8f0;
            --text-muted: #94a3b8;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --info: #3b82f6;
            --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-secondary: linear-gradient(135deg, #667eea 0%, #4338ca 100%);
            --gradient-card: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%);
            --gradient-surface: linear-gradient(135deg, var(--surface) 0%, var(--surface-elevated) 100%);
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --shadow-2xl: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            --radius-sm: 0.375rem;
            --radius-md: 0.5rem;
            --radius-lg: 1rem;
            --radius-xl: 1.5rem;
            --radius-2xl: 2rem;
            --space-1: 0.25rem;
            --space-2: 0.5rem;
            --space-3: 0.75rem;
            --space-4: 1rem;
            --space-5: 1.25rem;
            --space-6: 1.5rem;
            --space-8: 2rem;
            --space-10: 2.5rem;
            --space-12: 3rem;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: radial-gradient(ellipse at top, rgba(59, 130, 246, 0.15) 0%, transparent 70%), 
                        radial-gradient(ellipse at bottom right, rgba(16, 185, 129, 0.1) 0%, transparent 70%),
                        var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: var(--space-6);
        }
        
        .header {
            text-align: center;
            margin-bottom: var(--space-8);
            position: relative;
        }
        
        .logo {
            font-family: 'Orbitron', monospace;
            font-size: clamp(2rem, 5vw, 3.5rem);
            font-weight: 900;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: var(--space-2);
            animation: logoGlow 4s ease-in-out infinite alternate;
            position: relative;
        }
        
        .logo::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--gradient-primary);
            opacity: 0.1;
            filter: blur(20px);
            animation: logoGlow 4s ease-in-out infinite alternate;
            z-index: -1;
        }
        
        @keyframes logoGlow {
            0% { filter: drop-shadow(0 0 20px rgba(59, 130, 246, 0.5)); }
            100% { filter: drop-shadow(0 0 40px rgba(102, 126, 234, 0.8)); }
        }
        
        .subtitle {
            font-size: 1.125rem;
            color: var(--text-muted);
            font-weight: 500;
            margin-bottom: var(--space-4);
        }
        
        .version-badge {
            display: inline-flex;
            align-items: center;
            gap: var(--space-2);
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: var(--space-2) var(--space-4);
            border-radius: var(--radius-xl);
            font-size: 0.875rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            box-shadow: var(--shadow-lg);
        }
        
        .connection-status {
            position: absolute;
            top: var(--space-4);
            right: var(--space-4);
            display: flex;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-2) var(--space-3);
            background: var(--gradient-surface);
            border-radius: var(--radius-lg);
            font-size: 0.875rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }
        
        .connection-status.connected {
            border-color: var(--success);
            box-shadow: 0 0 10px rgba(16, 185, 129, 0.3);
        }
        
        .connection-status.disconnected {
            border-color: var(--error);
            box-shadow: 0 0 10px rgba(239, 68, 68, 0.3);
        }
        
        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        .status-indicator.connected {
            background: var(--success);
        }
        
        .status-indicator.disconnected {
            background: var(--error);
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .nav {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: var(--space-3);
            margin: var(--space-8) 0;
            padding: var(--space-6);
            background: var(--gradient-card);
            border-radius: var(--radius-2xl);
            border: 1px solid rgba(255, 255, 255, 0.1);
            -webkit-backdrop-filter: blur(20px);
            backdrop-filter: blur(20px);
            box-shadow: var(--shadow-2xl);
            position: relative;
            overflow: hidden;
        }
        
        .nav::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
        }
        
        .nav-btn {
            background: var(--gradient-surface);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--text-secondary);
            padding: var(--space-3) var(--space-5);
            border-radius: var(--radius-lg);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            display: flex;
            align-items: center;
            gap: var(--space-2);
            position: relative;
            overflow: hidden;
        }
        
        .nav-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transition: left 0.5s ease;
        }
        
        .nav-btn:hover::before {
            left: 100%;
        }
        
        .nav-btn:hover, .nav-btn:focus {
            transform: translateY(-2px) scale(1.02);
            border-color: var(--primary);
            color: var(--text-primary);
            outline: none;
            box-shadow: var(--shadow-lg);
        }
        
        .nav-btn.active {
            background: var(--gradient-primary);
            color: white;
            transform: translateY(-2px) scale(1.02);
            box-shadow: var(--shadow-xl);
        }
        
        .page {
            display: none;
            animation: fadeInUp 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .page.active {
            display: block;
        }
        
        @keyframes fadeInUp {
            from { 
                opacity: 0; 
                transform: translateY(30px) scale(0.95); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0) scale(1); 
            }
        }
        
        .card {
            background: var(--gradient-card);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--radius-2xl);
            padding: var(--space-8);
            margin: var(--space-6) 0;
            box-shadow: var(--shadow-xl);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
        }
        
        .card:hover {
            transform: translateY(-4px) scale(1.01);
            border-color: rgba(255, 255, 255, 0.2);
            box-shadow: var(--shadow-2xl);
        }
        
        .card h3 {
            font-family: 'Orbitron', monospace;
            font-size: 1.5rem;
            margin-bottom: var(--space-6);
            color: var(--accent);
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: var(--space-4);
        }
        
        .grid {
            display: grid;
            gap: var(--space-6);
        }
        
        .grid-2 {
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
        }
        
        .grid-3 {
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        }
        
        .grid-4 {
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        }
        
        .stat-box {
            background: var(--gradient-primary);
            border-radius: var(--radius-2xl);
            padding: var(--space-8);
            text-align: center;
            color: white;
            font-weight: 700;
            box-shadow: var(--shadow-xl);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            cursor: pointer;
        }
        
        .stat-box:hover {
            transform: scale(1.05) translateY(-8px);
            box-shadow: var(--shadow-2xl);
        }
        
        .stat-box::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent 30%, rgba(255,255,255,0.15) 50%, transparent 70%);
            transform: translateX(-100%);
            transition: transform 0.6s;
        }
        
        .stat-box:hover::before {
            transform: translateX(100%);
        }
        
        .stat-value {
            font-family: 'Orbitron', monospace;
            font-size: clamp(1.5rem, 4vw, 2.5rem);
            font-weight: 900;
            margin-bottom: var(--space-2);
            position: relative;
            z-index: 1;
        }
        
        .stat-label {
            font-size: 0.875rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            opacity: 0.9;
            position: relative;
            z-index: 1;
        }
        
        .btn {
            display: inline-flex;
            align-items: center;
            gap: var(--space-2);
            background: var(--gradient-primary);
            border: none;
            color: white;
            padding: var(--space-3) var(--space-5);
            border-radius: var(--radius-lg);
            cursor: pointer;
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            margin: var(--space-2);
            text-decoration: none;
            position: relative;
            overflow: hidden;
            box-shadow: var(--shadow-md);
        }
        
        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s ease;
        }
        
        .btn:hover::before {
            left: 100%;
        }
        
        .btn:hover, .btn:focus {
            transform: translateY(-2px) scale(1.02);
            outline: none;
            box-shadow: var(--shadow-xl);
        }
        
        .btn:active {
            transform: translateY(0) scale(0.98);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-success { background: linear-gradient(135deg, var(--success), #059669); }
        .btn-warning { background: linear-gradient(135deg, var(--warning), #d97706); }
        .btn-error { background: linear-gradient(135deg, var(--error), #dc2626); }
        .btn-info { background: linear-gradient(135deg, var(--info), #1e40af); }
        .btn-secondary { 
            background: var(--gradient-surface); 
            color: var(--text-secondary); 
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        /* Calendar Styles */
        .calendar-container {
            background: var(--gradient-card);
            border-radius: var(--radius-2xl);
            padding: var(--space-6);
            box-shadow: var(--shadow-xl);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-6);
            padding-bottom: var(--space-4);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .calendar-month {
            font-family: 'Orbitron', monospace;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent);
        }
        
        .calendar-nav {
            display: flex;
            gap: var(--space-2);
        }
        
        .calendar-nav-btn {
            width: 40px;
            height: 40px;
            border-radius: var(--radius-lg);
            background: var(--gradient-surface);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        
        .calendar-nav-btn:hover {
            background: var(--gradient-primary);
            transform: scale(1.1);
        }
        
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: var(--radius-lg);
            overflow: hidden;
        }
        
        .calendar-day-header {
            background: var(--surface);
            padding: var(--space-3);
            text-align: center;
            font-weight: 600;
            font-size: 0.875rem;
            color: var(--accent);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .calendar-day {
            background: var(--bg-secondary);
            min-height: 100px;
            padding: var(--space-2);
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            display: flex;
            flex-direction: column;
        }
        
        .calendar-day:hover {
            background: var(--surface);
        }
        
        .calendar-day.other-month {
            opacity: 0.3;
        }
        
        .calendar-day.today {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(102, 126, 234, 0.2));
            border: 1px solid var(--primary);
        }
        
        .calendar-day.selected {
            background: var(--gradient-primary);
            color: white;
        }
        
        .calendar-day-number {
            font-weight: 600;
            margin-bottom: var(--space-1);
            font-size: 0.875rem;
        }
        
        .calendar-event {
            background: var(--gradient-primary);
            color: white;
            padding: 1px var(--space-1);
            border-radius: var(--radius-sm);
            font-size: 0.75rem;
            margin-bottom: 1px;
            cursor: pointer;
            transition: all 0.2s ease;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .calendar-event.order {
            background: linear-gradient(135deg, var(--warning), var(--accent-dark));
        }
        
        .calendar-event.transaction-revenue {
            background: linear-gradient(135deg, var(--success), #059669);
        }
        
        .calendar-event.transaction-expense {
            background: linear-gradient(135deg, var(--error), #dc2626);
        }
        
        .calendar-event:hover {
            transform: scale(1.02);
            z-index: 10;
        }
        
        .calendar-day-view {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
        }
        
        .calendar-day-view.active {
            display: flex;
        }
        
        .calendar-day-content {
            background: var(--gradient-card);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: var(--radius-2xl);
            padding: var(--space-8);
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }
        
        /* Form Improvements */
        .form-group {
            margin: var(--space-5) 0;
        }
        
        .form-group label {
            display: block;
            margin-bottom: var(--space-2);
            color: var(--accent);
            font-weight: 600;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: var(--space-4);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--radius-lg);
            background: var(--surface);
            color: var(--text-primary);
            font-family: 'Inter', sans-serif;
            font-size: 1rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: var(--shadow-sm);
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15), var(--shadow-md);
            transform: scale(1.01);
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }
        
        .quick-actions {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-3);
            justify-content: center;
        }
        
        .ai-panel {
            background: linear-gradient(135deg, var(--bg-secondary), var(--bg-tertiary));
            border: 2px solid var(--accent);
            border-radius: var(--radius-2xl);
            padding: var(--space-8);
            margin: var(--space-6) 0;
            position: relative;
            box-shadow: 0 0 50px rgba(245, 158, 11, 0.2);
            overflow: hidden;
        }
        
        .ai-panel::before {
            content: 'ü§ñ SPIDER-AI NEURAL NETWORK';
            position: absolute;
            top: -15px;
            left: var(--space-6);
            background: var(--accent);
            color: var(--bg-primary);
            padding: var(--space-2) var(--space-4);
            border-radius: var(--radius-lg);
            font-family: 'Orbitron', monospace;
            font-weight: 700;
            font-size: 0.75rem;
            letter-spacing: 0.1em;
        }
        
        .ai-suggestions {
            margin: var(--space-6) 0;
            padding: var(--space-6);
            background: rgba(245, 158, 11, 0.1);
            border-radius: var(--radius-lg);
            border: 1px solid var(--accent);
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
        }
        
        .ai-suggestions p {
            margin: var(--space-2) 0;
            line-height: 1.6;
        }
        
        .message-box {
            padding: var(--space-6);
            border-radius: var(--radius-lg);
            margin: var(--space-6) 0;
            display: none;
            font-weight: 500;
            border: 1px solid;
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
            box-shadow: var(--shadow-lg);
        }
        
        .error-box {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.15), rgba(220, 38, 38, 0.15));
            color: #fecaca;
            border-color: var(--error);
        }
        
        .success-box {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(5, 150, 105, 0.15));
            color: #a7f3d0;
            border-color: var(--success);
        }
        
        .message-box.show {
            display: block;
            animation: slideInRight 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        @keyframes slideInRight {
            from { transform: translateX(100%) scale(0.95); opacity: 0; }
            to { transform: translateX(0) scale(1); opacity: 1; }
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            -webkit-backdrop-filter: blur(15px);
            backdrop-filter: blur(15px);
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: var(--gradient-card);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: var(--radius-2xl);
            padding: var(--space-8);
            max-width: 800px;
            width: 90%;
            position: relative;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: var(--shadow-2xl);
            animation: modalSlideIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        @keyframes modalSlideIn {
            from { transform: scale(0.95) translateY(-20px); opacity: 0; }
            to { transform: scale(1) translateY(0); opacity: 1; }
        }
        
        .close {
            position: absolute;
            top: var(--space-4);
            right: var(--space-4);
            font-size: 2rem;
            cursor: pointer;
            color: var(--error);
            transition: all 0.3s ease;
            background: none;
            border: none;
            padding: var(--space-2);
            border-radius: var(--radius-lg);
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .close:hover, .close:focus {
            color: white;
            background: var(--error);
            transform: rotate(90deg) scale(1.1);
            outline: none;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin: var(--space-6) 0;
            background: var(--gradient-surface);
            border-radius: var(--radius-lg);
            overflow: hidden;
            box-shadow: var(--shadow-lg);
        }
        
        .data-table th,
        .data-table td {
            padding: var(--space-4);
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .data-table th {
            background: var(--surface);
            color: var(--accent);
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.875rem;
            letter-spacing: 0.05em;
        }
        
        .data-table tr {
            transition: all 0.3s ease;
        }
        
        .data-table tr:hover {
            background: rgba(255, 255, 255, 0.05);
            transform: scale(1.01);
        }
        
        .search-box {
            width: 100%;
            max-width: 400px;
            margin: 0 auto var(--space-6);
            padding: var(--space-4);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--radius-lg);
            background: var(--surface);
            color: var(--text-primary);
            font-family: 'Inter', sans-serif;
            box-shadow: var(--shadow-md);
            transition: all 0.3s ease;
        }
        
        .search-box:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15), var(--shadow-lg);
            transform: scale(1.02);
        }
        
        .empty-state {
            text-align: center;
            padding: var(--space-10);
            color: var(--text-muted);
        }
        
        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: var(--space-4);
            opacity: 0.7;
        }

        /* Loading State */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Enhanced Status Badges */
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.375rem 0.75rem;
            border-radius: var(--radius-lg);
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            box-shadow: var(--shadow-sm);
            transition: all 0.3s ease;
        }

        .status-badge:hover {
            transform: scale(1.05);
            box-shadow: var(--shadow-md);
        }

        .status-pending {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.2), rgba(217, 119, 6, 0.2));
            color: var(--warning);
            border: 1px solid var(--warning);
        }

        .status-in-progress {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(30, 64, 175, 0.2));
            color: var(--primary);
            border: 1px solid var(--primary);
        }

        .status-completed {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(5, 150, 105, 0.2));
            color: var(--success);
            border: 1px solid var(--success);
        }

        .status-cancelled {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(220, 38, 38, 0.2));
            color: var(--error);
            border: 1px solid var(--error);
        }

        /* Confirmation Dialog - Fixed visibility issue */
        .confirm-dialog {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            -webkit-backdrop-filter: blur(15px);
            backdrop-filter: blur(15px);
        }

        .confirm-dialog.active {
            display: flex;
        }

        .confirm-content {
            background: var(--gradient-card);
            border: 2px solid var(--error);
            border-radius: var(--radius-2xl);
            padding: var(--space-8);
            max-width: 500px;
            width: 90%;
            text-align: center;
            box-shadow: var(--shadow-2xl);
            position: relative;
            animation: modalSlideIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .confirm-icon {
            font-size: 3rem;
            margin-bottom: var(--space-4);
        }

        .confirm-title {
            color: var(--error);
            font-family: 'Orbitron', monospace;
            font-size: 1.5rem;
            margin-bottom: var(--space-4);
        }

        .confirm-message {
            color: var(--text-secondary);
            margin-bottom: var(--space-6);
            line-height: 1.6;
        }

        .confirm-actions {
            display: flex;
            gap: var(--space-4);
            justify-content: center;
        }

        /* Form Grid */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: var(--space-4);
        }

        .form-grid-full {
            grid-column: 1 / -1;
        }

        /* Order details styling */
        .order-details {
            margin: var(--space-6) 0;
            padding: var(--space-6);
            background: var(--surface);
            border-radius: var(--radius-lg);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .order-details h4 {
            color: var(--primary);
            margin-bottom: var(--space-4);
            font-family: 'Orbitron', monospace;
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        .order-spec {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: var(--space-2) 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .order-spec:last-child {
            border-bottom: none;
        }

        .spec-label {
            color: var(--text-muted);
            font-weight: 600;
            min-width: 120px;
            flex-shrink: 0;
        }

        .spec-value {
            color: var(--text-primary);
            text-align: right;
            flex-grow: 1;
            margin-left: var(--space-4);
        }

        /* Chart styles */
        .chart-container {
            padding: var(--space-4);
        }

        .chart-bar {
            border-radius: var(--radius-sm);
            transition: all 0.3s ease;
            margin-bottom: var(--space-1);
        }

        .chart-bar:hover {
            transform: scale(1.02);
            box-shadow: var(--shadow-md);
        }

        /* Responsive Improvements */
        @media (max-width: 768px) {
            .container { 
                padding: var(--space-4); 
            }
            
            .nav { 
                flex-direction: column; 
                gap: var(--space-2);
                padding: var(--space-4);
            }
            
            .nav-btn { 
                width: 100%; 
                justify-content: center;
            }
            
            .grid-2, .grid-3, .grid-4 { 
                grid-template-columns: 1fr; 
            }
            
            .card { 
                padding: var(--space-6); 
                margin: var(--space-4) 0;
            }
            
            .quick-actions {
                flex-direction: column;
                align-items: stretch;
            }
            
            .quick-actions .btn {
                width: 100%;
                justify-content: center;
                margin: var(--space-2) 0;
            }
            
            .data-table {
                font-size: 0.875rem;
            }
            
            .data-table th,
            .data-table td {
                padding: var(--space-3);
            }

            .calendar-day {
                min-height: 80px;
                padding: var(--space-1);
            }

            .calendar-event {
                font-size: 0.625rem;
                padding: 1px 2px;
            }
            
            .connection-status {
                position: relative;
                top: auto;
                right: auto;
                margin: var(--space-4) auto;
                width: fit-content;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .spec-label {
                min-width: 100px;
            }

            .order-spec {
                flex-direction: column;
                align-items: flex-start;
                gap: var(--space-1);
            }

            .spec-value {
                text-align: left;
                margin-left: 0;
                margin-top: var(--space-1);
            }
        }
        
        @media (max-width: 480px) {
            .modal-content {
                width: 95%;
                padding: var(--space-6);
            }
            
            .stat-value {
                font-size: 1.5rem;
            }
            
            .data-table {
                display: block;
                overflow-x: auto;
                white-space: nowrap;
            }

            .calendar-day {
                min-height: 60px;
            }

            .calendar-day-number {
                font-size: 0.75rem;
            }

            .calendar-event {
                font-size: 0.5rem;
                padding: 1px;
            }

            .confirm-content {
                width: 95%;
                padding: var(--space-6);
            }

            .confirm-actions {
                flex-direction: column;
            }
        }

        /* Enhanced Animations */
        @media (prefers-reduced-motion: no-preference) {
            .card, .btn, .nav-btn, .stat-box {
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            }
            
            .page.active {
                animation: fadeInUp 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            }
        }

        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="connection-status" id="connectionStatus">
                <div class="status-indicator" id="statusIndicator"></div>
                <span id="statusText">Connessione...</span>
            </div>
            <h1 class="logo">üï∑Ô∏è RetroAvia</h1>
            <p class="subtitle">Advanced Game Boy Business Manager</p>
            <div class="version-badge">
                <span>‚ö°</span>
                Version 4.0 - Supabase Edition
            </div>
        </header>
        
        <nav class="nav" role="navigation" aria-label="Main navigation">
            <button class="nav-btn active" onclick="showPage('dashboard')" aria-label="Dashboard">
                <span>üìä</span> Dashboard
            </button>
            <button class="nav-btn" onclick="showPage('orders')" aria-label="Ordini">
                <span>üìã</span> Ordini
            </button>
            <button class="nav-btn" onclick="showPage('transactions')" aria-label="Transazioni">
                <span>üí∞</span> Transazioni
            </button>
            <button class="nav-btn" onclick="showPage('clients')" aria-label="Clienti">
                <span>üë§</span> Clienti
            </button>
            <button class="nav-btn" onclick="showPage('inventory')" aria-label="Inventario">
                <span>üì¶</span> Inventario
            </button>
            <button class="nav-btn" onclick="showPage('calendar')" aria-label="Calendario">
                <span>üìÖ</span> Calendario
            </button>
            <button class="nav-btn" onclick="showPage('analytics')" aria-label="Analytics">
                <span>üìà</span> Analytics
            </button>
        </nav>
        
        <div class="error-box message-box" id="errorBox" role="alert"></div>
        <div class="success-box message-box" id="successBox" role="status"></div>
        
        <!-- Dashboard Page -->
        <div class="page active" id="dashboard" role="main">
            <div class="grid grid-4">
                <div class="stat-box">
                    <div class="stat-value" id="totalRevenue">‚Ç¨0</div>
                    <div class="stat-label">Guadagni Totali</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="totalExpenses">‚Ç¨0</div>
                    <div class="stat-label">Spese Totali</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="netProfit">‚Ç¨0</div>
                    <div class="stat-label">Profitto Netto</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="totalOrders">0</div>
                    <div class="stat-label">Ordini Totali</div>
                </div>
            </div>
            
            <div class="ai-panel">
                <h3>üß† Spider-AI Neural Analysis</h3>
                <div class="ai-suggestions" id="aiSuggestions">
                    <p>‚Ä¢ Benvenuto in RetroAvia 4.0! Sistema AI pronto per l'analisi.</p>
                    <p>‚Ä¢ Connesso a Supabase per sincronizzazione multi-device!</p>
                </div>
                <div class="quick-actions">
                    <button class="btn" onclick="runAIAnalysis()">
                        <span>üß†</span> Analizza Ora
                    </button>
                    <button class="btn btn-secondary" onclick="generatePredictions()">
                        <span>üîÆ</span> Predizioni AI
                    </button>
                    <button class="btn btn-info" onclick="syncData()">
                        <span>üîÑ</span> Sincronizza
                    </button>
                </div>
            </div>
            
            <div class="card">
                <h3><span>‚ö°</span> Azioni Rapide</h3>
                <div class="quick-actions">
                    <button class="btn btn-success" onclick="openQuickSale()">
                        <span>üí∞</span> Vendita Rapida
                    </button>
                    <button class="btn btn-warning" onclick="openQuickOrder()">
                        <span>üìã</span> Nuovo Ordine
                    </button>
                    <button class="btn btn-warning" onclick="openQuickClient()">
                        <span>üë§</span> Cliente Rapido
                    </button>
                    <button class="btn" onclick="openQuickInventory()">
                        <span>üì¶</span> Componente Rapido
                    </button>
                    <button class="btn btn-secondary" onclick="exportBackup()">
                        <span>üíæ</span> Backup
                    </button>
                </div>
            </div>
        </div>

        <!-- Calendar Page -->
        <div class="page" id="calendar" role="main">
            <div class="card">
                <h3><span>üìÖ</span> Calendario Business</h3>
                <div class="calendar-container">
                    <div class="calendar-header">
                        <div class="calendar-month" id="calendarMonth">Gennaio 2025</div>
                        <div class="calendar-nav">
                            <button class="calendar-nav-btn" onclick="changeMonth(-1)" aria-label="Mese precedente">‚Äπ</button>
                            <button class="calendar-nav-btn" onclick="goToToday()" aria-label="Vai a oggi">üìÖ</button>
                            <button class="calendar-nav-btn" onclick="changeMonth(1)" aria-label="Mese successivo">‚Ä∫</button>
                        </div>
                    </div>
                    <div class="calendar-grid" id="calendarGrid">
                        <!-- Calendar will be generated here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Calendar Day View Modal -->
        <div class="calendar-day-view" id="calendarDayView">
            <div class="calendar-day-content">
                <button class="close" onclick="closeCalendarDayView()" aria-label="Chiudi">&times;</button>
                <div id="calendarDayContent">
                    <!-- Day details will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Orders Page -->
        <div class="page" id="orders" role="main">
            <div class="card">
                <h3><span>üìã</span> Gestione Ordini</h3>
                <div class="quick-actions">
                    <button class="btn btn-success" onclick="addOrder()">
                        <span>üìã</span> Nuovo Ordine
                    </button>
                </div>
                <input type="text" class="search-box" id="orderSearch" placeholder="üîç Cerca ordini..." aria-label="Cerca ordini">
                <div id="ordersContainer">
                    <!-- Orders will be loaded here -->
                </div>
            </div>
        </div>
        
        <!-- Transactions Page -->
        <div class="page" id="transactions" role="main">
            <div class="card">
                <h3><span>üí∞</span> Gestione Transazioni</h3>
                <div class="quick-actions">
                    <button class="btn btn-success" onclick="addTransaction('revenue')">
                        <span>üí∞</span> Nuova Entrata
                    </button>
                    <button class="btn btn-error" onclick="addTransaction('expense')">
                        <span>üí∏</span> Nuova Spesa
                    </button>
                </div>
                <input type="text" class="search-box" id="transactionSearch" placeholder="üîç Cerca transazioni..." aria-label="Cerca transazioni">
                <div id="transactionsContainer">
                    <!-- Transactions will be loaded here -->
                </div>
            </div>
        </div>
        
        <!-- Clients Page -->
        <div class="page" id="clients" role="main">
            <div class="card">
                <h3><span>üë§</span> Gestione Clienti</h3>
                <div class="quick-actions">
                    <button class="btn btn-success" onclick="addClient()">
                        <span>üë§</span> Nuovo Cliente
                    </button>
                </div>
                <input type="text" class="search-box" id="clientSearch" placeholder="üîç Cerca clienti..." aria-label="Cerca clienti">
                <div id="clientsContainer">
                    <!-- Clients will be loaded here -->
                </div>
            </div>
        </div>
        
        <!-- Inventory Page -->
        <div class="page" id="inventory" role="main">
            <div class="card">
                <h3><span>üì¶</span> Gestione Inventario</h3>
                <div class="quick-actions">
                    <button class="btn btn-success" onclick="addInventoryItem()">
                        <span>üì¶</span> Nuovo Componente
                    </button>
                </div>
                <input type="text" class="search-box" id="inventorySearch" placeholder="üîç Cerca componenti..." aria-label="Cerca componenti">
                <div id="inventoryContainer">
                    <!-- Inventory will be loaded here -->
                </div>
            </div>
        </div>
        
        <!-- Analytics Page -->
        <div class="page" id="analytics" role="main">
            <div class="card">
                <h3><span>üìà</span> Analytics Avanzate</h3>
                <div class="grid grid-2">
                    <div class="card">
                        <h4>üìä Trend Mensili (Ultimi 6 Mesi)</h4>
                        <div id="monthlyTrends" class="chart-container">
                            <!-- Monthly trends chart will be here -->
                        </div>
                    </div>
                    <div class="card">
                        <h4>üèÜ Top Clienti</h4>
                        <div id="topClients">
                            <!-- Top clients will be here -->
                        </div>
                    </div>
                </div>
                
                <div class="grid grid-2">
                    <div class="card">
                        <h4>üìà Performance Mensile</h4>
                        <div id="monthlyPerformance">
                            <!-- Monthly performance metrics -->
                        </div>
                    </div>
                    <div class="card">
                        <h4>üéØ KPI Dashboard</h4>
                        <div id="kpiDashboard">
                            <!-- Key performance indicators -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Main Modal -->
    <div class="modal" id="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
        <div class="modal-content">
            <button class="close" onclick="closeModal()" aria-label="Chiudi finestra">&times;</button>
            <div id="modalContent"></div>
        </div>
    </div>

    <!-- Confirmation Dialog -->
    <div class="confirm-dialog" id="confirmDialog">
        <div class="confirm-content">
            <div class="confirm-icon">‚ö†Ô∏è</div>
            <h3 class="confirm-title" id="confirmTitle">Conferma Eliminazione</h3>
            <p class="confirm-message" id="confirmMessage">Sei sicuro di voler procedere?</p>
            <div class="confirm-actions">
                <button class="btn btn-error" id="confirmYes">
                    <span>üóëÔ∏è</span> Elimina
                </button>
                <button class="btn btn-secondary" id="confirmNo">
                    <span>‚ùå</span> Annulla
                </button>
            </div>
        </div>
    </div>
    
    <script>
        // ===== SUPABASE CONFIGURATION =====
        const supabaseUrl = 'https://lzcphhnakmmimoglknon.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx6Y3BoaG5ha21taW1vZ2xrbm9uIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc2MDQxMTgsImV4cCI6MjA3MzE4MDExOH0.2hACcRIDxd9GbSq4_eq2_Stpn8yWyLf7YYY1xSzPTMU';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
        
        // ===== GLOBAL STATE =====
        let appData = {
            orders: [],
            transactions: [],
            clients: [],
            inventory: [],
            editingId: null,
            currentPage: 'dashboard',
            version: '4.0',
            calendarDate: new Date(),
            connected: false
        };
        
        // ===== UTILITY FUNCTIONS =====
        function formatCurrency(amount) {
            return new Intl.NumberFormat('it-IT', {
                style: 'currency',
                currency: 'EUR'
            }).format(parseFloat(amount || 0));
        }
        
        function generateId() {
            return 'id_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }
        
        function formatDate(date = new Date()) {
            if (date instanceof Date) {
                return date.toISOString().split('T')[0];
            }
            return date;
        }
        
        function formatDateTime(date = new Date()) {
            if (typeof date === 'string') {
                date = new Date(date);
            }
            return date.toISOString();
        }
        
        function showMessage(message, type = 'success') {
            const box = document.getElementById(type === 'error' ? 'errorBox' : 'successBox');
            if (!box) return;
            
            box.textContent = message;
            box.classList.add('show');
            
            setTimeout(() => {
                box.classList.remove('show');
            }, type === 'error' ? 6000 : 4000);
        }

        // ===== CONNECTION STATUS =====
        function updateConnectionStatus(connected) {
            appData.connected = connected;
            const statusEl = document.getElementById('connectionStatus');
            const indicatorEl = document.getElementById('statusIndicator');
            const textEl = document.getElementById('statusText');
            
            if (connected) {
                statusEl.className = 'connection-status connected';
                indicatorEl.className = 'status-indicator connected';
                textEl.textContent = 'Connesso';
            } else {
                statusEl.className = 'connection-status disconnected';
                indicatorEl.className = 'status-indicator disconnected';
                textEl.textContent = 'Offline';
            }
        }

        // ===== IMPROVED SUPABASE FUNCTIONS =====
        async function initializeSupabase() {
            try {
                updateConnectionStatus(false);
                console.log('üîå Tentativo connessione Supabase...');
                
                // Test connection with simple query
                const { data, error } = await supabase
                    .from('orders')
                    .select('count', { count: 'exact', head: true });
                
                if (error) {
                    console.log('üìã Tabelle potrebbero non esistere, verifichiamo...');
                    
                    // Try to create tables if they don't exist
                    await ensureTablesExist();
                    
                    // Test again after table creation
                    const { data: retestData, error: retestError } = await supabase
                        .from('orders')
                        .select('count', { count: 'exact', head: true });
                    
                    if (retestError) {
                        throw retestError;
                    }
                }
                
                updateConnectionStatus(true);
                console.log('‚úÖ Supabase connesso con successo');
                return true;
            } catch (error) {
                console.error('‚ùå Errore connessione Supabase:', error);
                updateConnectionStatus(false);
                showMessage('Modalit√† offline - Dati salvati localmente', 'error');
                return false;
            }
        }

        async function ensureTablesExist() {
            try {
                // Note: In a real production environment, tables should be created
                // through Supabase dashboard or migrations. This is a simplified approach.
                console.log('üõ†Ô∏è Verifica esistenza tabelle...');
                
                // Try to insert a test record to each table to trigger creation
                const testOperations = [
                    // Test orders table
                    supabase.from('orders').select('id').limit(1),
                    // Test transactions table  
                    supabase.from('transactions').select('id').limit(1),
                    // Test clients table
                    supabase.from('clients').select('id').limit(1),
                    // Test inventory table
                    supabase.from('inventory').select('id').limit(1)
                ];
                
                // Execute all tests
                await Promise.allSettled(testOperations);
                
                console.log('‚úÖ Verifiche tabelle completate');
            } catch (error) {
                console.warn('‚ö†Ô∏è Problema verifica tabelle:', error);
                // Continue anyway - will handle errors individually
            }
        }

        async function saveToSupabase(table, data) {
            try {
                if (!appData.connected) {
                    throw new Error('Nessuna connessione Supabase');
                }

                // Clean data to match expected schema
                const cleanData = cleanDataForSupabase(table, data);
                
                console.log(`üíæ Salvando in ${table}:`, cleanData);

                const { data: result, error } = await supabase
                    .from(table)
                    .upsert(cleanData, { 
                        onConflict: 'id',
                        ignoreDuplicates: false 
                    })
                    .select();

                if (error) {
                    console.error(`‚ùå Errore Supabase per ${table}:`, error);
                    throw error;
                }
                
                console.log(`‚úÖ Salvato su ${table}:`, result);
                return result;
            } catch (error) {
                console.error(`üí• Errore salvataggio ${table}:`, error);
                // Always save to localStorage as fallback
                saveDataToLocalStorage();
                throw error;
            }
        }

        function cleanDataForSupabase(table, data) {
            // Remove any undefined values and clean data structure
            const cleaned = JSON.parse(JSON.stringify(data, (key, value) => {
                return value === undefined ? null : value;
            }));
            
            // Ensure required fields exist
            if (!cleaned.created_at) {
                cleaned.created_at = new Date().toISOString();
            }
            
            // Table-specific cleaning
            switch(table) {
                case 'transactions':
                    // Ensure amount is a number
                    if (cleaned.amount) {
                        cleaned.amount = parseFloat(cleaned.amount);
                    }
                    // Ensure transaction_date exists
                    if (!cleaned.transaction_date && cleaned.date) {
                        cleaned.transaction_date = cleaned.date;
                    }
                    break;
                    
                case 'clients':
                    // Ensure total_spent is a number
                    if (cleaned.total_spent) {
                        cleaned.total_spent = parseFloat(cleaned.total_spent);
                    }
                    break;
                    
                case 'inventory':
                    // Ensure numeric fields are numbers
                    if (cleaned.quantity) cleaned.quantity = parseInt(cleaned.quantity);
                    if (cleaned.threshold) cleaned.threshold = parseInt(cleaned.threshold);
                    if (cleaned.price) cleaned.price = parseFloat(cleaned.price);
                    break;
                    
                case 'orders':
                    // Ensure dates are properly formatted
                    if (cleaned.due_date && !cleaned.due_date.includes('T')) {
                        cleaned.due_date = cleaned.due_date + 'T00:00:00Z';
                    }
                    break;
            }
            
            return cleaned;
        }

        async function loadFromSupabase(table) {
            try {
                if (!appData.connected) {
                    throw new Error('Nessuna connessione Supabase');
                }

                console.log(`üì• Caricando da ${table}...`);

                const { data, error } = await supabase
                    .from(table)
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) {
                    console.error(`‚ùå Errore caricamento ${table}:`, error);
                    throw error;
                }
                
                console.log(`‚úÖ Caricati ${data?.length || 0} record da ${table}`);
                return data || [];
            } catch (error) {
                console.error(`üí• Errore caricamento ${table}:`, error);
                return [];
            }
        }

        async function deleteFromSupabase(table, id) {
            try {
                if (!appData.connected) {
                    throw new Error('Nessuna connessione Supabase');
                }

                console.log(`üóëÔ∏è Eliminando da ${table} ID:`, id);

                const { error } = await supabase
                    .from(table)
                    .delete()
                    .eq('id', id);

                if (error) {
                    console.error(`‚ùå Errore eliminazione ${table}:`, error);
                    throw error;
                }
                
                console.log(`‚úÖ Eliminato da ${table} ID:`, id);
                return true;
            } catch (error) {
                console.error(`üí• Errore eliminazione ${table}:`, error);
                throw error;
            }
        }

        async function syncData() {
            try {
                if (!appData.connected) {
                    showMessage('Nessuna connessione a Supabase', 'error');
                    return;
                }

                showMessage('üîÑ Sincronizzazione in corso...');

                // Load all data from Supabase with individual error handling
                const results = await Promise.allSettled([
                    loadFromSupabase('orders'),
                    loadFromSupabase('transactions'),
                    loadFromSupabase('clients'),
                    loadFromSupabase('inventory')
                ]);

                // Process results with fallback to empty arrays
                appData.orders = results[0].status === 'fulfilled' ? results[0].value : [];
                appData.transactions = results[1].status === 'fulfilled' ? results[1].value : [];
                appData.clients = results[2].status === 'fulfilled' ? results[2].value : [];
                appData.inventory = results[3].status === 'fulfilled' ? results[3].value : [];

                // Check for any failures
                const failures = results.filter(r => r.status === 'rejected');
                if (failures.length > 0) {
                    console.warn('‚ö†Ô∏è Alcune sincronizzazioni fallite:', failures);
                    showMessage(`Sincronizzazione parziale (${failures.length} errori)`, 'error');
                } else {
                    showMessage('‚úÖ Sincronizzazione completata!');
                }

                // Always save to localStorage as backup
                saveDataToLocalStorage();

                // Refresh current page
                showPage(appData.currentPage);
                updateDashboard();

                console.log('üìä Dati sincronizzati:', {
                    orders: appData.orders.length,
                    transactions: appData.transactions.length,
                    clients: appData.clients.length,
                    inventory: appData.inventory.length
                });

            } catch (error) {
                console.error('üí• Errore sincronizzazione:', error);
                showMessage('Errore nella sincronizzazione', 'error');
            }
        }

        // ===== ENHANCED DEBOUNCE FUNCTION =====
        function debounce(func, wait, immediate) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    timeout = null;
                    if (!immediate) func(...args);
                };
                const callNow = immediate && !timeout;
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
                if (callNow) func(...args);
            };
        }

        // ===== LOADING STATE MANAGEMENT =====
        function showLoading(buttonElement, originalText) {
            if (buttonElement) {
                buttonElement.disabled = true;
                buttonElement.innerHTML = `<span class="loading"></span> Salvando...`;
            }
        }

        function hideLoading(buttonElement, originalText) {
            if (buttonElement) {
                buttonElement.disabled = false;
                buttonElement.innerHTML = originalText;
            }
        }

        // ===== CALENDAR FUNCTIONS =====
        function initializeCalendar() {
            appData.calendarDate = new Date();
            renderCalendar();
        }

        function renderCalendar() {
            const date = appData.calendarDate;
            const year = date.getFullYear();
            const month = date.getMonth();

            // Update month display
            const monthNames = [
                'Gennaio', 'Febbraio', 'Marzo', 'Aprile', 'Maggio', 'Giugno',
                'Luglio', 'Agosto', 'Settembre', 'Ottobre', 'Novembre', 'Dicembre'
            ];
            document.getElementById('calendarMonth').textContent = `${monthNames[month]} ${year}`;

            // Generate calendar grid
            const grid = document.getElementById('calendarGrid');
            grid.innerHTML = '';

            // Day headers
            const dayHeaders = ['Dom', 'Lun', 'Mar', 'Mer', 'Gio', 'Ven', 'Sab'];
            dayHeaders.forEach(day => {
                const header = document.createElement('div');
                header.className = 'calendar-day-header';
                header.textContent = day;
                grid.appendChild(header);
            });

            // Get first day of month and number of days
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startingDayOfWeek = firstDay.getDay();

            // Previous month's trailing days
            const prevMonth = new Date(year, month - 1, 0);
            for (let i = startingDayOfWeek - 1; i >= 0; i--) {
                const day = prevMonth.getDate() - i;
                const dayEl = createCalendarDay(new Date(year, month - 1, day), true);
                grid.appendChild(dayEl);
            }

            // Current month's days
            for (let day = 1; day <= daysInMonth; day++) {
                const dayEl = createCalendarDay(new Date(year, month, day), false);
                grid.appendChild(dayEl);
            }

            // Next month's leading days
            const totalCells = grid.children.length - 7; // Subtract headers
            const remainingCells = 42 - totalCells; // 6 rows * 7 days
            for (let day = 1; day <= remainingCells; day++) {
                const dayEl = createCalendarDay(new Date(year, month + 1, day), true);
                grid.appendChild(dayEl);
            }
        }

        function createCalendarDay(date, otherMonth) {
            const dayEl = document.createElement('div');
            dayEl.className = 'calendar-day';
            if (otherMonth) dayEl.classList.add('other-month');

            const today = new Date();
            if (date.toDateString() === today.toDateString()) {
                dayEl.classList.add('today');
            }

            // Day number
            const dayNumber = document.createElement('div');
            dayNumber.className = 'calendar-day-number';
            dayNumber.textContent = date.getDate();
            dayEl.appendChild(dayNumber);

            // Add events for this day
            const events = getEventsForDate(date);
            events.forEach(event => {
                const eventEl = document.createElement('div');
                eventEl.className = `calendar-event ${event.type}`;
                eventEl.textContent = event.title;
                eventEl.title = event.description;
                dayEl.appendChild(eventEl);
            });

            // Click handler
            dayEl.addEventListener('click', () => openCalendarDay(date));

            return dayEl;
        }

        function getEventsForDate(date) {
            const events = [];
            const dateStr = formatDate(date);

            // Add orders due on this date
            appData.orders.forEach(order => {
                if (order.dueDate === dateStr || order.due_date === dateStr) {
                    events.push({
                        type: 'order',
                        title: `üìã ${order.clientName || order.client_name}`,
                        description: `Ordine in scadenza: ${order.specs?.modello || 'Game Boy'}`
                    });
                }
                if (order.createdDate === dateStr || order.created_at?.split('T')[0] === dateStr) {
                    events.push({
                        type: 'order',
                        title: `üìã+ ${order.clientName || order.client_name}`,
                        description: `Nuovo ordine: ${order.specs?.modello || 'Game Boy'}`
                    });
                }
            });

            // Add transactions on this date
            appData.transactions.forEach(transaction => {
                if (transaction.date === dateStr || transaction.transaction_date === dateStr) {
                    const isRevenue = transaction.type === 'revenue';
                    events.push({
                        type: `transaction-${transaction.type}`,
                        title: `${isRevenue ? 'üí∞' : 'üí∏'} ${formatCurrency(transaction.amount)}`,
                        description: transaction.description
                    });
                }
            });

            return events.slice(0, 3); // Limit to 3 events per day for display
        }

        function openCalendarDay(date) {
            const events = getEventsForDate(date);
            const allEventsForDate = getAllEventsForDate(date); // Get all events, not limited

            const content = `
                <h3 style="color: var(--accent); margin-bottom: var(--space-6);">
                    üìÖ ${date.toLocaleDateString('it-IT', { 
                        weekday: 'long', 
                        year: 'numeric', 
                        month: 'long', 
                        day: 'numeric' 
                    })}
                </h3>
                
                ${allEventsForDate.length === 0 ? `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìÖ</div>
                        <p>Nessun evento per questa data</p>
                    </div>
                ` : `
                    <div style="display: flex; flex-direction: column; gap: var(--space-4);">
                        ${allEventsForDate.map(event => `
                            <div style="
                                padding: var(--space-4);
                                background: var(--surface);
                                border-radius: var(--radius-lg);
                                border-left: 4px solid ${getEventColor(event.type)};
                            ">
                                <div style="font-weight: 600; margin-bottom: var(--space-2);">
                                    ${event.title}
                                </div>
                                <div style="color: var(--text-muted); font-size: 0.875rem;">
                                    ${event.description}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `}
                
                <div class="quick-actions" style="margin-top: var(--space-6);">
                    <button class="btn btn-success" onclick="addTransactionForDate('${formatDate(date)}', 'revenue')">
                        <span>üí∞</span> Nuova Entrata
                    </button>
                    <button class="btn btn-error" onclick="addTransactionForDate('${formatDate(date)}', 'expense')">
                        <span>üí∏</span> Nuova Spesa
                    </button>
                    <button class="btn btn-secondary" onclick="closeCalendarDayView()">
                        <span>‚úÖ</span> Chiudi
                    </button>
                </div>
            `;

            document.getElementById('calendarDayContent').innerHTML = content;
            document.getElementById('calendarDayView').classList.add('active');
        }

        function getAllEventsForDate(date) {
            const events = [];
            const dateStr = formatDate(date);

            // Add all orders for this date
            appData.orders.forEach(order => {
                if (order.dueDate === dateStr || order.due_date === dateStr) {
                    events.push({
                        type: 'order',
                        title: `üìã Scadenza Ordine - ${order.clientName || order.client_name}`,
                        description: `${order.specs?.modello || 'Game Boy'} - Stato: ${getStatusText(order.status)}`
                    });
                }
                if (order.createdDate === dateStr || order.created_at?.split('T')[0] === dateStr) {
                    events.push({
                        type: 'order',
                        title: `üìã Nuovo Ordine - ${order.clientName || order.client_name}`,
                        description: `${order.specs?.modello || 'Game Boy'} - Creato oggi`
                    });
                }
            });

            // Add all transactions for this date
            appData.transactions.forEach(transaction => {
                if (transaction.date === dateStr || transaction.transaction_date === dateStr) {
                    const isRevenue = transaction.type === 'revenue';
                    events.push({
                        type: `transaction-${transaction.type}`,
                        title: `${isRevenue ? 'üí∞ Entrata' : 'üí∏ Spesa'} - ${formatCurrency(transaction.amount)}`,
                        description: `${transaction.description}${transaction.client ? ` - Cliente: ${transaction.client}` : ''}`
                    });
                }
            });

            return events;
        }

        function getEventColor(type) {
            switch (type) {
                case 'order': return 'var(--warning)';
                case 'transaction-revenue': return 'var(--success)';
                case 'transaction-expense': return 'var(--error)';
                default: return 'var(--primary)';
            }
        }

        function getStatusText(status) {
            const statusText = {
                'pending': 'In Attesa',
                'in-progress': 'In Lavorazione', 
                'completed': 'Completato',
                'cancelled': 'Annullato'
            };
            return statusText[status] || status;
        }

        function closeCalendarDayView() {
            document.getElementById('calendarDayView').classList.remove('active');
        }

        function changeMonth(delta) {
            appData.calendarDate.setMonth(appData.calendarDate.getMonth() + delta);
            renderCalendar();
        }

        function goToToday() {
            appData.calendarDate = new Date();
            renderCalendar();
        }

        function addTransactionForDate(date, type) {
            closeCalendarDayView();
            addTransaction(type, date);
        }

        // ===== NAVIGATION =====
        function showPage(pageId) {
            try {
                // Remove active class from all pages and buttons
                document.querySelectorAll('.page').forEach(page => {
                    page.classList.remove('active');
                });
                document.querySelectorAll('.nav-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                // Add active class to target page and button
                const targetPage = document.getElementById(pageId);
                const targetButton = document.querySelector(`[onclick="showPage('${pageId}')"]`);
                
                if (targetPage) {
                    targetPage.classList.add('active');
                }
                if (targetButton) {
                    targetButton.classList.add('active');
                }
                
                appData.currentPage = pageId;
                
                // Load page data
                switch(pageId) {
                    case 'dashboard':
                        updateDashboard();
                        break;
                    case 'orders':
                        loadOrders();
                        setTimeout(setupSearchListeners, 100);
                        break;
                    case 'transactions':
                        loadTransactions();
                        setTimeout(setupSearchListeners, 100);
                        break;
                    case 'clients':
                        loadClients();
                        setTimeout(setupSearchListeners, 100);
                        break;
                    case 'inventory':
                        loadInventory();
                        setTimeout(setupSearchListeners, 100);
                        break;
                    case 'calendar':
                        renderCalendar();
                        break;
                    case 'analytics':
                        loadAnalytics();
                        break;
                }
                
                console.log(`Navigated to ${pageId}`);
                
            } catch (error) {
                console.error('Navigation error:', error);
                showMessage('Errore nella navigazione', 'error');
            }
        }
        
        // ===== DASHBOARD FUNCTIONS =====
        function updateDashboard() {
            try {
                const revenues = appData.transactions.filter(t => t.type === 'revenue');
                const expenses = appData.transactions.filter(t => t.type === 'expense');
                
                const totalRevenue = revenues.reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);
                const totalExpenses = expenses.reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);
                const netProfit = totalRevenue - totalExpenses;
                const totalOrders = appData.orders.length;
                
                // Update stat boxes with animation
                const elements = {
                    totalRevenue: formatCurrency(totalRevenue),
                    totalExpenses: formatCurrency(totalExpenses),
                    netProfit: formatCurrency(netProfit),
                    totalOrders: totalOrders
                };
                
                Object.entries(elements).forEach(([id, value]) => {
                    const element = document.getElementById(id);
                    if (element) {
                        // Add subtle animation
                        element.style.transform = 'scale(1.05)';
                        setTimeout(() => {
                            element.textContent = value;
                            element.style.transform = 'scale(1)';
                        }, 150);
                    }
                });
                
                // Update profit color
                const profitElement = document.getElementById('netProfit');
                if (profitElement && profitElement.parentElement) {
                    const profitBox = profitElement.parentElement;
                    if (netProfit >= 0) {
                        profitBox.style.background = 'linear-gradient(135deg, var(--success), #059669)';
                    } else {
                        profitBox.style.background = 'linear-gradient(135deg, var(--error), #dc2626)';
                    }
                }
                
                // Update AI suggestions
                runAIAnalysis();
                
                console.log('Dashboard updated successfully');
                
            } catch (error) {
                console.error('Dashboard update error:', error);
                showMessage('Errore aggiornamento dashboard', 'error');
            }
        }

        // ===== ORDERS FUNCTIONS =====
        function loadOrders() {
            const container = document.getElementById('ordersContainer');
            if (!container) return;
            
            if (appData.orders.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìã</div>
                        <h3>Nessun ordine</h3>
                        <p>Inizia aggiungendo il tuo primo ordine personalizzato!</p>
                    </div>
                `;
                return;
            }
            
            // Sort orders by date (newest first)
            const sortedOrders = [...appData.orders].sort((a, b) => 
                new Date(b.created_at || b.createdDate) - new Date(a.created_at || a.createdDate)
            );
            
            const tableHTML = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Cliente</th>
                            <th>Modello</th>
                            <th>Stato</th>
                            <th>Data Creazione</th>
                            <th>Scadenza</th>
                            <th>Azioni</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${sortedOrders.map(order => {
                            const statusClass = `status-${order.status}`;
                            const statusText = {
                                'pending': '‚è≥ In Attesa',
                                'in-progress': 'üîß In Lavorazione', 
                                'completed': '‚úÖ Completato',
                                'cancelled': '‚ùå Annullato'
                            };
                            
                            return `
                                <tr data-id="${order.id}">
                                    <td><strong>${order.client_name || order.clientName}</strong></td>
                                    <td>${order.specs?.modello || order.modello || '-'}</td>
                                    <td>
                                        <span class="status-badge ${statusClass}">
                                            ${statusText[order.status] || order.status}
                                        </span>
                                    </td>
                                    <td>${new Date(order.created_at || order.createdDate).toLocaleDateString('it-IT')}</td>
                                    <td>${new Date(order.due_date || order.dueDate).toLocaleDateString('it-IT')}</td>
                                    <td>
                                        <button class="btn btn-secondary" onclick="viewOrder('${order.id}')" style="padding: 0.25rem 0.5rem; font-size: 0.75rem; margin: 0.125rem;">
                                            üëÅÔ∏è Vedi
                                        </button>
                                        <button class="btn btn-secondary" onclick="editOrder('${order.id}')" style="padding: 0.25rem 0.5rem; font-size: 0.75rem; margin: 0.125rem;">
                                            ‚úèÔ∏è Modifica
                                        </button>
                                        <button class="btn btn-error" onclick="confirmDeleteOrder('${order.id}')" style="padding: 0.25rem 0.5rem; font-size: 0.75rem; margin: 0.125rem;">
                                            üóëÔ∏è Elimina
                                        </button>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
            
            container.innerHTML = tableHTML;
            console.log('Orders loaded:', appData.orders.length);
        }

        function addOrder() {
            const content = `
                <h3 id="modalTitle" style="color: var(--accent); margin-bottom: var(--space-6);">üìã Nuovo Ordine</h3>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label for="orderClientName">Nome Cliente</label>
                        <input type="text" id="orderClientName" required>
                    </div>
                    <div class="form-group">
                        <label for="orderClientEmail">Email Cliente</label>
                        <input type="email" id="orderClientEmail" required>
                    </div>
                    <div class="form-group">
                        <label for="orderStatus">Stato</label>
                        <select id="orderStatus" required>
                            <option value="pending">‚è≥ In Attesa</option>
                            <option value="in-progress">üîß In Lavorazione</option>
                            <option value="completed">‚úÖ Completato</option>
                            <option value="cancelled">‚ùå Annullato</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="orderDueDate">Data Scadenza</label>
                        <input type="date" id="orderDueDate" required>
                    </div>
                </div>

                <h4 style="color: var(--primary); margin: var(--space-6) 0 var(--space-4); display: flex; align-items: center; gap: var(--space-2);">
                    üéÆ Specifiche Game Boy
                </h4>

                <div class="form-grid">
                    <div class="form-group">
                        <label for="specModello">Modello Game Boy</label>
                        <input type="text" id="specModello" placeholder="es. Game Boy Classic, Color, Advance...">
                    </div>
                    <div class="form-group">
                        <label for="specScocca">Scocca</label>
                        <input type="text" id="specScocca" placeholder="es. Trasparente, Colorata, Custom...">
                    </div>
                    <div class="form-group">
                        <label for="specPulsanti">Pulsanti</label>
                        <input type="text" id="specPulsanti" placeholder="es. Originali, Custom, Colorati...">
                    </div>
                    <div class="form-group">
                        <label for="specEtichetta">Etichetta</label>
                        <input type="text" id="specEtichetta" placeholder="es. Originale, Custom, Restaurata...">
                    </div>
                    <div class="form-group">
                        <label for="specBatteria">Batteria</label>
                        <input type="text" id="specBatteria" placeholder="es. Standard AA, Ricaricabile USB-C...">
                    </div>
                    <div class="form-group">
                        <label for="specAudio">Audio</label>
                        <input type="text" id="specAudio" placeholder="es. Standard, Amplificato, Pro Sound...">
                    </div>
                    <div class="form-group">
                        <label for="specDisplay">Display</label>
                        <input type="text" id="specDisplay" placeholder="es. Originale, IPS, Backlight mod...">
                    </div>
                    <div class="form-group">
                        <label for="specKitLed">Kit LED</label>
                        <input type="text" id="specKitLed" placeholder="es. Nessuno, LED bianchi, RGB...">
                    </div>
                    <div class="form-group">
                        <label for="specBox">Box</label>
                        <input type="text" id="specBox" placeholder="es. Originale, Riproduzione, Custom...">
                    </div>
                    <div class="form-group">
                        <label for="specCover">Cover</label>
                        <input type="text" id="specCover" placeholder="es. Silicone, Rigida, Personalizzata...">
                    </div>
                    <div class="form-group">
                        <label for="specGameBoyCliente">Game Boy Cliente</label>
                        <input type="text" id="specGameBoyCliente" placeholder="es. Fornito dal cliente, Da acquistare...">
                    </div>
                    <div class="form-group">
                        <label for="specAltro">Altro</label>
                        <input type="text" id="specAltro" placeholder="es. Accessori extra, Modifiche speciali...">
                    </div>
                    <div class="form-group form-grid-full">
                        <label for="specNote">Note</label>
                        <textarea id="specNote" placeholder="Note aggiuntive, richieste speciali, dettagli importanti..."></textarea>
                    </div>
                </div>

                <div class="quick-actions">
                    <button type="button" class="btn btn-success" onclick="saveOrderFromForm()" id="saveOrderBtn">
                        <span>üíæ</span> Salva Ordine
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">
                        <span>‚ùå</span> Annulla
                    </button>
                </div>
            `;
            openModal(content);

            // Set default due date (2 weeks from now)
            setTimeout(() => {
                const dueDateField = document.getElementById('orderDueDate');
                if (dueDateField) {
                    const defaultDate = new Date();
                    defaultDate.setDate(defaultDate.getDate() + 14);
                    dueDateField.value = formatDate(defaultDate);
                }
            }, 100);
        }

        async function saveOrderFromForm() {
            try {
                const saveBtn = document.getElementById('saveOrderBtn');
                const originalText = '<span>üíæ</span> Salva Ordine';
                
                showLoading(saveBtn, 'Salvando...');
                
                const clientName = document.getElementById('orderClientName')?.value;
                const clientEmail = document.getElementById('orderClientEmail')?.value;
                const status = document.getElementById('orderStatus')?.value;
                const dueDate = document.getElementById('orderDueDate')?.value;
                
                if (!clientName || !clientEmail || !status || !dueDate) {
                    hideLoading(saveBtn, originalText);
                    showMessage('Compila tutti i campi obbligatori', 'error');
                    return;
                }
                
                // Validate email format
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(clientEmail)) {
                    hideLoading(saveBtn, originalText);
                    showMessage('Formato email non valido', 'error');
                    return;
                }
                
                // Validate due date
                const selectedDate = new Date(dueDate);
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                selectedDate.setHours(0, 0, 0, 0);
                
                if (selectedDate <= today) {
                    hideLoading(saveBtn, originalText);
                    showMessage('La data di scadenza deve essere nel futuro', 'error');
                    return;
                }
                
                const specs = {
                    modello: document.getElementById('specModello')?.value || '',
                    scocca: document.getElementById('specScocca')?.value || '',
                    pulsanti: document.getElementById('specPulsanti')?.value || '',
                    etichetta: document.getElementById('specEtichetta')?.value || '',
                    batteria: document.getElementById('specBatteria')?.value || '',
                    audio: document.getElementById('specAudio')?.value || '',
                    display: document.getElementById('specDisplay')?.value || '',
                    kitLed: document.getElementById('specKitLed')?.value || '',
                    box: document.getElementById('specBox')?.value || '',
                    cover: document.getElementById('specCover')?.value || '',
                    gameBoyCliente: document.getElementById('specGameBoyCliente')?.value || '',
                    altro: document.getElementById('specAltro')?.value || '',
                    note: document.getElementById('specNote')?.value || ''
                };

                const formData = {
                    id: appData.editingId || generateId(),
                    client_name: clientName,
                    client_email: clientEmail,
                    status: status,
                    created_at: appData.editingId ? 
                        appData.orders.find(o => o.id === appData.editingId)?.created_at || formatDateTime() : 
                        formatDateTime(),
                    due_date: dueDate,
                    specs: specs,
                    // Legacy compatibility
                    clientName: clientName,
                    clientEmail: clientEmail,
                    createdDate: appData.editingId ? 
                        appData.orders.find(o => o.id === appData.editingId)?.createdDate || formatDate() : 
                        formatDate(),
                    dueDate: dueDate
                };
                
                if (appData.editingId) {
                    const index = appData.orders.findIndex(o => o.id === appData.editingId);
                    if (index !== -1) {
                        appData.orders[index] = formData;
                        
                        // Try to save to Supabase, but continue if it fails
                        if (appData.connected) {
                            try {
                                await saveToSupabase('orders', formData);
                                showMessage('Ordine aggiornato e sincronizzato!');
                            } catch (error) {
                                console.warn('Supabase save failed:', error);
                                showMessage('Ordine aggiornato localmente (sync fallito)', 'error');
                            }
                        } else {
                            showMessage('Ordine aggiornato (modalit√† offline)');
                        }
                        
                        console.log('Order updated:', formData);
                    }
                    appData.editingId = null;
                } else {
                    appData.orders.push(formData);
                    
                    // Try to save to Supabase, but continue if it fails
                    if (appData.connected) {
                        try {
                            await saveToSupabase('orders', formData);
                            showMessage('Ordine aggiunto e sincronizzato!');
                        } catch (error) {
                            console.warn('Supabase save failed:', error);
                            showMessage('Ordine aggiunto localmente (sync fallito)', 'error');
                        }
                    } else {
                        showMessage('Ordine aggiunto (modalit√† offline)');
                    }
                    
                    console.log('Order added:', formData);
                }
                
                // Always save to localStorage as backup
                saveDataToLocalStorage();
                
                hideLoading(saveBtn, originalText);
                closeModal();
                loadOrders();
                updateDashboard();
                
                // Refresh calendar if we're on that page
                if (appData.currentPage === 'calendar') {
                    renderCalendar();
                }
                
            } catch (error) {
                console.error('Save order error:', error);
                showMessage('Errore nel salvataggio ordine', 'error');
                hideLoading(document.getElementById('saveOrderBtn'), '<span>üíæ</span> Salva Ordine');
            }
        }

        function viewOrder(id) {
            const order = appData.orders.find(o => o.id === id);
            if (!order) {
                showMessage('Ordine non trovato', 'error');
                return;
            }

            const statusText = {
                'pending': '‚è≥ In Attesa',
                'in-progress': 'üîß In Lavorazione', 
                'completed': '‚úÖ Completato',
                'cancelled': '‚ùå Annullato'
            };

            const statusClass = `status-${order.status}`;

            const content = `
                <h3 id="modalTitle" style="color: var(--accent); margin-bottom: var(--space-6);">
                    üëÅÔ∏è Dettagli Ordine - ${order.client_name || order.clientName}
                </h3>
                
                <div class="order-details">
                    <h4>üìã Informazioni Generali</h4>
                    <div class="order-spec">
                        <span class="spec-label">Cliente:</span>
                        <span class="spec-value"><strong>${order.client_name || order.clientName}</strong></span>
                    </div>
                    <div class="order-spec">
                        <span class="spec-label">Email:</span>
                        <span class="spec-value">${order.client_email || order.clientEmail}</span>
                    </div>
                    <div class="order-spec">
                        <span class="spec-label">Stato:</span>
                        <span class="spec-value">
                            <span class="status-badge ${statusClass}">
                                ${statusText[order.status] || order.status}
                            </span>
                        </span>
                    </div>
                    <div class="order-spec">
                        <span class="spec-label">Data Creazione:</span>
                        <span class="spec-value">${new Date(order.created_at || order.createdDate).toLocaleDateString('it-IT')}</span>
                    </div>
                    <div class="order-spec">
                        <span class="spec-label">Scadenza:</span>
                        <span class="spec-value">${new Date(order.due_date || order.dueDate).toLocaleDateString('it-IT')}</span>
                    </div>
                </div>

                <div class="order-details">
                    <h4>üéÆ Specifiche Game Boy</h4>
                    ${Object.entries(order.specs || {}).map(([key, value]) => {
                        if (!value) return '';
                        
                        const labels = {
                            modello: 'Modello Game Boy',
                            scocca: 'Scocca',
                            pulsanti: 'Pulsanti',
                            etichetta: 'Etichetta',
                            batteria: 'Batteria',
                            audio: 'Audio',
                            display: 'Display',
                            kitLed: 'Kit LED',
                            box: 'Box',
                            cover: 'Cover',
                            gameBoyCliente: 'Game Boy Cliente',
                            altro: 'Altro',
                            note: 'Note'
                        };
                        
                        return `
                            <div class="order-spec">
                                <span class="spec-label">${labels[key] || key}:</span>
                                <span class="spec-value">${value}</span>
                            </div>
                        `;
                    }).join('')}
                </div>

                <div class="quick-actions">
                    <button type="button" class="btn btn-warning" onclick="editOrder('${order.id}'); closeModal();">
                        <span>‚úèÔ∏è</span> Modifica
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">
                        <span>‚úÖ</span> Chiudi
                    </button>
                </div>
            `;
            
            openModal(content);
        }

        function editOrder(id) {
            console.log('Editing order with ID:', id);
            const order = appData.orders.find(o => o.id === id);
            if (!order) {
                showMessage('Ordine non trovato', 'error');
                console.error('Order not found:', id);
                return;
            }
            
            appData.editingId = id;
            addOrder();
            
            // Populate form with existing data
            setTimeout(() => {
                const fields = {
                    orderClientName: order.client_name || order.clientName,
                    orderClientEmail: order.client_email || order.clientEmail,
                    orderStatus: order.status,
                    orderDueDate: order.due_date || order.dueDate,
                    specModello: order.specs?.modello || '',
                    specScocca: order.specs?.scocca || '',
                    specPulsanti: order.specs?.pulsanti || '',
                    specEtichetta: order.specs?.etichetta || '',
                    specBatteria: order.specs?.batteria || '',
                    specAudio: order.specs?.audio || '',
                    specDisplay: order.specs?.display || '',
                    specKitLed: order.specs?.kitLed || '',
                    specBox: order.specs?.box || '',
                    specCover: order.specs?.cover || '',
                    specGameBoyCliente: order.specs?.gameBoyCliente || '',
                    specAltro: order.specs?.altro || '',
                    specNote: order.specs?.note || ''
                };

                Object.entries(fields).forEach(([fieldId, value]) => {
                    const element = document.getElementById(fieldId);
                    if (element && value) {
                        element.value = value;
                    }
                });
            }, 100);
        }

        function confirmDeleteOrder(id) {
            console.log('Confirming delete for order:', id);
            const order = appData.orders.find(o => o.id === id);
            if (!order) {
                showMessage('Ordine non trovato', 'error');
                return;
            }
            
            showConfirmDialog(
                'Elimina Ordine',
                `Sei sicuro di voler eliminare l'ordine per "${order.client_name || order.clientName}"? Questa azione non pu√≤ essere annullata.`,
                () => deleteOrder(id)
            );
        }

        async function deleteOrder(id) {
            console.log('Deleting order with ID:', id);
            console.log('Orders before delete:', appData.orders.length);
            
            try {
                const initialLength = appData.orders.length;
                appData.orders = appData.orders.filter(o => o.id !== id);
                
                // Try to delete from Supabase, but continue if it fails
                if (appData.connected) {
                    try {
                        await deleteFromSupabase('orders', id);
                    } catch (error) {
                        console.warn('Supabase delete failed:', error);
                    }
                }
                
                // Always save to localStorage
                saveDataToLocalStorage();
                
                if (appData.orders.length < initialLength) {
                    console.log('Order deleted successfully. New count:', appData.orders.length);
                    showMessage('Ordine eliminato con successo!');
                    loadOrders();
                    updateDashboard();
                    
                    // Refresh calendar if we're on that page
                    if (appData.currentPage === 'calendar') {
                        renderCalendar();
                    }
                } else {
                    console.error('Failed to delete order');
                    showMessage('Errore nell\'eliminazione dell\'ordine', 'error');
                }
            } catch (error) {
                console.error('Delete order error:', error);
                showMessage('Errore nell\'eliminazione dell\'ordine', 'error');
            }
        }

        const debouncedFilterOrders = debounce(() => {
            const searchTerm = document.getElementById('orderSearch')?.value.toLowerCase() || '';
            const rows = document.querySelectorAll('#ordersContainer tbody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }, 300);
        
        // ===== TRANSACTIONS FUNCTIONS =====
        function loadTransactions() {
            const container = document.getElementById('transactionsContainer');
            if (!container) return;
            
            if (appData.transactions.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üí∞</div>
                        <h3>Nessuna transazione</h3>
                        <p>Inizia aggiungendo la tua prima transazione!</p>
                    </div>
                `;
                return;
            }
            
            // Sort transactions by date (newest first)
            const sortedTransactions = [...appData.transactions].sort((a, b) => 
                new Date(b.created_at || b.transaction_date || b.date) - new Date(a.created_at || a.transaction_date || a.date)
            );
            
            const tableHTML = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>Tipo</th>
                            <th>Importo</th>
                            <th>Descrizione</th>
                            <th>Cliente</th>
                            <th>Azioni</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${sortedTransactions.map(transaction => `
                            <tr data-id="${transaction.id}">
                                <td>${new Date(transaction.transaction_date || transaction.date).toLocaleDateString('it-IT')}</td>
                                <td>
                                    <span style="color: ${transaction.type === 'revenue' ? 'var(--success)' : 'var(--error)'}">
                                        ${transaction.type === 'revenue' ? 'üí∞ Entrata' : 'üí∏ Spesa'}
                                    </span>
                                </td>
                                <td style="color: ${transaction.type === 'revenue' ? 'var(--success)' : 'var(--error)'}">
                                    ${formatCurrency(transaction.amount)}
                                </td>
                                <td>${transaction.description}</td>
                                <td>${transaction.client || '-'}</td>
                                <td>
                                    <button class="btn btn-secondary" onclick="editTransaction('${transaction.id}')" style="padding: 0.25rem 0.5rem; font-size: 0.75rem; margin: 0.125rem;">
                                        ‚úèÔ∏è Modifica
                                    </button>
                                    <button class="btn btn-error" onclick="confirmDeleteTransaction('${transaction.id}')" style="padding: 0.25rem 0.5rem; font-size: 0.75rem; margin: 0.125rem;">
                                        üóëÔ∏è Elimina
                                    </button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            container.innerHTML = tableHTML;
            console.log('Transactions loaded:', appData.transactions.length);
        }
        
        function addTransaction(type, presetDate = null) {
            const content = `
                <h3 id="modalTitle" style="color: var(--accent); margin-bottom: var(--space-6);">
                    ${type === 'revenue' ? 'üí∞ Nuova Entrata' : 'üí∏ Nuova Spesa'}
                </h3>
                <div class="form-group">
                    <label for="amount">Importo (‚Ç¨)</label>
                    <input type="number" id="amount" step="0.01" min="0" required>
                </div>
                <div class="form-group">
                    <label for="description">Descrizione</label>
                    <input type="text" id="description" required>
                </div>
                <div class="form-group">
                    <label for="date">Data</label>
                    <input type="date" id="date" value="${presetDate || formatDate()}" required>
                </div>
                <div class="form-group">
                    <label for="client">Cliente (opzionale)</label>
                    <select id="client">
                        <option value="">Seleziona cliente...</option>
                        ${appData.clients.map(client => `
                            <option value="${client.name || client.client_name}">${client.name || client.client_name}</option>
                        `).join('')}
                    </select>
                </div>
                <div class="quick-actions">
                    <button type="button" class="btn btn-success" onclick="saveTransactionFromForm('${type}')" id="saveTransactionBtn">
                        <span>üíæ</span> Salva
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">
                        <span>‚ùå</span> Annulla
                    </button>
                </div>
            `;
            openModal(content);
        }
        
        async function saveTransactionFromForm(type) {
            try {
                const saveBtn = document.getElementById('saveTransactionBtn');
                const originalText = '<span>üíæ</span> Salva';
                
                showLoading(saveBtn, 'Salvando...');
                
                const amount = document.getElementById('amount')?.value;
                const description = document.getElementById('description')?.value;
                const date = document.getElementById('date')?.value;
                const client = document.getElementById('client')?.value;
                
                if (!amount || !description || !date) {
                    hideLoading(saveBtn, originalText);
                    showMessage('Compila tutti i campi obbligatori', 'error');
                    return;
                }
                
                // Validate amount
                const parsedAmount = parseFloat(amount);
                if (parsedAmount <= 0) {
                    hideLoading(saveBtn, originalText);
                    showMessage('L\'importo deve essere maggiore di zero', 'error');
                    return;
                }
                
                // Validate date (don't allow future dates for transactions)
                const selectedDate = new Date(date);
                const today = new Date();
                today.setHours(23, 59, 59, 999); // End of today
                
                if (selectedDate > today) {
                    hideLoading(saveBtn, originalText);
                    showMessage('La data non pu√≤ essere nel futuro', 'error');
                    return;
                }
                
                const formData = {
                    id: appData.editingId || generateId(),
                    type: type,
                    amount: parsedAmount,
                    description: description,
                    transaction_date: date,
                    client: client,
                    created_at: formatDateTime(),
                    // Legacy compatibility
                    date: date
                };
                
                if (appData.editingId) {
                    const index = appData.transactions.findIndex(t => t.id === appData.editingId);
                    if (index !== -1) {
                        appData.transactions[index] = formData;
                        
                        // Try to save to Supabase, but continue if it fails
                        if (appData.connected) {
                            try {
                                await saveToSupabase('transactions', formData);
                                showMessage('Transazione aggiornata e sincronizzata!');
                            } catch (error) {
                                console.warn('Supabase save failed:', error);
                                showMessage('Transazione aggiornata localmente (sync fallito)', 'error');
                            }
                        } else {
                            showMessage('Transazione aggiornata (modalit√† offline)');
                        }
                        
                        console.log('Transaction updated:', formData);
                    }
                    appData.editingId = null;
                } else {
                    appData.transactions.push(formData);
                    
                    // Try to save to Supabase, but continue if it fails
                    if (appData.connected) {
                        try {
                            await saveToSupabase('transactions', formData);
                            showMessage('Transazione aggiunta e sincronizzata!');
                        } catch (error) {
                            console.warn('Supabase save failed:', error);
                            showMessage('Transazione aggiunta localmente (sync fallito)', 'error');
                        }
                    } else {
                        showMessage('Transazione aggiunta (modalit√† offline)');
                    }
                    
                    console.log('Transaction added:', formData);
                }
                
                // Always save to localStorage as backup
                saveDataToLocalStorage();
                
                hideLoading(saveBtn, originalText);
                closeModal();
                loadTransactions();
                updateDashboard();
                updateClientTotalSpent();
                
                // Refresh calendar if we're on that page
                if (appData.currentPage === 'calendar') {
                    renderCalendar();
                }
                
            } catch (error) {
                console.error('Save transaction error:', error);
                showMessage('Errore nel salvataggio transazione', 'error');
                hideLoading(document.getElementById('saveTransactionBtn'), '<span>üíæ</span> Salva');
            }
        }
        
        function editTransaction(id) {
            console.log('Editing transaction with ID:', id);
            const transaction = appData.transactions.find(t => t.id === id);
            if (!transaction) {
                showMessage('Transazione non trovata', 'error');
                console.error('Transaction not found:', id);
                return;
            }
            
            appData.editingId = id;
            addTransaction(transaction.type);
            
            // Populate form with existing data
            setTimeout(() => {
                const amountEl = document.getElementById('amount');
                const descEl = document.getElementById('description');
                const dateEl = document.getElementById('date');
                const clientEl = document.getElementById('client');
                
                if (amountEl) amountEl.value = transaction.amount;
                if (descEl) descEl.value = transaction.description;
                if (dateEl) dateEl.value = transaction.transaction_date || transaction.date;
                if (clientEl) clientEl.value = transaction.client || '';
            }, 100);
        }
        
        function confirmDeleteTransaction(id) {
            console.log('Confirming delete for transaction:', id);
            const transaction = appData.transactions.find(t => t.id === id);
            if (!transaction) {
                showMessage('Transazione non trovata', 'error');
                return;
            }
            
            showConfirmDialog(
                'Elimina Transazione',
                `Sei sicuro di voler eliminare la transazione "${transaction.description}"? Questa azione non pu√≤ essere annullata.`,
                () => deleteTransaction(id)
            );
        }
        
        async function deleteTransaction(id) {
            console.log('Deleting transaction with ID:', id);
            console.log('Transactions before delete:', appData.transactions.length);
            
            try {
                const initialLength = appData.transactions.length;
                appData.transactions = appData.transactions.filter(t => t.id !== id);
                
                // Try to delete from Supabase, but continue if it fails
                if (appData.connected) {
                    try {
                        await deleteFromSupabase('transactions', id);
                    } catch (error) {
                        console.warn('Supabase delete failed:', error);
                    }
                }
                
                // Always save to localStorage
                saveDataToLocalStorage();
                
                if (appData.transactions.length < initialLength) {
                    console.log('Transaction deleted successfully. New count:', appData.transactions.length);
                    showMessage('Transazione eliminata con successo!');
                    loadTransactions();
                    updateDashboard();
                    updateClientTotalSpent();
                    
                    // Refresh calendar if we're on that page
                    if (appData.currentPage === 'calendar') {
                        renderCalendar();
                    }
                } else {
                    console.error('Failed to delete transaction');
                    showMessage('Errore nell\'eliminazione della transazione', 'error');
                }
            } catch (error) {
                console.error('Delete transaction error:', error);
                showMessage('Errore nell\'eliminazione della transazione', 'error');
            }
        }
        
        const debouncedFilterTransactions = debounce(() => {
            const searchTerm = document.getElementById('transactionSearch')?.value.toLowerCase() || '';
            const rows = document.querySelectorAll('#transactionsContainer tbody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }, 300);
        
        // ===== CLIENTS FUNCTIONS =====
        function loadClients() {
            const container = document.getElementById('clientsContainer');
            if (!container) return;
            
            if (appData.clients.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üë§</div>
                        <h3>Nessun cliente</h3>
                        <p>Inizia aggiungendo il tuo primo cliente!</p>
                    </div>
                `;
                return;
            }
            
            // Sort clients by total spent (highest first)
            const sortedClients = [...appData.clients].sort((a, b) => 
                (b.total_spent || b.totalSpent || 0) - (a.total_spent || a.totalSpent || 0)
            );
            
            const tableHTML = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Nome</th>
                            <th>Email</th>
                            <th>Telefono</th>
                            <th>Provenienza</th>
                            <th>Speso Totale</th>
                            <th>Azioni</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${sortedClients.map(client => {
                            const sourceEmoji = {
                                'vinted': 'üëï',
                                'wallapop': 'üõí',
                                'subito': 'üáÆüáπ',
                                'ebay': 'üè™',
                                'facebook': 'üë•',
                                'instagram': 'üì∑'
                            };
                            const source = client.source || client.client_source;
                            const sourceDisplay = sourceEmoji[source] || '‚ùì';
                            
                            return `
                                <tr data-id="${client.id}">
                                    <td><strong>${client.name || client.client_name}</strong></td>
                                    <td>${client.email || client.client_email}</td>
                                    <td>${client.phone || client.client_phone}</td>
                                    <td>
                                        <span style="display: flex; align-items: center; gap: 0.5rem;">
                                            ${sourceDisplay} ${source ? source.charAt(0).toUpperCase() + source.slice(1) : 'Non specificato'}
                                        </span>
                                    </td>
                                    <td style="color: var(--success); font-weight: 600;">${formatCurrency(client.total_spent || client.totalSpent || 0)}</td>
                                    <td>
                                        <button class="btn btn-secondary" onclick="editClient('${client.id}')" style="padding: 0.25rem 0.5rem; font-size: 0.75rem; margin: 0.125rem;">
                                            ‚úèÔ∏è Modifica
                                        </button>
                                        <button class="btn btn-error" onclick="confirmDeleteClient('${client.id}')" style="padding: 0.25rem 0.5rem; font-size: 0.75rem; margin: 0.125rem;">
                                            üóëÔ∏è Elimina
                                        </button>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
            
            container.innerHTML = tableHTML;
            console.log('Clients loaded:', appData.clients.length);
        }
        
        function addClient() {
            const content = `
                <h3 id="modalTitle" style="color: var(--accent); margin-bottom: var(--space-6);">üë§ Nuovo Cliente</h3>
                <div class="form-group">
                    <label for="clientName">Nome</label>
                    <input type="text" id="clientName" required>
                </div>
                <div class="form-group">
                    <label for="clientEmail">Email</label>
                    <input type="email" id="clientEmail" required>
                </div>
                <div class="form-group">
                    <label for="clientPhone">Telefono</label>
                    <input type="tel" id="clientPhone" required>
                </div>
                <div class="form-group">
                    <label for="clientSource">Provenienza</label>
                    <select id="clientSource" required>
                        <option value="">Seleziona provenienza...</option>
                        <option value="vinted">üëï Vinted</option>
                        <option value="wallapop">üõí Wallapop</option>
                        <option value="subito">üáÆüáπ Subito</option>
                        <option value="ebay">üè™ eBay</option>
                        <option value="facebook">üë• Facebook</option>
                        <option value="instagram">üì∑ Instagram</option>
                    </select>
                </div>
                <div class="quick-actions">
                    <button type="button" class="btn btn-success" onclick="saveClientFromForm()" id="saveClientBtn">
                        <span>üíæ</span> Salva
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">
                        <span>‚ùå</span> Annulla
                    </button>
                </div>
            `;
            openModal(content);
        }
        
        async function saveClientFromForm() {
            try {
                const saveBtn = document.getElementById('saveClientBtn');
                const originalText = '<span>üíæ</span> Salva';
                
                showLoading(saveBtn, 'Salvando...');
                
                const name = document.getElementById('clientName')?.value;
                const email = document.getElementById('clientEmail')?.value;
                const phone = document.getElementById('clientPhone')?.value;
                const source = document.getElementById('clientSource')?.value;
                
                if (!name || !email || !phone || !source) {
                    hideLoading(saveBtn, originalText);
                    showMessage('Compila tutti i campi obbligatori', 'error');
                    return;
                }
                
                // Validate email format
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(email)) {
                    hideLoading(saveBtn, originalText);
                    showMessage('Formato email non valido', 'error');
                    return;
                }
                
                // Check for duplicate email (except when editing)
                const existingClient = appData.clients.find(c => 
                    (c.email || c.client_email) === email && c.id !== appData.editingId
                );
                if (existingClient) {
                    hideLoading(saveBtn, originalText);
                    showMessage('Email gi√† esistente per un altro cliente', 'error');
                    return;
                }
                
                const formData = {
                    id: appData.editingId || generateId(),
                    client_name: name,
                    client_email: email,
                    client_phone: phone,
                    client_source: source,
                    total_spent: 0,
                    created_at: formatDateTime(),
                    // Legacy compatibility
                    name: name,
                    email: email,
                    phone: phone,
                    source: source,
                    totalSpent: 0
                };
                
                if (appData.editingId) {
                    const index = appData.clients.findIndex(c => c.id === appData.editingId);
                    if (index !== -1) {
                        // Preserve totalSpent when editing
                        formData.total_spent = appData.clients[index].total_spent || appData.clients[index].totalSpent || 0;
                        formData.totalSpent = formData.total_spent;
                        appData.clients[index] = formData;
                        
                        // Try to save to Supabase, but continue if it fails
                        if (appData.connected) {
                            try {
                                await saveToSupabase('clients', formData);
                                showMessage('Cliente aggiornato e sincronizzato!');
                            } catch (error) {
                                console.warn('Supabase save failed:', error);
                                showMessage('Cliente aggiornato localmente (sync fallito)', 'error');
                            }
                        } else {
                            showMessage('Cliente aggiornato (modalit√† offline)');
                        }
                        
                        console.log('Client updated:', formData);
                    }
                    appData.editingId = null;
                } else {
                    appData.clients.push(formData);
                    
                    // Try to save to Supabase, but continue if it fails
                    if (appData.connected) {
                        try {
                            await saveToSupabase('clients', formData);
                            showMessage('Cliente aggiunto e sincronizzato!');
                        } catch (error) {
                            console.warn('Supabase save failed:', error);
                            showMessage('Cliente aggiunto localmente (sync fallito)', 'error');
                        }
                    } else {
                        showMessage('Cliente aggiunto (modalit√† offline)');
                    }
                    
                    console.log('Client added:', formData);
                }
                
                // Always save to localStorage as backup
                saveDataToLocalStorage();
                
                hideLoading(saveBtn, originalText);
                closeModal();
                loadClients();
                updateClientTotalSpent();
                
            } catch (error) {
                console.error('Save client error:', error);
                showMessage('Errore nel salvataggio cliente', 'error');
                hideLoading(document.getElementById('saveClientBtn'), '<span>üíæ</span> Salva');
            }
        }
        
        function editClient(id) {
            console.log('Editing client with ID:', id);
            const client = appData.clients.find(c => c.id === id);
            if (!client) {
                showMessage('Cliente non trovato', 'error');
                console.error('Client not found:', id);
                return;
            }
            
            appData.editingId = id;
            addClient();
            
            // Populate form with existing data
            setTimeout(() => {
                const nameEl = document.getElementById('clientName');
                const emailEl = document.getElementById('clientEmail');
                const phoneEl = document.getElementById('clientPhone');
                const sourceEl = document.getElementById('clientSource');
                
                if (nameEl) nameEl.value = client.client_name || client.name;
                if (emailEl) emailEl.value = client.client_email || client.email;
                if (phoneEl) phoneEl.value = client.client_phone || client.phone;
                if (sourceEl) sourceEl.value = client.client_source || client.source || '';
            }, 100);
        }
        
        function confirmDeleteClient(id) {
            console.log('Confirming delete for client:', id);
            const client = appData.clients.find(c => c.id === id);
            if (!client) {
                showMessage('Cliente non trovato', 'error');
                return;
            }
            
            showConfirmDialog(
                'Elimina Cliente',
                `Sei sicuro di voler eliminare il cliente "${client.client_name || client.name}"? Questa azione non pu√≤ essere annullata.`,
                () => deleteClient(id)
            );
        }
        
        async function deleteClient(id) {
            console.log('Deleting client with ID:', id);
            console.log('Clients before delete:', appData.clients.length);
            
            try {
                const initialLength = appData.clients.length;
                appData.clients = appData.clients.filter(c => c.id !== id);
                
                // Try to delete from Supabase, but continue if it fails
                if (appData.connected) {
                    try {
                        await deleteFromSupabase('clients', id);
                    } catch (error) {
                        console.warn('Supabase delete failed:', error);
                    }
                }
                
                // Always save to localStorage
                saveDataToLocalStorage();
                
                if (appData.clients.length < initialLength) {
                    console.log('Client deleted successfully. New count:', appData.clients.length);
                    showMessage('Cliente eliminato con successo!');
                    loadClients();
                    updateDashboard();
                } else {
                    console.error('Failed to delete client');
                    showMessage('Errore nell\'eliminazione del cliente', 'error');
                }
            } catch (error) {
                console.error('Delete client error:', error);
                showMessage('Errore nell\'eliminazione del cliente', 'error');
            }
        }
        
        const debouncedFilterClients = debounce(() => {
            const searchTerm = document.getElementById('clientSearch')?.value.toLowerCase() || '';
            const rows = document.querySelectorAll('#clientsContainer tbody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }, 300);
        
        // ===== INVENTORY FUNCTIONS =====
        function loadInventory() {
            const container = document.getElementById('inventoryContainer');
            if (!container) return;
            
            if (appData.inventory.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üì¶</div>
                        <h3>Nessun componente</h3>
                        <p>Inizia aggiungendo il tuo primo componente!</p>
                    </div>
                `;
                return;
            }
            
            // Sort inventory by status (low stock first) then by name
            const sortedInventory = [...appData.inventory].sort((a, b) => {
                const aIsLow = (a.quantity || 0) <= (a.threshold || 0);
                const bIsLow = (b.quantity || 0) <= (b.threshold || 0);
                if (aIsLow && !bIsLow) return -1;
                if (!aIsLow && bIsLow) return 1;
                return (a.item_name || a.name || '').localeCompare(b.item_name || b.name || '');
            });
            
            const tableHTML = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Nome</th>
                            <th>Quantit√†</th>
                            <th>Soglia</th>
                            <th>Prezzo</th>
                            <th>Fornitore</th>
                            <th>Stato</th>
                            <th>Azioni</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${sortedInventory.map(item => {
                            const isLowStock = (item.quantity || 0) <= (item.threshold || 0);
                            return `
                                <tr data-id="${item.id}" ${isLowStock ? 'style="background: rgba(239, 68, 68, 0.1);"' : ''}>
                                    <td><strong>${item.item_name || item.name}</strong></td>
                                    <td style="color: ${isLowStock ? 'var(--error)' : 'var(--success)'}; font-weight: 600;">${item.quantity || 0}</td>
                                    <td>${item.threshold || 0}</td>
                                    <td>${formatCurrency(item.price || 0)}</td>
                                    <td>${item.supplier || ''}</td>
                                    <td>
                                        <span style="color: ${isLowStock ? 'var(--error)' : 'var(--success)'}; font-weight: 600;">
                                            ${isLowStock ? '‚ö†Ô∏è Scorte Basse' : '‚úÖ OK'}
                                        </span>
                                    </td>
                                    <td>
                                        <button class="btn btn-secondary" onclick="editInventoryItem('${item.id}')" style="padding: 0.25rem 0.5rem; font-size: 0.75rem; margin: 0.125rem;">
                                            ‚úèÔ∏è Modifica
                                        </button>
                                        <button class="btn btn-error" onclick="confirmDeleteInventoryItem('${item.id}')" style="padding: 0.25rem 0.5rem; font-size: 0.75rem; margin: 0.125rem;">
                                            üóëÔ∏è Elimina
                                        </button>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
            
            container.innerHTML = tableHTML;
            console.log('Inventory loaded:', appData.inventory.length);
        }
        
        function addInventoryItem() {
            const content = `
                <h3 id="modalTitle" style="color: var(--accent); margin-bottom: var(--space-6);">üì¶ Nuovo Componente</h3>
                <div class="form-group">
                    <label for="itemName">Nome Componente</label>
                    <input type="text" id="itemName" required>
                </div>
                <div class="form-group">
                    <label for="itemQuantity">Quantit√†</label>
                    <input type="number" id="itemQuantity" min="0" required>
                </div>
                <div class="form-group">
                    <label for="itemThreshold">Soglia Minima</label>
                    <input type="number" id="itemThreshold" min="0" required>
                </div>
                <div class="form-group">
                    <label for="itemPrice">Prezzo (‚Ç¨)</label>
                    <input type="number" id="itemPrice" step="0.01" min="0" required>
                </div>
                <div class="form-group">
                    <label for="itemSupplier">Fornitore</label>
                    <input type="text" id="itemSupplier" required>
                </div>
                <div class="quick-actions">
                    <button type="button" class="btn btn-success" onclick="saveInventoryItemFromForm()" id="saveInventoryBtn">
                        <span>üíæ</span> Salva
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">
                        <span>‚ùå</span> Annulla
                    </button>
                </div>
            `;
            openModal(content);
        }
        
        async function saveInventoryItemFromForm() {
            try {
                const saveBtn = document.getElementById('saveInventoryBtn');
                const originalText = '<span>üíæ</span> Salva';
                
                showLoading(saveBtn, 'Salvando...');
                
                const name = document.getElementById('itemName')?.value;
                const quantity = document.getElementById('itemQuantity')?.value;
                const threshold = document.getElementById('itemThreshold')?.value;
                const price = document.getElementById('itemPrice')?.value;
                const supplier = document.getElementById('itemSupplier')?.value;
                
                if (!name || !quantity || !threshold || !price || !supplier) {
                    hideLoading(saveBtn, originalText);
                    showMessage('Compila tutti i campi obbligatori', 'error');
                    return;
                }
                
                // Validate quantities
                if (parseInt(quantity) < 0 || parseInt(threshold) < 0 || parseFloat(price) < 0) {
                    hideLoading(saveBtn, originalText);
                    showMessage('I valori numerici non possono essere negativi', 'error');
                    return;
                }
                
                const formData = {
                    id: appData.editingId || generateId(),
                    item_name: name,
                    quantity: parseInt(quantity),
                    threshold: parseInt(threshold),
                    price: parseFloat(price),
                    supplier: supplier,
                    created_at: formatDateTime(),
                    // Legacy compatibility
                    name: name
                };
                
                if (appData.editingId) {
                    const index = appData.inventory.findIndex(i => i.id === appData.editingId);
                    if (index !== -1) {
                        appData.inventory[index] = formData;
                        
                        // Try to save to Supabase, but continue if it fails
                        if (appData.connected) {
                            try {
                                await saveToSupabase('inventory', formData);
                                showMessage('Componente aggiornato e sincronizzato!');
                            } catch (error) {
                                console.warn('Supabase save failed:', error);
                                showMessage('Componente aggiornato localmente (sync fallito)', 'error');
                            }
                        } else {
                            showMessage('Componente aggiornato (modalit√† offline)');
                        }
                        
                        console.log('Inventory item updated:', formData);
                    }
                    appData.editingId = null;
                } else {
                    appData.inventory.push(formData);
                    
                    // Try to save to Supabase, but continue if it fails
                    if (appData.connected) {
                        try {
                            await saveToSupabase('inventory', formData);
                            showMessage('Componente aggiunto e sincronizzato!');
                        } catch (error) {
                            console.warn('Supabase save failed:', error);
                            showMessage('Componente aggiunto localmente (sync fallito)', 'error');
                        }
                    } else {
                        showMessage('Componente aggiunto (modalit√† offline)');
                    }
                    
                    console.log('Inventory item added:', formData);
                }
                
                // Always save to localStorage as backup
                saveDataToLocalStorage();
                
                hideLoading(saveBtn, originalText);
                closeModal();
                loadInventory();
                updateDashboard();
                
            } catch (error) {
                console.error('Save inventory error:', error);
                showMessage('Errore nel salvataggio componente', 'error');
                hideLoading(document.getElementById('saveInventoryBtn'), '<span>üíæ</span> Salva');
            }
        }
        
        function editInventoryItem(id) {
            console.log('Editing inventory item with ID:', id);
            const item = appData.inventory.find(i => i.id === id);
            if (!item) {
                showMessage('Componente non trovato', 'error');
                console.error('Inventory item not found:', id);
                return;
            }
            
            appData.editingId = id;
            addInventoryItem();
            
            // Populate form with existing data
            setTimeout(() => {
                const nameEl = document.getElementById('itemName');
                const quantityEl = document.getElementById('itemQuantity');
                const thresholdEl = document.getElementById('itemThreshold');
                const priceEl = document.getElementById('itemPrice');
                const supplierEl = document.getElementById('itemSupplier');
                
                if (nameEl) nameEl.value = item.item_name || item.name;
                if (quantityEl) quantityEl.value = item.quantity || 0;
                if (thresholdEl) thresholdEl.value = item.threshold || 0;
                if (priceEl) priceEl.value = item.price || 0;
                if (supplierEl) supplierEl.value = item.supplier || '';
            }, 100);
        }
        
        function confirmDeleteInventoryItem(id) {
            console.log('Confirming delete for inventory item:', id);
            const item = appData.inventory.find(i => i.id === id);
            if (!item) {
                showMessage('Componente non trovato', 'error');
                return;
            }
            
            showConfirmDialog(
                'Elimina Componente',
                `Sei sicuro di voler eliminare il componente "${item.item_name || item.name}"? Questa azione non pu√≤ essere annullata.`,
                () => deleteInventoryItem(id)
            );
        }
        
        async function deleteInventoryItem(id) {
            console.log('Deleting inventory item with ID:', id);
            console.log('Inventory before delete:', appData.inventory.length);
            
            try {
                const initialLength = appData.inventory.length;
                appData.inventory = appData.inventory.filter(i => i.id !== id);
                
                // Try to delete from Supabase, but continue if it fails
                if (appData.connected) {
                    try {
                        await deleteFromSupabase('inventory', id);
                    } catch (error) {
                        console.warn('Supabase delete failed:', error);
                    }
                }
                
                // Always save to localStorage
                saveDataToLocalStorage();
                
                if (appData.inventory.length < initialLength) {
                    console.log('Inventory item deleted successfully. New count:', appData.inventory.length);
                    showMessage('Componente eliminato con successo!');
                    loadInventory();
                    updateDashboard();
                } else {
                    console.error('Failed to delete inventory item');
                    showMessage('Errore nell\'eliminazione del componente', 'error');
                }
            } catch (error) {
                console.error('Delete inventory item error:', error);
                showMessage('Errore nell\'eliminazione del componente', 'error');
            }
        }
        
        const debouncedFilterInventory = debounce(() => {
            const searchTerm = document.getElementById('inventorySearch')?.value.toLowerCase() || '';
            const rows = document.querySelectorAll('#inventoryContainer tbody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }, 300);
        
        // ===== ANALYTICS FUNCTIONS =====
        function loadAnalytics() {
            loadMonthlyTrends();
            loadTopClients();
            loadMonthlyPerformance();
            loadKPIDashboard();
        }
        
        function getMonthName(monthIndex) {
            const months = [
                'Gennaio', 'Febbraio', 'Marzo', 'Aprile', 'Maggio', 'Giugno',
                'Luglio', 'Agosto', 'Settembre', 'Ottobre', 'Novembre', 'Dicembre'
            ];
            return months[monthIndex];
        }

        function getLastSixMonths() {
            const months = [];
            const now = new Date();
            
            for (let i = 5; i >= 0; i--) {
                const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
                months.push({
                    year: date.getFullYear(),
                    month: date.getMonth(),
                    monthName: getMonthName(date.getMonth()),
                    key: `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`
                });
            }
            return months;
        }

        function getTransactionsByMonth() {
            const monthlyData = {};
            
            appData.transactions.forEach(transaction => {
                const date = new Date(transaction.transaction_date || transaction.date);
                const key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                
                if (!monthlyData[key]) {
                    monthlyData[key] = {
                        revenue: 0,
                        expenses: 0,
                        count: 0
                    };
                }
                
                if (transaction.type === 'revenue') {
                    monthlyData[key].revenue += parseFloat(transaction.amount || 0);
                } else if (transaction.type === 'expense') {
                    monthlyData[key].expenses += parseFloat(transaction.amount || 0);
                }
                monthlyData[key].count++;
            });
            
            return monthlyData;
        }
        
        function loadMonthlyTrends() {
            const container = document.getElementById('monthlyTrends');
            if (!container) return;
            
            const months = getLastSixMonths();
            const monthlyData = getTransactionsByMonth();
            
            // Fill in missing months with zero data
            const chartData = months.map(month => ({
                ...month,
                revenue: monthlyData[month.key]?.revenue || 0,
                expenses: monthlyData[month.key]?.expenses || 0,
                profit: (monthlyData[month.key]?.revenue || 0) - (monthlyData[month.key]?.expenses || 0)
            }));
            
            const maxValue = Math.max(...chartData.map(d => Math.max(d.revenue, d.expenses))) || 100;
            
            container.innerHTML = `
                <div style="margin-bottom: var(--space-4);">
                    <p style="color: var(--text-muted); font-size: 0.875rem;">
                        üìä Trend basati sui dati reali delle tue transazioni
                    </p>
                </div>
                <div style="display: flex; align-items: end; gap: 1rem; height: 200px; padding: 1rem;">
                    ${chartData.map(data => `
                        <div style="display: flex; flex-direction: column; align-items: center; flex: 1;">
                            <div style="display: flex; flex-direction: column; gap: 0.25rem; width: 100%; height: 150px; justify-content: end;">
                                <!-- Revenue Bar -->
                                <div class="chart-bar" style="
                                    height: ${maxValue > 0 ? (data.revenue / maxValue) * 70 : 0}px;
                                    background: linear-gradient(135deg, var(--success), #059669);
                                    display: flex;
                                    align-items: end;
                                    justify-content: center;
                                    font-size: 0.7rem;
                                    color: white;
                                    font-weight: 600;
                                    padding: 0.125rem;
                                    border-radius: var(--radius-sm);
                                " title="Entrate: ${formatCurrency(data.revenue)}">
                                    ${data.revenue > 0 ? formatCurrency(data.revenue) : ''}
                                </div>
                                <!-- Expenses Bar -->
                                <div class="chart-bar" style="
                                    height: ${maxValue > 0 ? (data.expenses / maxValue) * 70 : 0}px;
                                    background: linear-gradient(135deg, var(--error), #dc2626);
                                    display: flex;
                                    align-items: end;
                                    justify-content: center;
                                    font-size: 0.7rem;
                                    color: white;
                                    font-weight: 600;
                                    padding: 0.125rem;
                                    border-radius: var(--radius-sm);
                                " title="Spese: ${formatCurrency(data.expenses)}">
                                    ${data.expenses > 0 ? formatCurrency(data.expenses) : ''}
                                </div>
                            </div>
                            <div style="margin-top: var(--space-2);">
                                <div style="font-size: 0.875rem; color: var(--text-muted); text-align: center;">
                                    ${data.monthName.substring(0, 3)}
                                </div>
                                <div style="font-size: 0.75rem; color: ${data.profit >= 0 ? 'var(--success)' : 'var(--error)'}; font-weight: 600; text-align: center;">
                                    ${formatCurrency(data.profit)}
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
                <div style="display: flex; justify-content: center; gap: var(--space-4); margin-top: var(--space-4); font-size: 0.875rem;">
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <div style="width: 1rem; height: 1rem; background: linear-gradient(135deg, var(--success), #059669); border-radius: 0.25rem;"></div>
                        <span>Entrate</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <div style="width: 1rem; height: 1rem; background: linear-gradient(135deg, var(--error), #dc2626); border-radius: 0.25rem;"></div>
                        <span>Spese</span>
                    </div>
                </div>
            `;
        }
        
        function loadTopClients() {
            const container = document.getElementById('topClients');
            if (!container) return;
            
            // Calculate client spending from transactions
            const clientSpending = {};
            appData.transactions.filter(t => t.type === 'revenue' && t.client).forEach(transaction => {
                clientSpending[transaction.client] = (clientSpending[transaction.client] || 0) + parseFloat(transaction.amount);
            });
            
            const topClients = Object.entries(clientSpending)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 5);
            
            if (topClients.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üë§</div>
                        <p>Nessun dato cliente disponibile</p>
                        <p style="font-size: 0.875rem; margin-top: var(--space-2);">Aggiungi clienti alle transazioni per vedere le statistiche</p>
                    </div>
                `;
                return;
            }
            
            const maxSpending = Math.max(...topClients.map(([, amount]) => amount));
            
            container.innerHTML = `
                <div style="display: flex; flex-direction: column; gap: 1rem;">
                    ${topClients.map(([client, amount], index) => {
                        const percentage = maxSpending > 0 ? (amount / maxSpending) * 100 : 0;
                        return `
                            <div style="
                                display: flex;
                                justify-content: space-between;
                                align-items: center;
                                padding: 1rem;
                                background: var(--surface);
                                border-radius: var(--radius-lg);
                                border: 1px solid rgba(255, 255, 255, 0.1);
                                position: relative;
                                overflow: hidden;
                            ">
                                <!-- Progress Background -->
                                <div style="
                                    position: absolute;
                                    top: 0;
                                    left: 0;
                                    height: 100%;
                                    width: ${percentage}%;
                                    background: linear-gradient(90deg, transparent, rgba(59, 130, 246, 0.1));
                                    transition: width 1s ease;
                                "></div>
                                
                                <div style="display: flex; align-items: center; gap: 1rem; position: relative; z-index: 1;">
                                    <span style="
                                        background: var(--gradient-primary);
                                        color: white;
                                        width: 2rem;
                                        height: 2rem;
                                        border-radius: 50%;
                                        display: flex;
                                        align-items: center;
                                        justify-content: center;
                                        font-weight: 700;
                                        font-size: 0.875rem;
                                    ">${index + 1}</span>
                                    <div>
                                        <div style="font-weight: 600; margin-bottom: 0.25rem;">${client}</div>
                                        <div style="font-size: 0.875rem; color: var(--text-muted);">
                                            ${appData.transactions.filter(t => t.client === client && t.type === 'revenue').length} transazioni
                                        </div>
                                    </div>
                                </div>
                                <span style="color: var(--success); font-weight: 700; font-size: 1.1rem; position: relative; z-index: 1;">
                                    ${formatCurrency(amount)}
                                </span>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }
        
        function loadMonthlyPerformance() {
            const container = document.getElementById('monthlyPerformance');
            if (!container) return;
            
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            const currentMonthKey = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}`;
            const previousMonthKey = `${currentYear}-${String(currentMonth).padStart(2, '0')}`;
            
            const monthlyData = getTransactionsByMonth();
            const currentData = monthlyData[currentMonthKey] || { revenue: 0, expenses: 0, count: 0 };
            const previousData = monthlyData[previousMonthKey] || { revenue: 0, expenses: 0, count: 0 };
            
            const revenueChange = previousData.revenue > 0 ? 
                ((currentData.revenue - previousData.revenue) / previousData.revenue * 100) : 0;
            const expenseChange = previousData.expenses > 0 ? 
                ((currentData.expenses - previousData.expenses) / previousData.expenses * 100) : 0;
            
            container.innerHTML = `
                <div style="display: grid; gap: 1rem;">
                    <div style="background: var(--surface); padding: 1rem; border-radius: var(--radius-lg); border: 1px solid rgba(255, 255, 255, 0.1);">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-size: 0.875rem; color: var(--text-muted); margin-bottom: 0.5rem;">Entrate Questo Mese</div>
                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--success);">${formatCurrency(currentData.revenue)}</div>
                            </div>
                            <div style="color: ${revenueChange >= 0 ? 'var(--success)' : 'var(--error)'}; font-weight: 600;">
                                ${revenueChange >= 0 ? '‚ÜóÔ∏è' : '‚ÜòÔ∏è'} ${Math.abs(revenueChange).toFixed(1)}%
                            </div>
                        </div>
                    </div>
                    
                    <div style="background: var(--surface); padding: 1rem; border-radius: var(--radius-lg); border: 1px solid rgba(255, 255, 255, 0.1);">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-size: 0.875rem; color: var(--text-muted); margin-bottom: 0.5rem;">Spese Questo Mese</div>
                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--error);">${formatCurrency(currentData.expenses)}</div>
                            </div>
                            <div style="color: ${expenseChange <= 0 ? 'var(--success)' : 'var(--error)'}; font-weight: 600;">
                                ${expenseChange <= 0 ? '‚ÜòÔ∏è' : '‚ÜóÔ∏è'} ${Math.abs(expenseChange).toFixed(1)}%
                            </div>
                        </div>
                    </div>
                    
                    <div style="background: var(--surface); padding: 1rem; border-radius: var(--radius-lg); border: 1px solid rgba(255, 255, 255, 0.1);">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-size: 0.875rem; color: var(--text-muted); margin-bottom: 0.5rem;">Profitto Questo Mese</div>
                                <div style="font-size: 1.5rem; font-weight: 700; color: ${(currentData.revenue - currentData.expenses) >= 0 ? 'var(--success)' : 'var(--error)'};">
                                    ${formatCurrency(currentData.revenue - currentData.expenses)}
                                </div>
                            </div>
                            <div style="color: var(--accent); font-weight: 600;">
                                üìä ${currentData.count} transazioni
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function loadKPIDashboard() {
            const container = document.getElementById('kpiDashboard');
            if (!container) return;
            
            const revenues = appData.transactions.filter(t => t.type === 'revenue');
            const expenses = appData.transactions.filter(t => t.type === 'expense');
            
            const totalRevenue = revenues.reduce((sum, t) => sum + parseFloat(t.amount), 0);
            const totalExpenses = expenses.reduce((sum, t) => sum + parseFloat(t.amount), 0);
            const avgOrderValue = revenues.length > 0 ? totalRevenue / revenues.length : 0;
            const profitMargin = totalRevenue > 0 ? ((totalRevenue - totalExpenses) / totalRevenue * 100) : 0;
            
            // Low stock items
            const lowStockItems = appData.inventory.filter(item => (item.quantity || 0) <= (item.threshold || 0));
            
            // Active clients (clients with transactions)
            const activeClients = new Set(appData.transactions.filter(t => t.client).map(t => t.client)).size;
            
            container.innerHTML = `
                <div style="display: grid; gap: 1rem;">
                    <div style="background: var(--surface); padding: 1rem; border-radius: var(--radius-lg); border: 1px solid rgba(255, 255, 255, 0.1);">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-size: 0.875rem; color: var(--text-muted);">Valore Medio Ordine</div>
                                <div style="font-size: 1.25rem; font-weight: 700; color: var(--primary);">${formatCurrency(avgOrderValue)}</div>
                            </div>
                            <span style="font-size: 1.5rem;">üí∞</span>
                        </div>
                    </div>
                    
                    <div style="background: var(--surface); padding: 1rem; border-radius: var(--radius-lg); border: 1px solid rgba(255, 255, 255, 0.1);">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-size: 0.875rem; color: var(--text-muted);">Margine di Profitto</div>
                                <div style="font-size: 1.25rem; font-weight: 700; color: ${profitMargin >= 0 ? 'var(--success)' : 'var(--error)'};">${profitMargin.toFixed(1)}%</div>
                            </div>
                            <span style="font-size: 1.5rem;">üìà</span>
                        </div>
                    </div>
                    
                    <div style="background: var(--surface); padding: 1rem; border-radius: var(--radius-lg); border: 1px solid rgba(255, 255, 255, 0.1);">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-size: 0.875rem; color: var(--text-muted);">Clienti Attivi</div>
                                <div style="font-size: 1.25rem; font-weight: 700; color: var(--accent);">${activeClients}</div>
                            </div>
                            <span style="font-size: 1.5rem;">üë•</span>
                        </div>
                    </div>
                    
                    <div style="background: var(--surface); padding: 1rem; border-radius: var(--radius-lg); border: 1px solid rgba(255, 255, 255, 0.1);">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-size: 0.875rem; color: var(--text-muted);">Scorte Basse</div>
                                <div style="font-size: 1.25rem; font-weight: 700; color: ${lowStockItems.length > 0 ? 'var(--error)' : 'var(--success)'};">${lowStockItems.length}</div>
                            </div>
                            <span style="font-size: 1.5rem;">${lowStockItems.length > 0 ? '‚ö†Ô∏è' : '‚úÖ'}</span>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // ===== SPIDER AI =====
        const SpiderAI = {
            analyze: function(data) {
                const suggestions = [];
                const { transactions = [], clients = [], inventory = [], orders = [] } = data;
                
                try {
                    const revenues = transactions.filter(t => t.type === 'revenue');
                    const totalRevenue = revenues.reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);
                    
                    if (transactions.length === 0 && orders.length === 0) {
                        suggestions.push('üï∑Ô∏è Spider-AI inizializzato! Aggiungi transazioni e ordini per analisi avanzate.');
                        suggestions.push('üöÄ Sistema pronto per machine learning sui tuoi dati business.');
                        return suggestions;
                    }
                    
                    // Orders analysis
                    if (orders.length > 0) {
                        const pendingOrders = orders.filter(o => o.status === 'pending').length;
                        const inProgressOrders = orders.filter(o => o.status === 'in-progress').length;
                        
                        if (pendingOrders > 0) {
                            suggestions.push(`üìã ${pendingOrders} ordini in attesa - Prioritizza la pianificazione!`);
                        }
                        if (inProgressOrders > 0) {
                            suggestions.push(`üîß ${inProgressOrders} ordini in lavorazione - Mantieni il focus!`);
                        }
                        
                        // Check for overdue orders
                        const today = new Date();
                        const overdueOrders = orders.filter(o => 
                            new Date(o.due_date || o.dueDate) < today && o.status !== 'completed' && o.status !== 'cancelled'
                        );
                        if (overdueOrders.length > 0) {
                            suggestions.push(`‚ö†Ô∏è ALERT: ${overdueOrders.length} ordini in ritardo! Contatta i clienti.`);
                        }
                    }
                    
                    if (totalRevenue > 0) {
                        suggestions.push(`üï∑Ô∏è Ottimo lavoro! Ricavi totali: ${formatCurrency(totalRevenue)}`);
                        if (totalRevenue > 1000) {
                            suggestions.push('üíé Milestone 1K raggiunta! AI suggerisce espansione strategica.');
                        }
                        if (totalRevenue > 5000) {
                            suggestions.push('üöÄ Business in crescita! Considera diversificazione prodotti.');
                        }
                    }
                    
                    // Client analysis
                    if (clients.length > 0) {
                        const avgClientValue = totalRevenue / clients.length;
                        suggestions.push(`üë§ Base clienti: ${clients.length} - Valore medio: ${formatCurrency(avgClientValue)}`);
                        
                        if (avgClientValue > 200) {
                            suggestions.push('üéØ Alto valore cliente! Implementa programma fedelt√†.');
                        }
                    }
                    
                    // Inventory analysis
                    const lowStock = inventory.filter(item => (item.quantity || 0) <= (item.threshold || 5));
                    if (lowStock.length > 0) {
                        suggestions.push(`üì¶ SPIDER-SENSE ALERT: ${lowStock.length} componenti sotto soglia!`);
                    }
                    
                    // Performance analysis
                    const expenses = transactions.filter(t => t.type === 'expense');
                    const totalExpenses = expenses.reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);
                    const profitMargin = totalRevenue > 0 ? ((totalRevenue - totalExpenses) / totalRevenue * 100) : 0;
                    
                    if (profitMargin > 50) {
                        suggestions.push('üí∞ Margine di profitto eccellente! Business sostenibile.');
                    } else if (profitMargin < 20 && profitMargin > 0) {
                        suggestions.push('‚ö†Ô∏è Margine basso. Rivedi struttura costi o prezzi.');
                    }
                    
                } catch (error) {
                    console.error('AI Analysis error:', error);
                    suggestions.push('ü§ñ Spider-AI in manutenzione - Riprova tra poco!');
                }
                
                return suggestions.length > 0 ? suggestions : ['üï∑Ô∏è Spider-AI Neural Network attivo!'];
            },
            
            generatePredictions: function(data) {
                const { transactions = [], clients = [], inventory = [], orders = [] } = data;
                
                if (transactions.length < 3 && orders.length < 2) {
                    return [{
                        title: "üîÆ Raccolta Dati in Corso",
                        description: "Il neural network necessita di pi√π dati per generare predizioni accurate.",
                        confidence: 85
                    }];
                }
                
                const predictions = [];
                
                // Orders workflow prediction
                if (orders.length > 0) {
                    const avgCompletionTime = 14; // Assumption based on sample data
                    const inProgressOrders = orders.filter(o => o.status === 'in-progress').length;
                    const pendingOrders = orders.filter(o => o.status === 'pending').length;
                    
                    if (inProgressOrders > 0 || pendingOrders > 0) {
                        predictions.push({
                            title: "üìã Gestione Ordini",
                            description: `${inProgressOrders + pendingOrders} ordini attivi. Tempo medio completamento: ${avgCompletionTime} giorni. Pianifica risorse per gestione ottimale del workflow.`,
                            confidence: 88
                        });
                    }
                }
                
                // Revenue prediction based on historical data
                const revenues = transactions.filter(t => t.type === 'revenue');
                if (revenues.length > 2) {
                    const avgRevenue = revenues.reduce((sum, t) => sum + parseFloat(t.amount), 0) / revenues.length;
                    const trendMultiplier = revenues.length > 5 ? 1.15 : 1.08;
                    
                    predictions.push({
                        title: "üìà Proiezione Ricavi",
                        description: `Basandomi sui pattern recenti, prevedo ricavi medi di ${formatCurrency(avgRevenue * trendMultiplier)} per i prossimi ordini (+${Math.round((trendMultiplier - 1) * 100)}%).`,
                        confidence: Math.min(78 + revenues.length * 2, 95)
                    });
                }
                
                // Inventory optimization
                const lowStockItems = inventory.filter(item => (item.quantity || 0) <= (item.threshold || 0));
                if (lowStockItems.length > 0) {
                    predictions.push({
                        title: "üì¶ Ottimizzazione Scorte",
                        description: `${lowStockItems.length} componenti necessitano riordino. Costo stimato: ${formatCurrency(lowStockItems.reduce((sum, item) => sum + ((item.price || 0) * (item.threshold || 0)), 0))}.`,
                        confidence: 91
                    });
                }
                
                return predictions;
            }
        };
        
        function runAIAnalysis() {
            try {
                const analysis = SpiderAI.analyze(appData);
                const aiDiv = document.getElementById('aiSuggestions');
                if (aiDiv && analysis.length > 0) {
                    aiDiv.innerHTML = analysis.map(suggestion => `<p>‚Ä¢ ${suggestion}</p>`).join('');
                }
                showMessage('üß† Analisi AI completata!');
            } catch (error) {
                console.error('AI Analysis error:', error);
                showMessage('Errore nell\'analisi AI', 'error');
            }
        }
        
        function generatePredictions() {
            try {
                const predictions = SpiderAI.generatePredictions(appData);
                const content = `
                    <h3 id="modalTitle" style="color: var(--accent); margin-bottom: var(--space-6);">üîÆ Predizioni AI Spider-System</h3>
                    <div style="margin: var(--space-6) 0;">
                        ${predictions.map(pred => `
                            <div style="margin: var(--space-4) 0; padding: var(--space-4); background: rgba(59, 130, 246, 0.1); border-radius: var(--radius-lg); border: 1px solid var(--primary); position: relative; overflow: hidden;">
                                <!-- Confidence bar -->
                                <div style="position: absolute; bottom: 0; left: 0; height: 3px; width: ${pred.confidence}%; background: var(--accent); transition: width 1s ease;"></div>
                                
                                <h4 style="color: var(--primary); margin-bottom: var(--space-2); display: flex; align-items: center; justify-content: space-between;">
                                    ${pred.title}
                                    <span style="font-size: 0.75rem; color: var(--accent); font-weight: 600;">
                                        ${pred.confidence}% confidence
                                    </span>
                                </h4>
                                <p style="margin-bottom: var(--space-2); line-height: 1.6;">${pred.description}</p>
                            </div>
                        `).join('')}
                    </div>
                    <div style="background: rgba(245, 158, 11, 0.1); padding: var(--space-4); border-radius: var(--radius-lg); margin: var(--space-4) 0; border: 1px solid var(--accent);">
                        <p style="font-size: 0.875rem; color: var(--text-muted);">
                            <strong>üí° Nota:</strong> Le predizioni sono basate sui tuoi dati storici e algoritmi di machine learning. 
                            Usa questi insights come supporto alle decisioni business.
                        </p>
                    </div>
                    <div class="quick-actions">
                        <button class="btn btn-secondary" onclick="closeModal()">
                            <span>‚úÖ</span> Chiudi
                        </button>
                    </div>
                `;
                openModal(content);
            } catch (error) {
                console.error('Predictions error:', error);
                showMessage('Errore nella generazione predizioni', 'error');
            }
        }
        
        // ===== QUICK ACTIONS =====
        function openQuickSale() {
            addTransaction('revenue');
        }
        
        function openQuickOrder() {
            addOrder();
        }
        
        function openQuickClient() {
            addClient();
        }
        
        function openQuickInventory() {
            addInventoryItem();
        }
        
        function exportBackup() {
            try {
                const backup = {
                    version: appData.version,
                    timestamp: new Date().toISOString(),
                    data: appData,
                    meta: {
                        totalTransactions: appData.transactions.length,
                        totalClients: appData.clients.length,
                        totalInventoryItems: appData.inventory.length,
                        totalOrders: appData.orders.length,
                        exportedBy: 'RetroAvia Spider-System v4.0'
                    }
                };
                
                const dataStr = JSON.stringify(backup, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `retroavia_backup_${formatDate().replace(/-/g, '')}_${Date.now()}.json`;
                link.click();
                
                // Clean up
                setTimeout(() => URL.revokeObjectURL(link.href), 100);
                
                showMessage('üì¶ Backup esportato con successo!');
                console.log('Backup exported successfully');
            } catch (error) {
                console.error('Export error:', error);
                showMessage('Errore nell\'esportazione backup', 'error');
            }
        }
        
        // ===== MODAL FUNCTIONS =====
        function openModal(content) {
            try {
                const modal = document.getElementById('modal');
                const modalContent = document.getElementById('modalContent');
                
                if (modal && modalContent) {
                    if (content) {
                        modalContent.innerHTML = content;
                    }
                    modal.classList.add('active');
                    
                    // Focus management for accessibility
                    const firstInput = modal.querySelector('input, select, textarea, button');
                    if (firstInput) {
                        setTimeout(() => firstInput.focus(), 100);
                    }
                    
                    // Close modal on Escape key
                    document.addEventListener('keydown', handleModalEscape);
                    
                    // Prevent body scroll when modal is open
                    document.body.style.overflow = 'hidden';
                }
            } catch (error) {
                console.error('Modal error:', error);
                showMessage('Errore nell\'apertura modal', 'error');
            }
        }
        
        function closeModal() {
            try {
                const modal = document.getElementById('modal');
                if (modal) {
                    modal.classList.remove('active');
                    
                    // Clean up editing state
                    appData.editingId = null;
                    
                    // Remove escape key listener
                    document.removeEventListener('keydown', handleModalEscape);
                    
                    // Restore body scroll
                    document.body.style.overflow = '';
                }
            } catch (error) {
                console.error('Close modal error:', error);
            }
        }
        
        function handleModalEscape(event) {
            if (event.key === 'Escape') {
                closeModal();
            }
        }

        // ===== FIXED CONFIRMATION DIALOG =====
        function showConfirmDialog(title, message, onConfirm) {
            const dialog = document.getElementById('confirmDialog');
            const titleEl = document.getElementById('confirmTitle');
            const messageEl = document.getElementById('confirmMessage');
            const yesBtn = document.getElementById('confirmYes');
            const noBtn = document.getElementById('confirmNo');

            if (!dialog || !titleEl || !messageEl || !yesBtn || !noBtn) {
                console.error('Confirmation dialog elements not found');
                return;
            }

            titleEl.textContent = title;
            messageEl.textContent = message;
            
            // Remove any existing event listeners by cloning nodes
            const newYesBtn = yesBtn.cloneNode(true);
            const newNoBtn = noBtn.cloneNode(true);
            yesBtn.parentNode.replaceChild(newYesBtn, yesBtn);
            noBtn.parentNode.replaceChild(newNoBtn, noBtn);

            // Add new event listeners
            newYesBtn.addEventListener('click', () => {
                dialog.classList.remove('active');
                if (typeof onConfirm === 'function') {
                    onConfirm();
                }
            });

            newNoBtn.addEventListener('click', () => {
                dialog.classList.remove('active');
            });

            // Show dialog
            dialog.classList.add('active');

            // Focus on the "No" button by default for safety
            setTimeout(() => newNoBtn.focus(), 100);
        }
        
        // ===== DATA MANAGEMENT =====
        function updateClientTotalSpent() {
            // Update client total spent based on transactions
            appData.clients.forEach(client => {
                const clientName = client.client_name || client.name;
                const clientTransactions = appData.transactions.filter(t => 
                    t.type === 'revenue' && t.client === clientName
                );
                const totalSpent = clientTransactions.reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);
                client.total_spent = totalSpent;
                client.totalSpent = totalSpent; // Legacy compatibility
            });
        }
        
        // ===== SEARCH FUNCTIONALITY =====
        function setupSearchListeners() {
            const orderSearch = document.getElementById('orderSearch');
            const transactionSearch = document.getElementById('transactionSearch');
            const clientSearch = document.getElementById('clientSearch');
            const inventorySearch = document.getElementById('inventorySearch');
            
            if (orderSearch) {
                orderSearch.removeEventListener('input', debouncedFilterOrders);
                orderSearch.addEventListener('input', debouncedFilterOrders);
            }
            
            if (transactionSearch) {
                transactionSearch.removeEventListener('input', debouncedFilterTransactions);
                transactionSearch.addEventListener('input', debouncedFilterTransactions);
            }
            
            if (clientSearch) {
                clientSearch.removeEventListener('input', debouncedFilterClients);
                clientSearch.addEventListener('input', debouncedFilterClients);
            }
            
            if (inventorySearch) {
                inventorySearch.removeEventListener('input', debouncedFilterInventory);
                inventorySearch.addEventListener('input', debouncedFilterInventory);
            }
        }
        
        // ===== DATA PERSISTENCE =====
        function saveDataToLocalStorage() {
            try {
                const dataToSave = {
                    ...appData,
                    lastSaved: new Date().toISOString()
                };
                localStorage.setItem('retroaviaData', JSON.stringify(dataToSave));
                console.log('üíæ Dati salvati in localStorage');
            } catch (error) {
                console.error('‚ùå Errore salvataggio localStorage:', error);
                showMessage('Errore nel salvataggio automatico', 'error');
            }
        }
        
        function loadDataFromLocalStorage() {
            try {
                const savedData = localStorage.getItem('retroaviaData');
                if (savedData) {
                    const parsedData = JSON.parse(savedData);
                    // Merge with default data to ensure all properties exist
                    appData = {
                        ...appData,
                        ...parsedData,
                        // Ensure arrays exist
                        orders: parsedData.orders || [],
                        transactions: parsedData.transactions || [],
                        clients: parsedData.clients || [],
                        inventory: parsedData.inventory || []
                    };
                    console.log('üì• Dati caricati da localStorage');
                    if (parsedData.lastSaved) {
                        console.log('üìÖ Ultimo salvataggio:', new Date(parsedData.lastSaved).toLocaleString('it-IT'));
                    }
                    return true;
                }
            } catch (error) {
                console.error('‚ùå Errore caricamento localStorage:', error);
                showMessage('Errore nel caricamento dati salvati', 'error');
            }
            return false;
        }
        
        // ===== INITIALIZATION =====
        async function initializeApp() {
            try {
                console.log('üï∑Ô∏è RetroAvia 4.0 Spider-System Initializing...');
                
                // Initialize Supabase connection
                await initializeSupabase();
                
                // Load saved data from localStorage first (fallback)
                const localDataLoaded = loadDataFromLocalStorage();
                if (localDataLoaded) {
                    console.log('üíæ Dati locali caricati come fallback');
                }
                
                // Try to sync from Supabase if connected
                if (appData.connected) {
                    try {
                        await syncData();
                    } catch (error) {
                        console.error('‚ùå Sync iniziale fallito:', error);
                        showMessage('Sincronizzazione iniziale fallita, utilizzando dati locali', 'error');
                    }
                } else if (!localDataLoaded) {
                    // If no connection and no local data, use demo data
                    console.log('üìã Caricamento dati demo...');
                    appData.orders = [
                        { 
                            id: 'order1', 
                            client_name: 'Mario Rossi',
                            client_email: 'mario.rossi@email.com',
                            status: 'in-progress',
                            created_at: '2025-01-20T10:00:00Z',
                            due_date: '2025-02-15',
                            specs: {
                                modello: 'Game Boy Classic',
                                scocca: 'Trasparente blu con glitter',
                                pulsanti: 'Rossi personalizzati',
                                note: 'Cliente vuole setup gaming retr√≤ completo'
                            },
                            // Legacy compatibility
                            clientName: 'Mario Rossi',
                            clientEmail: 'mario.rossi@email.com',
                            createdDate: '2025-01-20',
                            dueDate: '2025-02-15'
                        }
                    ];
                    
                    appData.transactions = [
                        { id: 'demo1', type: 'revenue', amount: 250, description: 'Vendita Game Boy Color ricondizionato', transaction_date: '2025-01-15', client: 'Mario Rossi', date: '2025-01-15', created_at: '2025-01-15T10:00:00Z' },
                        { id: 'demo2', type: 'expense', amount: 50, description: 'Componenti sostituzione schermo', transaction_date: '2025-01-14', client: '', date: '2025-01-14', created_at: '2025-01-14T10:00:00Z' }
                    ];
                    
                    appData.clients = [
                        { id: 'client1', client_name: 'Mario Rossi', client_email: 'mario.rossi@email.com', client_phone: '333-123-4567', client_source: 'vinted', total_spent: 250, name: 'Mario Rossi', email: 'mario.rossi@email.com', phone: '333-123-4567', source: 'vinted', totalSpent: 250, created_at: '2025-01-15T10:00:00Z' }
                    ];
                    
                    appData.inventory = [
                        { id: 'inv1', item_name: 'Schermo Game Boy Classic', quantity: 5, threshold: 3, price: 25, supplier: 'RetroTech', name: 'Schermo Game Boy Classic', created_at: '2025-01-15T10:00:00Z' }
                    ];
                    
                    // Save demo data to localStorage
                    saveDataToLocalStorage();
                }
                
                // Update client spending
                updateClientTotalSpent();
                
                // Load current page
                showPage(appData.currentPage);
                
                // Initialize dashboard and calendar
                updateDashboard();
                initializeCalendar();
                
                // Setup search listeners after DOM is ready
                setTimeout(() => {
                    setupSearchListeners();
                }, 100);
                
                // Show version info
                console.log(`‚úÖ RetroAvia ${appData.version} Ready!`);
                console.log(`üìä Dati caricati: ${appData.orders.length} ordini, ${appData.transactions.length} transazioni, ${appData.clients.length} clienti, ${appData.inventory.length} componenti`);
                
                if (appData.connected) {
                    showMessage('üï∑Ô∏è RetroAvia 4.0 Connesso a Supabase!');
                } else {
                    showMessage('üï∑Ô∏è RetroAvia 4.0 in modalit√† offline');
                }
                
            } catch (error) {
                console.error('üí• Errore inizializzazione:', error);
                showMessage('Errore nell\'inizializzazione sistema', 'error');
            }
        }
        
        // ===== EVENT LISTENERS =====
        
        // Close modal when clicking outside
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('modal');
            const confirmDialog = document.getElementById('confirmDialog');
            const calendarDayView = document.getElementById('calendarDayView');
            
            if (event.target === modal) {
                closeModal();
            }
            
            if (event.target === confirmDialog) {
                confirmDialog.classList.remove('active');
            }
            
            if (event.target === calendarDayView) {
                closeCalendarDayView();
            }
        });
        
        // ===== KEYBOARD SHORTCUTS =====
        document.addEventListener('keydown', function(event) {
            // Skip if modal or confirm dialog is open or user is typing in an input
            if (document.getElementById('modal').classList.contains('active') || 
                document.getElementById('confirmDialog').classList.contains('active') ||
                document.getElementById('calendarDayView').classList.contains('active') ||
                event.target.tagName === 'INPUT' || 
                event.target.tagName === 'TEXTAREA' || 
                event.target.tagName === 'SELECT') {
                return;
            }
            
            // Handle shortcuts with Ctrl key for safety
            if (event.ctrlKey) {
                switch(event.key.toLowerCase()) {
                    case 's':
                        event.preventDefault();
                        saveDataToLocalStorage();
                        showMessage('üíæ Dati salvati manualmente!');
                        break;
                    case 'b':
                        event.preventDefault();
                        exportBackup();
                        break;
                    case 'r':
                        event.preventDefault();
                        if (appData.connected) {
                            syncData();
                        }
                        break;
                }
                return;
            }
            
            switch(event.key) {
                case '1':
                    showPage('dashboard');
                    break;
                case '2':
                    showPage('orders');
                    break;
                case '3':
                    showPage('transactions');
                    break;
                case '4':
                    showPage('clients');
                    break;
                case '5':
                    showPage('inventory');
                    break;
                case '6':
                    showPage('calendar');
                    break;
                case '7':
                    showPage('analytics');
                    break;
                case 'n':
                case 'N':
                    if (appData.currentPage === 'orders') {
                        event.preventDefault();
                        addOrder();
                    } else if (appData.currentPage === 'transactions') {
                        event.preventDefault();
                        addTransaction('revenue');
                    } else if (appData.currentPage === 'clients') {
                        event.preventDefault();
                        addClient();
                    } else if (appData.currentPage === 'inventory') {
                        event.preventDefault();
                        addInventoryItem();
                    }
                    break;
                case 'a':
                case 'A':
                    if (appData.currentPage === 'dashboard') {
                        event.preventDefault();
                        runAIAnalysis();
                    }
                    break;
            }
        });
        
        // ===== ERROR HANDLING =====
        window.addEventListener('error', function(event) {
            console.error('üí• Errore globale:', event.error);
            showMessage('Si √® verificato un errore inaspettato', 'error');
        });
        
        window.addEventListener('unhandledrejection', function(event) {
            console.error('üí• Promise rejection non gestita:', event.reason);
            showMessage('Errore nella comunicazione', 'error');
        });
        
        // ===== APP LIFECYCLE =====
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });
        
        // Save data before page unload
        window.addEventListener('beforeunload', function() {
            saveDataToLocalStorage();
        });
        
        // Auto-save every 5 minutes
        setInterval(() => {
            if (appData.connected) {
                console.log('üîÑ Auto-sync in corso...');
                syncData().catch(error => {
                    console.warn('‚ùå Auto-sync fallito:', error);
                });
            } else {
                saveDataToLocalStorage();
            }
        }, 5 * 60 * 1000);
        
        // ===== RESPONSIVE HELPERS =====
        function handleResize() {
            const isMobile = window.innerWidth <= 768;
            
            // Adjust modal size on mobile
            const modal = document.getElementById('modal');
            if (modal && isMobile) {
                const modalContent = modal.querySelector('.modal-content');
                if (modalContent) {
                    modalContent.style.width = '95%';
                    modalContent.style.maxHeight = '90vh';
                }
            }
            
            // Refresh calendar on resize
            if (appData.currentPage === 'calendar') {
                setTimeout(renderCalendar, 100);
            }
        }
        
        window.addEventListener('resize', debounce(handleResize, 250));
        
        // ===== FINAL SETUP =====
        console.log('üï∑Ô∏è RetroAvia 4.0 Spider-System Loaded Successfully!');
        console.log('üìã Novit√† Versione 4.0 Fixed:');
        console.log('  ‚úÖ Risolti errori di salvataggio Supabase');
        console.log('  ‚úÖ Corretti problemi CSS backdrop-filter');
        console.log('  ‚úÖ Rimosso dialog di conferma visibile erroneamente');
        console.log('  ‚úÖ Migliorata gestione errori con fallback localStorage');
        console.log('  ‚úÖ Ottimizzata sincronizzazione dati');
        console.log('  ‚úÖ Tutte le funzionalit√† funzionanti');
        console.log('');
        console.log('üìã Keyboard Shortcuts:');
        console.log('  1-7: Navigate pages');
        console.log('  N: New item (context-dependent)');
        console.log('  A: AI Analysis (on dashboard)');
        console.log('  Ctrl+S: Manual save');
        console.log('  Ctrl+B: Export backup');
        console.log('  Ctrl+R: Sync with Supabase');
        console.log('  ESC: Close modal');
        console.log('');
        console.log('üîß Fix Applicati:');
        console.log('  ‚úÖ Errori Supabase 400 risolti con data validation');
        console.log('  ‚úÖ Prefissi webkit aggiunti per Safari compatibility');
        console.log('  ‚úÖ Dialog conferma nascosto correttamente');
        console.log('  ‚úÖ Fallback localStorage sempre attivo');
        console.log('  ‚úÖ Validazione campi migliorata');
    </script>
</body>
</html>
